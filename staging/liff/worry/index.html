<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å¿ƒé…ãªå­ãŒã„ã‚‹</title>
<style>
:root{--rose:#E8475F;--rose-l:#FFF0F1;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s300:#CBD5E1;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}
.header{background:var(--card);padding:16px;border-bottom:2px solid var(--amber);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}
.section{padding:16px;}
.pet-row{display:flex;align-items:center;gap:12px;padding:14px;border-radius:14px;border:1.5px solid var(--s200);cursor:pointer;transition:all .15s;margin-bottom:8px;background:var(--card);}
.pet-row .icon{font-size:24px;}
.pet-row .name{flex:1;font-size:14px;font-weight:700;}
.pet-row .breed{font-size:10px;color:var(--s400);}
.pet-row .status{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;}
.pet-row.ok{border-color:var(--teal);background:var(--teal-l);}
.pet-row.ok .status{background:var(--teal);color:#fff;}
.pet-row.worried{border-color:var(--amber);background:var(--amber-l);}
.pet-row.worried .status{background:var(--amber);color:#fff;}
.symptom-area{display:none;margin-top:16px;}
.symptom-area.show{display:block;}
.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:8px;display:block;}
.symptom-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.symptom-btn{padding:8px 14px;border-radius:10px;border:1.5px solid var(--s200);background:var(--card);font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;}
.symptom-btn.selected{border-color:var(--amber);background:var(--amber-l);color:#92400E;}
.form-input{width:100%;padding:12px 14px;border:1.5px solid var(--s200);border-radius:12px;font-size:14px;background:var(--card);font-family:inherit;margin-bottom:16px;}
.form-input:focus{outline:none;border-color:var(--amber);}
.btn{display:block;width:100%;padding:14px;border-radius:14px;font-size:15px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-warn{background:linear-gradient(135deg,var(--amber),var(--orange));color:#fff;box-shadow:0 4px 16px rgba(255,179,71,.3);}
.btn-ghost{background:transparent;color:var(--s500);font-size:13px;margin-top:8px;}
.btn:disabled{opacity:.5;}
.done{text-align:center;padding:40px 16px;display:none;}
.done .icon{font-size:64px;}
.done h2{font-size:20px;font-weight:900;margin-top:12px;}
.done p{font-size:13px;color:var(--s500);margin-top:6px;line-height:1.6;}
.info{padding:12px;border-radius:12px;font-size:12px;text-align:center;margin-top:12px;}
.info.amber{background:var(--amber-l);color:#92400E;border:1px solid var(--amber);}
.info.teal{background:var(--teal-l);color:var(--teal-d);border:1px solid var(--teal);}
.loading{display:none;text-align:center;padding:40px;}
.loading.show{display:block;}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}

/* çµæœã‚«ãƒ¼ãƒ‰ */
.result-card{background:var(--card);border-radius:16px;padding:24px 20px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,.05);}
.result-card .big-icon{font-size:48px;margin-bottom:8px;}
.result-card .title{font-size:18px;font-weight:800;margin-bottom:4px;}
.result-card .sub{font-size:13px;color:var(--s500);line-height:1.6;}
.result-card.genki{border:2px solid var(--teal);}
.result-card.worry{border:2px solid var(--amber);}
.worry-detail{margin-top:12px;padding:12px;background:var(--amber-l);border-radius:12px;text-align:left;}
.worry-detail .label{font-size:11px;font-weight:700;color:var(--orange);margin-bottom:3px;}
.worry-detail .val{font-size:13px;color:var(--ink);}

/* ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚«ãƒ¼ãƒ‰ */
.reminder-card{background:var(--amber-l);border:2px solid var(--amber);border-radius:16px;padding:28px 20px;text-align:center;}
.reminder-card .big-icon{font-size:48px;margin-bottom:12px;}
.reminder-card .title{font-size:16px;font-weight:800;color:var(--orange);margin-bottom:10px;line-height:1.5;white-space:pre-line;}
.reminder-card .desc{font-size:13px;color:var(--s500);line-height:1.7;}
.reminder-card .sent-badge{display:inline-block;margin-top:14px;padding:6px 18px;border-radius:20px;background:var(--amber);color:#fff;font-size:12px;font-weight:700;}
@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.08);}}
.pulse{animation:pulse 2s infinite;}
@keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
.sk{border-radius:10px;background:linear-gradient(90deg,var(--s100) 25%,var(--s200) 50%,var(--s100) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;}
.sk-line{height:14px;margin-bottom:10px;}
.sk-pet{height:56px;border-radius:14px;margin-bottom:8px;}
</style>
</head>
<body>

<!-- â•â•â• ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° â•â•â• -->
<div id="initLoading" style="padding:20px;">
  <div style="text-align:center;padding:20px 0 16px;"><div class="sk" style="width:200px;height:20px;margin:0 auto;border-radius:10px;"></div></div>
  <div class="sk sk-pet"></div>
  <div class="sk sk-pet"></div>
  <div class="sk sk-line" style="width:60%;margin-top:16px;"></div>
</div>

<!-- â•â•â• ã‚ªãƒ¼ãƒŠãƒ¼: ãƒã‚§ãƒƒã‚¯ç”»é¢ â•â•â• -->
<div id="main" style="display:none;">
  <div class="header">
    <h1>âš ï¸ å¿ƒé…ãªå­ã‚’é¸ã‚“ã§ãã ã•ã„</h1>
    <p>è©²å½“ã™ã‚‹å­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œå¿ƒé…âš ï¸ã€ã«åˆ‡ã‚Šæ›¿ãˆ</p>
  </div>
  <div class="section">
    <div id="petList"></div>
    <div id="symptomArea" class="symptom-area">
      <label class="form-label">å¿ƒé…ãªç—‡çŠ¶ï¼ˆä»»æ„ï¼‰</label>
      <div class="symptom-grid">
        <div class="symptom-btn" onclick="toggleSymptom(this)">é£Ÿæ¬²ãªã—</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å…ƒæ°—ãªã—</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ä¸‹ç—¢</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å˜”å</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å’³</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ãã—ã‚ƒã¿</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">è¶³ã‚’å¼•ããšã‚‹</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ãã®ä»–</div>
      </div>
      <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <input class="form-input" id="memo" placeholder="ä¾‹ï¼šæœã‹ã‚‰ã”é£¯ã‚’é£Ÿã¹ãªã„">
    </div>
  </div>
  <div class="section" style="padding-top:0;">
    <button class="btn btn-warn" id="submitBtn" onclick="submitWorry()" disabled>âš ï¸ ãƒã‚§ãƒƒã‚¯å®Œäº†</button>
    <button class="btn btn-ghost" onclick="closeLiff()">â† ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- â•â•â• ãƒ¡ãƒ³ãƒãƒ¼: ãƒã‚§ãƒƒã‚¯æ¸ˆã¿çµæœ â•â•â• -->
<div id="viewResult" style="display:none;">
  <div class="header" id="resultHeader">
    <h1>ğŸ¾ ä»Šæ—¥ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯</h1>
    <p id="resultSub"></p>
  </div>
  <div class="section"><div id="resultCard"></div></div>
  <div class="section" style="padding-top:0;">
    <button class="btn btn-ghost" onclick="closeLiff()">â† é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- â•â•â• ãƒ¡ãƒ³ãƒãƒ¼: æœªãƒã‚§ãƒƒã‚¯ â†’ ãƒªãƒã‚¤ãƒ³ãƒ‰ â•â•â• -->
<div id="viewReminder" style="display:none;">
  <div class="header">
    <h1>ğŸ¾ å…ƒæ°—ãƒã‚§ãƒƒã‚¯</h1>
    <p id="reminderSub"></p>
  </div>
  <div class="section">
    <div class="reminder-card">
      <div class="big-icon pulse">ğŸ“£</div>
      <div class="title" id="reminderTitle">é€šçŸ¥ä¸­...</div>
      <div class="desc" id="reminderDesc"></div>
      <div class="sent-badge" id="reminderBadge" style="display:none;">âœ… ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡æ¸ˆã¿</div>
    </div>
    <div class="info amber" style="margin-top:16px;">
      ğŸ’¡ é£¼ã„ä¸»ã•ã‚“ãŒå…ƒæ°—ãƒã‚§ãƒƒã‚¯ã‚’ã™ã‚‹ã¨<br>ã‚ãªãŸã«ã‚‚çµæœãŒå±Šãã¾ã™
    </div>
  </div>
  <div class="section" style="padding-top:0;">
    <button class="btn btn-ghost" onclick="closeLiff()">â† é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- â•â•â• é€ä¿¡ä¸­ â•â•â• -->
<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">â³</div>
  <div>è¨˜éŒ²ä¸­...</div>
</div>

<!-- â•â•â• å®Œäº†ç”»é¢ â•â•â• -->
<div id="done" class="done">
  <div class="icon">âš ï¸</div>
  <h2>ãƒã‚§ãƒƒã‚¯å®Œäº†</h2>
  <p id="doneMsg"></p>
  <div class="info amber">ãŠå¤§äº‹ã«ã—ã¦ãã ã•ã„ ğŸ’›<br><span style="font-size:11px;">ç—‡çŠ¶ãŒç¶šãå ´åˆã¯ç£åŒ»ã•ã‚“ã¸ã”ç›¸è«‡ã‚’</span></div>
  <button class="btn btn-ghost" style="margin-top:16px;" onclick="closeLiff()">é–‰ã˜ã‚‹</button>
</div>

<div class="footer">PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.4.5 Beta<br>Â© 2026 PawBon Inc.</div>

<script src="../config.js?v=2"></script>
<script>
var API_BASE = PAWBON_CONFIG.API_BASE;
var CACHE_ID_KEY = 'pawbon_line_id';
var lineId = '';
var familyCode = '';
var family = null;
var role = '';
var petNames = [];
var petBreeds = [];
var worriedPets = {};

function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â•â•â• é«˜é€ŸåˆæœŸåŒ– / Fast init: cached lineId + parallel API + async SDK â•â•â•
(function() {
  var cachedLineId = '';
  try { cachedLineId = localStorage.getItem(CACHE_ID_KEY) || ''; } catch(e) {}

  var apiPromise = null;
  if (cachedLineId) {
    apiPromise = fetchUserData(cachedLineId);
  }

  var script = document.createElement('script');
  script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
  script.onload = function() { initLiff(cachedLineId, apiPromise); };
  script.onerror = function() {
    lineId = cachedLineId || 'debug_user_' + Date.now();
    if (!apiPromise) apiPromise = fetchUserData(lineId);
    apiPromise.then(applyUserData);
  };
  document.head.appendChild(script);
})();

async function initLiff(cachedLineId, earlyApiPromise) {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.worry });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
    try { localStorage.setItem(CACHE_ID_KEY, lineId); } catch(e) {}
  } catch (e) {
    lineId = cachedLineId || 'debug_user_' + Date.now();
  }

  if (earlyApiPromise && lineId === cachedLineId) {
    earlyApiPromise.then(applyUserData);
  } else {
    fetchUserData(lineId).then(applyUserData);
  }
}

function fetchUserData(id) {
  return fetch(API_BASE + '/api-user-data?lineId=' + encodeURIComponent(id))
    .then(function(r) { return r.json(); });
}

function applyUserData(json) {
  try {
    var data = json.data || {};
    if (!data.registered && !data.familyCode) {
      document.getElementById('initLoading').innerHTML =
        '<div style="text-align:center;padding:40px 20px;"><div style="font-size:40px;margin-bottom:12px;">ğŸ“</div><div>æœªç™»éŒ²ã§ã™ã€‚å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’ã—ã¦ãã ã•ã„ã€‚</div></div>';
      return;
    }

    role = data.role;
    familyCode = data.familyCode;
    petNames = (data.petNames || '').split(',').map(function(s){ return s.trim(); }).filter(Boolean);
    petBreeds = (data.breeds || '').split(',').map(function(s){ return s.trim(); });

    // family ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ï¼ˆowner_line_id ã‚’ familyMembers ã‹ã‚‰å–å¾—ï¼‰
    var ownerLineId = '';
    if (data.familyMembers) {
      data.familyMembers.forEach(function(m) {
        if (m.relation === 'ã‚ªãƒ¼ãƒŠãƒ¼') ownerLineId = m.member_line_id;
      });
    }
    family = {
      family_code: data.familyCode,
      pet_names: data.petNames,
      breeds: data.breeds,
      owner_line_id: ownerLineId,
      owner_name: ''
    };

    if (role === 'owner') {
      handleOwnerFlow(data.checkedInToday);
    } else {
      handleMemberFlow(data.checkedInToday);
    }
  } catch (e) {
    document.getElementById('initLoading').innerHTML =
      '<div style="text-align:center;padding:40px 20px;"><div style="font-size:40px;margin-bottom:12px;">âŒ</div><div>ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div></div>';
  }
}

// â•â•â• ã‚ªãƒ¼ãƒŠãƒ¼ â•â•â•
async function handleOwnerFlow(checkedInToday) {
  document.getElementById('initLoading').style.display = 'none';

  if (checkedInToday) {
    // æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿
    document.getElementById('main').style.display = 'block';
    document.getElementById('petList').innerHTML =
      '<div style="text-align:center;padding:20px;">âœ… ä»Šæ—¥ã¯ã‚‚ã†ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã§ã™ï¼</div>';
    document.getElementById('submitBtn').style.display = 'none';
  } else {
    // æœªãƒã‚§ãƒƒã‚¯ â†’ é€šå¸¸ã®ãƒã‚§ãƒƒã‚¯ç”»é¢
    document.getElementById('main').style.display = 'block';
    renderPetList();
  }
}

// â•â•â• ãƒ¡ãƒ³ãƒãƒ¼ â•â•â•
async function handleMemberFlow(checkedInToday) {
  document.getElementById('initLoading').style.display = 'none';

  if (checkedInToday) {
    // ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ â†’ çµæœã¯ç›´æ¥è¡¨ç¤ºã§ããªã„ã®ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    document.getElementById('viewResult').style.display = 'block';
    document.getElementById('resultSub').textContent = petNames.join('ã€');
    document.getElementById('resultCard').innerHTML =
      '<div class="result-card genki">' +
        '<div class="big-icon">âœ…</div>' +
        '<div class="title">ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯æ¸ˆã¿</div>' +
        '<div class="sub">ğŸ¾ ' + escapeHtml(petNames.join('ã€')) + '<br>ä»Šæ—¥ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯ã¯è¨˜éŒ²æ¸ˆã¿ã§ã™</div>' +
      '</div>';
  } else {
    showMemberReminder();
  }
}

// â•â•â• çµæœè¡¨ç¤º â•â•â•
function showTodayResult(checkin) {
  document.getElementById('viewResult').style.display = 'block';
  document.getElementById('resultSub').textContent = petNames.join('ã€');

  var isGenki = checkin.status === 'genki';
  var html = '';

  if (isGenki) {
    html = '<div class="result-card genki">' +
      '<div class="big-icon">ğŸ‰</div>' +
      '<div class="title">ã¿ã‚“ãªå…ƒæ°—ï¼</div>' +
      '<div class="sub">ğŸ¾ ' + escapeHtml(petNames.join('ã€')) + '<br>ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ âœ…</div>' +
    '</div>' +
    '<div class="info teal" style="margin-top:12px;">ğŸ’Œ é£¼ã„ä¸»ã•ã‚“ãŒä»Šæ—¥ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ</div>';
  } else {
    html = '<div class="result-card worry">' +
      '<div class="big-icon">âš ï¸</div>' +
      '<div class="title">å¿ƒé…ãªå­ãŒã„ã¾ã™</div>' +
      '<div class="sub">ğŸ¾ ' + escapeHtml(petNames.join('ã€')) + '</div>';
    if (checkin.worried_pets) html += '<div class="worry-detail"><div class="label">å¿ƒé…ãªå­</div><div class="val">' + escapeHtml(checkin.worried_pets) + '</div></div>';
    if (checkin.symptoms) html += '<div class="worry-detail" style="margin-top:8px;"><div class="label">ç—‡çŠ¶</div><div class="val">' + escapeHtml(checkin.symptoms) + '</div></div>';
    if (checkin.memo) html += '<div class="worry-detail" style="margin-top:8px;"><div class="label">ãƒ¡ãƒ¢</div><div class="val">' + escapeHtml(checkin.memo) + '</div></div>';
    html += '</div>';
    html += '<div class="info amber" style="margin-top:12px;">ğŸ’Œ é£¼ã„ä¸»ã•ã‚“ãŒä»Šæ—¥ã®çŠ¶æ³ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ<br><span style="font-size:11px;">ç—‡çŠ¶ãŒç¶šãå ´åˆã¯ç£åŒ»ã•ã‚“ã¸ã”ç›¸è«‡ã‚’</span></div>';
  }

  document.getElementById('resultCard').innerHTML = html;
}

// â•â•â• ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡ï¼ˆ1æ—¥1å›ã®ã¿ã€é‡è¤‡é˜²æ­¢ï¼‰ â•â•â•
function getWorryReminderKey() {
  var today = new Date().toISOString().slice(0, 10);
  return 'pawbon_worry_reminded_' + familyCode + '_' + today;
}

function showMemberReminder() {
  document.getElementById('viewReminder').style.display = 'block';
  var ownerName = family.owner_name || 'é£¼ã„ä¸»ã•ã‚“';
  document.getElementById('reminderSub').textContent = petNames.join('ã€');

  // ä»Šæ—¥æ—¢ã«é€ä¿¡æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
  var alreadySent = false;
  try { alreadySent = localStorage.getItem(getWorryReminderKey()) === '1'; } catch(e) {}

  if (alreadySent) {
    // 2å›ç›®ä»¥é™: é€ä¿¡æ¸ˆã¿è¡¨ç¤ºã®ã¿ï¼ˆå†é€ã—ãªã„ï¼‰
    document.getElementById('reminderTitle').textContent =
      'ğŸ“¨ ' + ownerName + ' ã«\nãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡æ¸ˆã¿ã§ã™';
    document.getElementById('reminderDesc').innerHTML =
      'ğŸ¾ <strong>' + escapeHtml(petNames.join('ã€')) + '</strong> ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯ã‚’<br>' +
      escapeHtml(ownerName) + ' ã«ãŠé¡˜ã„æ¸ˆã¿ã§ã™ã€‚<br><br>ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã™ã‚‹ã¨<br>ã‚ãªãŸã«ã‚‚çµæœãŒå±Šãã¾ã™ ğŸ’Œ';
    document.getElementById('reminderBadge').style.display = 'inline-block';
  } else {
    // åˆå›: ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è‡ªå‹•é€ä¿¡
    document.getElementById('reminderTitle').textContent =
      'ã¾ã‚‚ãªã ' + ownerName + ' ã«\nãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ã‚Šã¾ã™...';
    document.getElementById('reminderDesc').innerHTML =
      'ğŸ¾ <strong>' + escapeHtml(petNames.join('ã€')) + '</strong> ã®<br>ä»Šæ—¥ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯ã¯ã¾ã ã§ã™ã€‚';
    sendReminder(ownerName);
  }
}

async function sendReminder(ownerName) {
  try {
    await fetch(API_BASE + '/api-reminder', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        familyCode: familyCode,
        ownerLineId: family.owner_line_id,
        senderLineId: lineId,
        petNames: petNames.join('ã€')
      })
    });

    // é€ä¿¡æˆåŠŸ â†’ localStorage ã«è¨˜éŒ²ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    try { localStorage.setItem(getWorryReminderKey(), '1'); } catch(e) {}

    document.getElementById('reminderTitle').textContent =
      'ğŸ“¨ ' + ownerName + ' ã«\nãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ã‚Šã¾ã—ãŸï¼';
    document.getElementById('reminderDesc').innerHTML =
      'ğŸ¾ <strong>' + escapeHtml(petNames.join('ã€')) + '</strong> ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯ã‚’<br>' +
      escapeHtml(ownerName) + ' ã«ãŠé¡˜ã„ã—ã¾ã—ãŸã€‚<br><br>ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã™ã‚‹ã¨<br>ã‚ãªãŸã«ã‚‚çµæœãŒå±Šãã¾ã™ ğŸ’Œ';
    document.getElementById('reminderBadge').style.display = 'inline-block';
  } catch(e) {
    document.getElementById('reminderTitle').textContent = 'âš ï¸ é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸ';
    document.getElementById('reminderDesc').textContent = 'ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
  }
}

// â•â•â• ãƒšãƒƒãƒˆãƒªã‚¹ãƒˆ â•â•â•
function renderPetList() {
  var breedData = {
    dog: ['æŸ´çŠ¬','ãƒˆã‚¤ãƒ—ãƒ¼ãƒ‰ãƒ«','ãƒãƒ¯ãƒ¯','ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ¬ãƒˆãƒªãƒãƒ¼','ãƒ•ãƒ¬ãƒ³ãƒãƒ–ãƒ«ãƒ‰ãƒƒã‚°','ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒ€ãƒƒã‚¯ã‚¹','ãƒãƒ¡ãƒ©ãƒ‹ã‚¢ãƒ³','ã‚³ãƒ¼ã‚®ãƒ¼','MIX'],
    cat: ['ã‚¹ã‚³ãƒ†ã‚£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ãƒãƒ³ãƒã‚«ãƒ³','ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚·ãƒ§ãƒ¼ãƒˆãƒ˜ã‚¢','ãƒ©ã‚°ãƒ‰ãƒ¼ãƒ«']
  };
  document.getElementById('petList').innerHTML = petNames.map(function(name, idx) {
    var breed = petBreeds[idx] || '';
    var icon = 'ğŸ¾';
    if (breedData.dog.some(function(b){ return breed.indexOf(b) >= 0; })) icon = 'ğŸ•';
    else if (breedData.cat.some(function(b){ return breed.indexOf(b) >= 0; })) icon = 'ğŸˆ';
    else if (breed.match(/çŠ¬|ãƒ‰ãƒƒã‚°|ãƒ†ãƒªã‚¢|ãƒ–ãƒ«|ãƒ¬ãƒˆãƒªãƒãƒ¼|ã‚·ã‚§ãƒ‘ãƒ¼ãƒ‰|ãƒ—ãƒ¼ãƒ‰ãƒ«|ãƒã‚¹ã‚­ãƒ¼|ã‚³ãƒ¼ã‚®ãƒ¼|æŸ´|ç§‹ç”°|MIX/)) icon = 'ğŸ•';
    else if (breed.match(/çŒ«|ã‚­ãƒ£ãƒƒãƒˆ|ãƒšãƒ«ã‚·ãƒ£|ã‚·ãƒ£ãƒ |ãƒ™ãƒ³ã‚¬ãƒ«/)) icon = 'ğŸˆ';
    return '<div class="pet-row ok" id="pet-' + idx + '" onclick="togglePet(' + idx + ',\'' + escapeHtml(name) + '\')">' +
      '<div class="icon">' + icon + '</div>' +
      '<div class="name">' + escapeHtml(name) + '<div class="breed">' + escapeHtml(breed) + '</div></div>' +
      '<div class="status">å…ƒæ°— âœ…</div></div>';
  }).join('');
}

function togglePet(idx, name) {
  var el = document.getElementById('pet-' + idx);
  if (el.classList.contains('ok')) {
    el.classList.remove('ok'); el.classList.add('worried');
    el.querySelector('.status').textContent = 'å¿ƒé… âš ï¸';
    worriedPets[name] = true;
  } else {
    el.classList.remove('worried'); el.classList.add('ok');
    el.querySelector('.status').textContent = 'å…ƒæ°— âœ…';
    delete worriedPets[name];
  }
  var hasWorry = Object.keys(worriedPets).length > 0;
  document.getElementById('symptomArea').className = 'symptom-area' + (hasWorry ? ' show' : '');
  document.getElementById('submitBtn').disabled = !hasWorry;
}
function toggleSymptom(el) { el.classList.toggle('selected'); }

// â•â•â• Submit â•â•â•
async function submitWorry() {
  var wNames = Object.keys(worriedPets);
  if (wNames.length === 0) return;
  document.getElementById('main').style.display = 'none';
  document.getElementById('loading').classList.add('show');

  var symptoms = [];
  document.querySelectorAll('.symptom-btn.selected').forEach(function(el) { symptoms.push(el.textContent); });
  var memo = document.getElementById('memo').value.trim();

  try {
    var res = await fetch(API_BASE + '/api-worry', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        lineId: lineId,
        worriedPets: wNames.join(', '), symptoms: symptoms.join(', '), memo: memo
      })
    });
    var result = await res.json();
    document.getElementById('loading').classList.remove('show');

    var errMsg = result.error ? result.error.message : '';
    document.getElementById('doneMsg').textContent = result.success
      ? 'âš ï¸ ' + wNames.join('ãƒ»') + 'ã®å¿ƒé…ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚\nå®¶æ—ã«ã‚‚çŠ¶æ³ã‚’ä¼ãˆã¾ã—ãŸã€‚'
      : 'âš ï¸ ' + wNames.join('ãƒ»') + 'ã®å¿ƒé…ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\n' + (errMsg || 'åæ˜ ã«å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚');
    document.getElementById('done').style.display = 'block';
  } catch(e) {
    document.getElementById('loading').classList.remove('show');
    document.getElementById('doneMsg').textContent = 'é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message;
    document.getElementById('done').style.display = 'block';
  }
}

function closeLiff() { try { liff.closeWindow(); } catch(e) { window.close(); } }
</script>
</body>
</html>
