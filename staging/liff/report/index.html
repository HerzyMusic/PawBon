<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å…ƒæ°—ãƒ¬ãƒãƒ¼ãƒˆ</title>
<style>
:root{--rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:20px;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}
.section{padding:16px;}
.stat-row{display:flex;gap:8px;margin-bottom:16px;}
.stat-box{flex:1;background:var(--s100);border-radius:14px;padding:14px 8px;text-align:center;}
.stat-box .sv{font-size:24px;font-weight:900;}
.stat-box .sv.rose{color:var(--rose);}
.stat-box .sv.teal{color:var(--teal-d);}
.stat-box .sv.amber{color:var(--amber);}
.stat-box .sl{font-size:9px;color:var(--s400);margin-top:2px;}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.cal-month{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.cal-month h3{font-size:15px;font-weight:800;}
.cal-month .nav{width:30px;height:30px;border-radius:50%;background:var(--s100);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;border:none;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center;}
.cal-day-label{font-size:9px;font-weight:700;color:var(--s400);padding:4px 0;}
.cal-day{aspect-ratio:1;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--s500);}
.cal-day.genki{background:#DCFCE7;color:var(--teal-d);}
.cal-day.worry{background:#FEF3C7;color:#92400E;}
.cal-day.today{box-shadow:0 0 0 2px var(--rose);}
.cal-legend{display:flex;gap:16px;margin-top:10px;font-size:10px;color:var(--s400);justify-content:center;}
.cal-legend span::before{content:'';display:inline-block;width:10px;height:10px;border-radius:3px;vertical-align:middle;margin-right:4px;}
.cal-legend .g::before{background:#DCFCE7;}
.cal-legend .y::before{background:#FEF3C7;}
.section-title{font-size:13px;font-weight:800;color:var(--s500);margin-bottom:10px;}
.record-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--s100);font-size:13px;}
.record-row:last-child{border:none;}
.record-row .date{color:var(--s500);}
.record-row .status-g{color:var(--teal-d);font-weight:700;}
.record-row .status-w{color:#92400E;font-weight:700;}
.region{display:flex;align-items:center;gap:10px;background:var(--teal-l);border-radius:14px;padding:12px 14px;margin-bottom:16px;}
.region .num{font-size:24px;font-weight:900;color:var(--teal-d);}
.region .txt{font-size:11px;color:var(--s500);line-height:1.4;}
.loading{text-align:center;padding:60px 20px;color:var(--s400);}
.pet-summary{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;}
.pet-tag{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:700;background:var(--teal-l);color:var(--teal-d);}
.empty-state{text-align:center;padding:30px 16px;color:var(--s400);}
.empty-state .icon{font-size:48px;margin-bottom:12px;}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}
.pet-card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);border-left:4px solid var(--teal);}
.pet-card.has-worry{border-left-color:var(--amber);}
.pet-card-header{font-size:16px;font-weight:800;margin-bottom:12px;}
.pet-card-stats{display:flex;gap:8px;margin-bottom:12px;}
.pet-stat{flex:1;background:var(--s100);border-radius:10px;padding:10px 6px;text-align:center;}
.pet-stat-val{font-size:20px;font-weight:900;}
.pet-stat-label{font-size:9px;color:var(--s400);margin-top:2px;}
.pet-card-detail{font-size:12px;color:var(--s500);line-height:1.8;}
.pet-card-allclear{font-size:14px;color:var(--teal-d);font-weight:700;text-align:center;padding:8px 0;}
.symptom-tag{display:inline-block;padding:2px 8px;border-radius:10px;background:var(--amber-l);color:#92400E;font-size:11px;margin:0 2px;}
.family-summary-card{font-size:14px;line-height:1.8;font-weight:700;}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ“Š å…ƒæ°—ãƒ¬ãƒãƒ¼ãƒˆ</h1>
  <p id="headerSub">èª­ã¿è¾¼ã¿ä¸­...</p>
</div>

<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">ğŸ“Š</div>
  <div>èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="content" style="display:none;">
  <!-- ãƒšãƒƒãƒˆæƒ…å ± -->
  <div class="section">
    <div id="petTags" class="pet-summary"></div>

    <!-- Stats -->
    <div class="stat-row">
      <div class="stat-box"><div class="sv rose" id="totalDays">0</div><div class="sl">ãƒˆãƒ¼ã‚¿ãƒ«æ—¥æ•°</div></div>
      <div class="stat-box"><div class="sv teal" id="streak">0</div><div class="sl">é€£ç¶šæ—¥æ•° ğŸ”¥</div></div>
      <div class="stat-box"><div class="sv amber" id="healthRate">-</div><div class="sl">å…ƒæ°—ç‡</div></div>
    </div>

    <div class="region">
      <div class="num" id="regionCount">-</div>
      <div class="txt">åŒ¹ãŒ<span id="regionArea">åœ°åŸŸ</span>ã§<br>ä»Šæ—¥å…ƒæ°—ã§ã™ ğŸ˜ï¸</div>
    </div>
  </div>

  <!-- Calendar -->
  <div class="section" style="padding-top:0;">
    <div class="card">
      <div class="cal-month">
        <button class="nav" onclick="changeMonth(-1)">â€¹</button>
        <h3 id="calTitle">ğŸ“… 2026å¹´2æœˆ</h3>
        <button class="nav" onclick="changeMonth(1)">â€º</button>
      </div>
      <div class="cal-days" id="calGrid"></div>
      <div class="cal-legend">
        <span class="g">å…ƒæ°—</span>
        <span class="y">å¿ƒé…</span>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ“‹ æœ€è¿‘ã®ãƒã‚§ãƒƒã‚¯å±¥æ­´</div>
    <div class="card" id="historyList" style="padding:0 16px;"></div>
  </div>
</div>

<div id="petsContent" style="display:none;">
  <div class="section" id="petsView"></div>
</div>

<div class="footer">PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.4.3 Beta<br>Â© 2026 PawBon Inc.</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
var API_BASE = PAWBON_CONFIG.API_BASE;
var lineId = '';
var familyCode = '';
var allRecords = [];
var currentYear, currentMonth;
var urlParams = new URLSearchParams(window.location.search);
var viewMode = urlParams.get('view');

// â•â•â• LIFF â•â•â•
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.report });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) {
    lineId = 'debug_user_' + Date.now();
  }
  loadReport();
}
initLiff();

// â•â•â• Helper: ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ—¥ä»˜ã‚’å–å¾— â•â•â•
function getDate(r) {
  return r.date || r.checkin_date || r.check_date || '';
}

// â•â•â• Loadï¼ˆEdge Function çµŒç”±ï¼‰ â•â•â•
async function loadReport() {
  try {
    var res = await fetch(API_BASE + '/api-report?lineId=' + encodeURIComponent(lineId));
    var json = await res.json();

    if (!json.success) {
      document.getElementById('loading').innerHTML =
        '<div style="font-size:40px;margin-bottom:12px;">ğŸ“</div><div>æœªç™»éŒ²ã§ã™ã€‚å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</div>';
      return;
    }

    var data = json.data || {};
    familyCode = data.familyCode;
    allRecords = data.records || [];

    // æ—¥ä»˜é™é †ã‚½ãƒ¼ãƒˆ
    allRecords.sort(function(a, b) {
      return getDate(b).localeCompare(getDate(a));
    });

    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    var petNames = (data.petNames || '').split(',').map(function(s){ return s.trim(); }).filter(Boolean);
    var petBreeds = (data.breeds || '').split(',').map(function(s){ return s.trim(); });

    var now = new Date();
    currentYear = now.getFullYear();
    currentMonth = now.getMonth() + 1;

    document.getElementById('loading').style.display = 'none';

    if (viewMode === 'pets') {
      document.querySelector('.header h1').textContent = 'ğŸ¾ å®¶æ—ã®æ§˜å­';
      document.getElementById('headerSub').textContent = petNames.join('ã€') + ' ã®å…ƒæ°—çŠ¶æ³';
      document.getElementById('petsContent').style.display = 'block';
      renderPetsView(petNames, petBreeds, data);
    } else {
      document.getElementById('headerSub').textContent = petNames.join('ã€') + ' ã®å…ƒæ°—ãƒ¬ãƒãƒ¼ãƒˆ';

      // ãƒšãƒƒãƒˆã‚¿ã‚°
      document.getElementById('petTags').innerHTML = petNames.map(function(name, i) {
        var breed = petBreeds[i] || '';
        return '<span class="pet-tag">ğŸ¾ ' + escapeHtml(name) + (breed ? ' (' + escapeHtml(breed) + ')' : '') + '</span>';
      }).join('');

      document.getElementById('totalDays').textContent = data.totalDays || 0;
      document.getElementById('streak').textContent = data.streak || 0;
      document.getElementById('healthRate').textContent = (data.healthRate || 0) + '%';
      document.getElementById('regionCount').textContent = data.regionCount || 'â€”';
      document.getElementById('regionArea').textContent = (data.area || '') + ' ' + (data.areaDetail || '');

      document.getElementById('content').style.display = 'block';
      renderCalendar();
      renderHistory();
    }

  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<div style="font-size:40px;margin-bottom:12px;">âŒ</div><div>ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
  }
}

// â•â•â• Calendar â•â•â•
function renderCalendar() {
  document.getElementById('calTitle').textContent = 'ğŸ“… ' + currentYear + 'å¹´' + currentMonth + 'æœˆ';

  var firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
  var offset = firstDay === 0 ? 6 : firstDay - 1; // æœˆæ›œå§‹ã¾ã‚Š
  var daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
  var now = new Date();
  var todayD = now.getDate();
  var todayM = now.getMonth() + 1;
  var todayY = now.getFullYear();

  // è¨˜éŒ²ã‚’dateã§ãƒãƒƒãƒ”ãƒ³ã‚°
  var dateMap = {};
  allRecords.forEach(function(r) {
    dateMap[getDate(r)] = r.status;
  });

  var html = '';
  var labels = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
  labels.forEach(function(l) {
    html += '<div class="cal-day-label">' + l + '</div>';
  });

  for (var i = 0; i < offset; i++) html += '<div class="cal-day"></div>';

  for (var d = 1; d <= daysInMonth; d++) {
    var ds = currentYear + '-' + String(currentMonth).padStart(2,'0') + '-' + String(d).padStart(2,'0');
    var status = dateMap[ds];
    var cls = 'cal-day';
    if (status === 'genki') cls += ' genki';
    else if (status === 'worry') cls += ' worry';
    if (d === todayD && currentMonth === todayM && currentYear === todayY) cls += ' today';
    html += '<div class="' + cls + '">' + d + '</div>';
  }

  document.getElementById('calGrid').innerHTML = html;
}

function changeMonth(dir) {
  currentMonth += dir;
  if (currentMonth > 12) { currentMonth = 1; currentYear++; }
  if (currentMonth < 1) { currentMonth = 12; currentYear--; }
  renderCalendar();
}

// â•â•â• History â•â•â•
function renderHistory() {
  var container = document.getElementById('historyList');
  if (!allRecords || allRecords.length === 0) {
    container.innerHTML = '<div style="padding:16px 0;text-align:center;color:var(--s400);font-size:12px;">ã¾ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  var weekdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  container.innerHTML = allRecords.slice(0, 14).map(function(r) {
    var dateStr = getDate(r);
    var d = new Date(dateStr);
    var label = isNaN(d.getTime()) ? dateStr : ((d.getMonth()+1) + '/' + d.getDate() + 'ï¼ˆ' + weekdays[d.getDay()] + 'ï¼‰');
    if (r.status === 'genki') {
      return '<div class="record-row"><span class="date">' + label + '</span><span class="status-g">âœ… å…¨å“¡å…ƒæ°—</span></div>';
    } else {
      var detail = escapeHtml(r.worriedPets || r.worried_pets || 'å¿ƒé…');
      if (r.symptoms) detail += 'ï¼ˆ' + escapeHtml(r.symptoms) + 'ï¼‰';
      return '<div class="record-row"><span class="date">' + label + '</span><span class="status-w">âš ï¸ ' + detail + '</span></div>';
    }
  }).join('');
}

// â•â•â• Pets Viewï¼ˆãƒšãƒƒãƒˆåˆ¥åˆ†æ / å® ç‰©åˆ†æè§†å›¾ï¼‰â•â•â•
function renderPetsView(petNames, petBreeds, data) {
  var now = new Date();
  var thirtyDaysAgo = new Date(now);
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  var thirtyDaysAgoStr = thirtyDaysAgo.toISOString().slice(0, 10);

  var recentRecords = allRecords.filter(function(r) {
    return getDate(r) >= thirtyDaysAgoStr;
  });
  var totalRecent = recentRecords.length;

  var html = '';

  petNames.forEach(function(name, i) {
    var breed = petBreeds[i] || '';

    // å¿ƒé…ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆéå»30æ—¥ï¼‰/ æœ€è¿‘30å¤©çš„æ‹…å¿ƒè®°å½•
    var worryRecords = recentRecords.filter(function(r) {
      return r.status === 'worry' && (r.worriedPets || r.worried_pets || '').indexOf(name) >= 0;
    });
    var worryCount = worryRecords.length;
    var healthRate = totalRecent > 0 ? Math.round((totalRecent - worryCount) / totalRecent * 100) : 100;

    // å…ƒæ°—é€£ç¶šæ—¥æ•°ï¼ˆæœ€æ–°æ—¥ã‹ã‚‰é¡ã‚‹ï¼‰/ è¿ç»­å¥åº·å¤©æ•°
    var streak = 0;
    for (var j = 0; j < allRecords.length; j++) {
      var r = allRecords[j];
      if (r.status === 'worry' && (r.worriedPets || r.worried_pets || '').indexOf(name) >= 0) break;
      streak++;
    }

    // æœ€çµ‚å¿ƒé…æ—¥ / æœ€åæ‹…å¿ƒæ—¥æœŸ
    var lastWorry = null;
    for (var j = 0; j < allRecords.length; j++) {
      var r = allRecords[j];
      if (r.status === 'worry' && (r.worriedPets || r.worried_pets || '').indexOf(name) >= 0) {
        lastWorry = getDate(r);
        break;
      }
    }

    // ã‚ˆãã‚ã‚‹ç—‡çŠ¶ï¼ˆé »åº¦ä¸Šä½3ã¤ï¼‰/ å¸¸è§ç—‡çŠ¶ï¼ˆå‰3ï¼‰
    var symptomCounts = {};
    worryRecords.forEach(function(r) {
      if (r.symptoms) {
        r.symptoms.split(/[,ã€]/).forEach(function(s) {
          s = s.trim();
          if (s) symptomCounts[s] = (symptomCounts[s] || 0) + 1;
        });
      }
    });
    var topSymptoms = Object.keys(symptomCounts).sort(function(a, b) {
      return symptomCounts[b] - symptomCounts[a];
    }).slice(0, 3);

    // ãƒšãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç”Ÿæˆ / ç”Ÿæˆå® ç‰©å¡ç‰‡
    var cardClass = worryCount > 0 ? 'pet-card has-worry' : 'pet-card';
    html += '<div class="' + cardClass + '">';
    html += '<div class="pet-card-header">ğŸ• ' + escapeHtml(name) + (breed ? 'ï¼ˆ' + escapeHtml(breed) + 'ï¼‰' : '') + '</div>';
    html += '<div class="pet-card-stats">';
    html += '<div class="pet-stat"><div class="pet-stat-val teal">' + healthRate + '%</div><div class="pet-stat-label">å…ƒæ°—ç‡</div></div>';
    html += '<div class="pet-stat"><div class="pet-stat-val amber">' + worryCount + 'å›</div><div class="pet-stat-label">å¿ƒé…å›æ•°</div></div>';
    html += '<div class="pet-stat"><div class="pet-stat-val rose">' + streak + 'æ—¥</div><div class="pet-stat-label">é€£ç¶š</div></div>';
    html += '</div>';

    if (worryCount > 0) {
      html += '<div class="pet-card-detail">';
      if (lastWorry) {
        var wd = new Date(lastWorry);
        html += '<div>æœ€çµ‚å¿ƒé…æ—¥: ' + (wd.getMonth() + 1) + '/' + wd.getDate() + '</div>';
      }
      if (topSymptoms.length > 0) {
        html += '<div>ã‚ˆãã‚ã‚‹ç—‡çŠ¶: ' + topSymptoms.map(function(s) {
          return '<span class="symptom-tag">' + escapeHtml(s) + '</span>';
        }).join(' ') + '</div>';
      }
      html += '</div>';
    } else {
      html += '<div class="pet-card-allclear">âœ¨ ãšã£ã¨å…ƒæ°—ã§ã™ï¼</div>';
    }

    html += '</div>';
  });

  // å®¶æ—å…¨ä½“ã‚µãƒãƒªãƒ¼ / å®¶åº­æ•´ä½“æ‘˜è¦
  html += '<div class="section-title" style="margin-top:8px;">ğŸ“Š å®¶æ—å…¨ä½“ã‚µãƒãƒªãƒ¼</div>';
  html += '<div class="card family-summary-card">';
  html += '<div>ãƒˆãƒ¼ã‚¿ãƒ« ' + (data.totalDays || 0) + 'æ—¥ | é€£ç¶š ' + (data.streak || 0) + 'æ—¥ ğŸ”¥</div>';
  html += '<div>å®¶æ—å…¨ä½“ã®å…ƒæ°—ç‡: ' + (data.healthRate || 0) + '%</div>';
  html += '</div>';

  // æœ€è¿‘ã®ãƒã‚§ãƒƒã‚¯å±¥æ­´ï¼ˆç›´è¿‘7ä»¶ï¼‰/ æœ€è¿‘æ£€æŸ¥è®°å½•ï¼ˆæœ€è¿‘7æ¡ï¼‰
  html += '<div class="section-title" style="margin-top:8px;">ğŸ“‹ æœ€è¿‘ã®ãƒã‚§ãƒƒã‚¯å±¥æ­´ï¼ˆç›´è¿‘7ä»¶ï¼‰</div>';
  html += '<div class="card" style="padding:0 16px;">';
  if (!allRecords || allRecords.length === 0) {
    html += '<div style="padding:16px 0;text-align:center;color:var(--s400);font-size:12px;">ã¾ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    var weekdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    html += allRecords.slice(0, 7).map(function(r) {
      var dateStr = getDate(r);
      var d = new Date(dateStr);
      var label = isNaN(d.getTime()) ? dateStr : ((d.getMonth()+1) + '/' + d.getDate() + 'ï¼ˆ' + weekdays[d.getDay()] + 'ï¼‰');
      if (r.status === 'genki') {
        return '<div class="record-row"><span class="date">' + label + '</span><span class="status-g">âœ… å…¨å“¡å…ƒæ°—</span></div>';
      } else {
        var detail = escapeHtml(r.worriedPets || r.worried_pets || 'å¿ƒé…');
        if (r.symptoms) detail += 'ï¼ˆ' + escapeHtml(r.symptoms) + 'ï¼‰';
        return '<div class="record-row"><span class="date">' + label + '</span><span class="status-w">âš ï¸ ' + detail + '</span></div>';
      }
    }).join('');
  }
  html += '</div>';

  document.getElementById('petsView').innerHTML = html;
}

// â•â•â• Util â•â•â•
function escapeHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
