<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å¿ƒé…ãªå­ãŒã„ã‚‹</title>
<style>
:root{--rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}
.header{background:var(--card);padding:16px;border-bottom:2px solid var(--amber);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}
.section{padding:16px;}
.pet-row{display:flex;align-items:center;gap:12px;padding:14px;border-radius:14px;border:1.5px solid var(--s200);cursor:pointer;transition:all .15s;margin-bottom:8px;background:var(--card);}
.pet-row .icon{font-size:24px;}
.pet-row .name{flex:1;font-size:14px;font-weight:700;}
.pet-row .status{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;}
.pet-row.ok{border-color:var(--teal);background:var(--teal-l);}
.pet-row.ok .status{background:var(--teal);color:#fff;}
.pet-row.worried{border-color:var(--amber);background:var(--amber-l);}
.pet-row.worried .status{background:var(--amber);color:#fff;}
.symptom-area{display:none;margin-top:16px;}
.symptom-area.show{display:block;}
.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:8px;display:block;}
.symptom-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.symptom-btn{padding:8px 14px;border-radius:10px;border:1.5px solid var(--s200);background:var(--card);font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;}
.symptom-btn.selected{border-color:var(--amber);background:var(--amber-l);color:#92400E;}
.form-input{width:100%;padding:12px 14px;border:1.5px solid var(--s200);border-radius:12px;font-size:14px;background:var(--card);font-family:inherit;margin-bottom:16px;}
.form-input:focus{outline:none;border-color:var(--amber);}
.btn{display:block;width:100%;padding:14px;border-radius:14px;font-size:15px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-warn{background:linear-gradient(135deg,var(--amber),var(--orange));color:#fff;box-shadow:0 4px 16px rgba(255,179,71,.3);}
.btn-ghost{background:transparent;color:var(--s500);font-size:13px;margin-top:8px;}
.btn:disabled{opacity:.5;}
.done{text-align:center;padding:40px 16px;display:none;}
.done .icon{font-size:64px;}
.done h2{font-size:20px;font-weight:900;color:#92400E;margin-top:12px;}
.done p{font-size:13px;color:var(--s500);margin-top:6px;line-height:1.6;}
.info{padding:12px;border-radius:12px;font-size:12px;text-align:center;margin-top:12px;}
.info.amber{background:var(--amber-l);color:#92400E;border:1px solid var(--amber);}
.loading{display:none;text-align:center;padding:40px;}
.loading.show{display:block;}
</style>
</head>
<body>

<!-- ===== ãƒ¡ã‚¤ãƒ³ç”»é¢ ===== -->
<div id="main">
  <div class="header">
    <h1>âš ï¸ å¿ƒé…ãªå­ã‚’é¸ã‚“ã§ãã ã•ã„</h1>
    <p>è©²å½“ã™ã‚‹å­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œå¿ƒé…âš ï¸ã€ã«åˆ‡ã‚Šæ›¿ãˆ</p>
  </div>
  <div class="section">
    <div id="petList">
      <!-- ãƒšãƒƒãƒˆãƒªã‚¹ãƒˆã¯JSã§å‹•çš„ç”Ÿæˆ -->
      <div style="text-align:center;padding:20px;color:var(--s400);">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <div id="symptomArea" class="symptom-area">
      <label class="form-label">å¿ƒé…ãªç—‡çŠ¶ï¼ˆä»»æ„ï¼‰</label>
      <div class="symptom-grid" id="symptomGrid">
        <div class="symptom-btn" onclick="toggleSymptom(this)">é£Ÿæ¬²ãªã—</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å…ƒæ°—ãªã—</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ä¸‹ç—¢</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å˜”å</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å’³</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ãã—ã‚ƒã¿</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">è¶³ã‚’å¼•ããšã‚‹</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ãã®ä»–</div>
      </div>
      
      <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <input class="form-input" id="memo" placeholder="ä¾‹ï¼šæœã‹ã‚‰ã”é£¯ã‚’é£Ÿã¹ãªã„">
    </div>
  </div>
  <div class="section" style="padding-top:0;">
    <button class="btn btn-warn" id="submitBtn" onclick="submitWorry()" disabled>âš ï¸ ãƒã‚§ãƒƒã‚¯å®Œäº†</button>
    <button class="btn btn-ghost" onclick="closeLiff()">â† ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ===== Loading ===== -->
<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">â³</div>
  <div>è¨˜éŒ²ä¸­...</div>
</div>

<!-- ===== å®Œäº†ç”»é¢ ===== -->
<div id="done" class="done">
  <div class="icon">âš ï¸</div>
  <h2>ãƒã‚§ãƒƒã‚¯å®Œäº†</h2>
  <p id="doneMsg"></p>
  <div class="info amber">ãŠå¤§äº‹ã«ã—ã¦ãã ã•ã„ ğŸ’›<br><span style="font-size:11px;">ç—‡çŠ¶ãŒç¶šãå ´åˆã¯ç£åŒ»ã•ã‚“ã¸ã”ç›¸è«‡ã‚’</span></div>
  <button class="btn btn-ghost" style="margin-top:16px;" onclick="closeLiff()">é–‰ã˜ã‚‹</button>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
const GAS_URL = PAWBON_CONFIG.GAS_URL;
let lineId = '';
let petNames = [];
const worriedPets = new Set();

// ===== LIFFåˆæœŸåŒ– =====
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.worry });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) {
    lineId = 'debug_user';
  }
  loadUserData();
}
initLiff();

// ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­è¾¼ =====
async function loadUserData() {
  try {
    const res = await fetch(GAS_URL + '?action=getUserData&lineId=' + lineId);
    const data = await res.json();
    
    if (!data.registered) {
      document.getElementById('petList').innerHTML = '<div style="text-align:center;padding:20px;">æœªç™»éŒ²ã§ã™ã€‚å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’ã—ã¦ãã ã•ã„ã€‚</div>';
      return;
    }
    
    if (data.checkedInToday) {
      document.getElementById('petList').innerHTML = '<div style="text-align:center;padding:20px;">âœ… ä»Šæ—¥ã¯ã‚‚ã†ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã§ã™ï¼</div>';
      document.getElementById('submitBtn').style.display = 'none';
      return;
    }
    
    // ãƒšãƒƒãƒˆãƒªã‚¹ãƒˆç”Ÿæˆ
    petNames = data.petNames.split(',').map(n => n.trim());
    const icons = ['ğŸ•','ğŸˆ','ğŸ©','ğŸ¾'];
    
    document.getElementById('petList').innerHTML = petNames.map((name, i) =>
      `<div class="pet-row ok" onclick="togglePet(this,'${name}')" data-name="${name}">
        <div class="icon">${icons[i % icons.length]}</div>
        <div class="name">${name}</div>
        <div class="status">å…ƒæ°— âœ…</div>
      </div>`
    ).join('');
    
  } catch (e) {
    console.error('Load error:', e);
    // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    petNames = ['ãƒãƒ§ã‚³','ãƒ¢ã‚«','ãƒ©ãƒ†'];
    document.getElementById('petList').innerHTML = petNames.map((name, i) =>
      `<div class="pet-row ok" onclick="togglePet(this,'${name}')" data-name="${name}">
        <div class="icon">${['ğŸ•','ğŸ•','ğŸ©'][i]}</div>
        <div class="name">${name}</div>
        <div class="status">å…ƒæ°— âœ…</div>
      </div>`
    ).join('');
  }
}

// ===== ãƒšãƒƒãƒˆåˆ‡æ›¿ =====
function togglePet(el, name) {
  if (el.classList.contains('ok')) {
    el.classList.remove('ok');
    el.classList.add('worried');
    el.querySelector('.status').textContent = 'å¿ƒé… âš ï¸';
    worriedPets.add(name);
  } else {
    el.classList.remove('worried');
    el.classList.add('ok');
    el.querySelector('.status').textContent = 'å…ƒæ°— âœ…';
    worriedPets.delete(name);
  }
  
  const area = document.getElementById('symptomArea');
  area.classList.toggle('show', worriedPets.size > 0);
  document.getElementById('submitBtn').disabled = worriedPets.size === 0;
}

function toggleSymptom(el) {
  el.classList.toggle('selected');
}

// ===== é€ä¿¡ =====
async function submitWorry() {
  if (worriedPets.size === 0) return;
  
  document.getElementById('main').style.display = 'none';
  document.getElementById('loading').classList.add('show');
  
  const symptoms = Array.from(document.querySelectorAll('.symptom-btn.selected'))
    .map(el => el.textContent).join(', ');
  const memo = document.getElementById('memo').value.trim();
  
  try {
    const res = await fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'checkinWorry',
        lineId: lineId,
        worriedPets: Array.from(worriedPets).join(', '),
        symptoms: symptoms,
        memo: memo
      })
    });
    const data = await res.json();
    
    document.getElementById('loading').classList.remove('show');
    
    const wNames = Array.from(worriedPets).join('ãƒ»');
    document.getElementById('doneMsg').textContent = 
      'âš ï¸ ' + wNames + 'ã®å¿ƒé…ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚\nå®¶æ—ã«ã‚‚çŠ¶æ³ã‚’ä¼ãˆã¾ã—ãŸã€‚';
    document.getElementById('done').style.display = 'block';
    
  } catch (e) {
    document.getElementById('loading').classList.remove('show');
    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    document.getElementById('main').style.display = 'block';
  }
}

function closeLiff() {
  if (typeof liff !== 'undefined' && liff.isInClient()) { liff.closeWindow(); }
  else { window.close(); }
}
</script>
</body>
</html>
