<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å¿ƒé…ãªå­ãŒã„ã‚‹</title>
<style>
:root{--rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}
.header{background:var(--card);padding:16px;border-bottom:2px solid var(--amber);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}
.section{padding:16px;}
.pet-row{display:flex;align-items:center;gap:12px;padding:14px;border-radius:14px;border:1.5px solid var(--s200);cursor:pointer;transition:all .15s;margin-bottom:8px;background:var(--card);}
.pet-row .icon{font-size:24px;}
.pet-row .name{flex:1;font-size:14px;font-weight:700;}
.pet-row .breed{font-size:10px;color:var(--s400);}
.pet-row .status{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;}
.pet-row.ok{border-color:var(--teal);background:var(--teal-l);}
.pet-row.ok .status{background:var(--teal);color:#fff;}
.pet-row.worried{border-color:var(--amber);background:var(--amber-l);}
.pet-row.worried .status{background:var(--amber);color:#fff;}
.symptom-area{display:none;margin-top:16px;}
.symptom-area.show{display:block;}
.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:8px;display:block;}
.symptom-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.symptom-btn{padding:8px 14px;border-radius:10px;border:1.5px solid var(--s200);background:var(--card);font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;}
.symptom-btn.selected{border-color:var(--amber);background:var(--amber-l);color:#92400E;}
.form-input{width:100%;padding:12px 14px;border:1.5px solid var(--s200);border-radius:12px;font-size:14px;background:var(--card);font-family:inherit;margin-bottom:16px;}
.form-input:focus{outline:none;border-color:var(--amber);}
.btn{display:block;width:100%;padding:14px;border-radius:14px;font-size:15px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-warn{background:linear-gradient(135deg,var(--amber),var(--orange));color:#fff;box-shadow:0 4px 16px rgba(255,179,71,.3);}
.btn-ghost{background:transparent;color:var(--s500);font-size:13px;margin-top:8px;}
.btn:disabled{opacity:.5;}
.done{text-align:center;padding:40px 16px;display:none;}
.done .icon{font-size:64px;}
.done h2{font-size:20px;font-weight:900;color:#92400E;margin-top:12px;}
.done p{font-size:13px;color:var(--s500);margin-top:6px;line-height:1.6;}
.info{padding:12px;border-radius:12px;font-size:12px;text-align:center;margin-top:12px;}
.info.amber{background:var(--amber-l);color:#92400E;border:1px solid var(--amber);}
.loading{display:none;text-align:center;padding:40px;}
.loading.show{display:block;}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}
</style>
</head>
<body>

<!-- ===== ãƒ¡ã‚¤ãƒ³ç”»é¢ ===== -->
<div id="main">
  <div class="header">
    <h1>âš ï¸ å¿ƒé…ãªå­ã‚’é¸ã‚“ã§ãã ã•ã„</h1>
    <p>è©²å½“ã™ã‚‹å­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œå¿ƒé…âš ï¸ã€ã«åˆ‡ã‚Šæ›¿ãˆ</p>
  </div>
  <div class="section">
    <div id="petList">
      <div style="text-align:center;padding:20px;color:var(--s400);">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="symptomArea" class="symptom-area">
      <label class="form-label">å¿ƒé…ãªç—‡çŠ¶ï¼ˆä»»æ„ï¼‰</label>
      <div class="symptom-grid" id="symptomGrid">
        <div class="symptom-btn" onclick="toggleSymptom(this)">é£Ÿæ¬²ãªã—</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å…ƒæ°—ãªã—</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ä¸‹ç—¢</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å˜”å</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">å’³</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ãã—ã‚ƒã¿</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">è¶³ã‚’å¼•ããšã‚‹</div>
        <div class="symptom-btn" onclick="toggleSymptom(this)">ãã®ä»–</div>
      </div>

      <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <input class="form-input" id="memo" placeholder="ä¾‹ï¼šæœã‹ã‚‰ã”é£¯ã‚’é£Ÿã¹ãªã„">
    </div>
  </div>
  <div class="section" style="padding-top:0;">
    <button class="btn btn-warn" id="submitBtn" onclick="submitWorry()" disabled>âš ï¸ ãƒã‚§ãƒƒã‚¯å®Œäº†</button>
    <button class="btn btn-ghost" onclick="closeLiff()">â† ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ===== Loading ===== -->
<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">â³</div>
  <div>è¨˜éŒ²ä¸­...</div>
</div>

<!-- ===== å®Œäº†ç”»é¢ ===== -->
<div id="done" class="done">
  <div class="icon">âš ï¸</div>
  <h2>ãƒã‚§ãƒƒã‚¯å®Œäº†</h2>
  <p id="doneMsg"></p>
  <div class="info amber">ãŠå¤§äº‹ã«ã—ã¦ãã ã•ã„ ğŸ’›<br><span style="font-size:11px;">ç—‡çŠ¶ãŒç¶šãå ´åˆã¯ç£åŒ»ã•ã‚“ã¸ã”ç›¸è«‡ã‚’</span></div>
  <button class="btn btn-ghost" style="margin-top:16px;" onclick="closeLiff()">é–‰ã˜ã‚‹</button>
</div>

<div class="footer">PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.3.3 Beta<br>Â© 2026 PawBon Inc.</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
var GAS_URL = PAWBON_CONFIG.GAS_URL;
var SUPA_URL = PAWBON_CONFIG.SUPABASE_URL;
var SUPA_KEY = PAWBON_CONFIG.SUPABASE_KEY;
var lineId = '';
var familyCode = '';
var petNames = [];
var petBreeds = [];
var worriedPets = {};

function supaGet(path) {
  return fetch(SUPA_URL + '/rest/v1/' + path, {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  }).then(function(r){ return r.json(); });
}

// â•â•â• LIFF â•â•â•
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.worry });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) {
    try {
      var latest = await supaGet('pet_families?order=registered_at.desc&limit=1');
      if (latest && latest.length > 0) lineId = latest[0].owner_line_id;
    } catch (e2) {}
  }
  loadUserData();
}
initLiff();

// â•â•â• Load â•â•â•
async function loadUserData() {
  try {
    // 1. ã‚ªãƒ¼ãƒŠãƒ¼ã¨ã—ã¦æ¤œç´¢
    var families = await supaGet('pet_families?owner_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
    var family = null;

    if (families && families.length > 0) {
      family = families[0];
    } else {
      // 2. ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦æ¤œç´¢
      var members = await supaGet('family_members?member_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
      if (members && members.length > 0) {
        var fam = await supaGet('pet_families?family_code=eq.' + encodeURIComponent(members[0].family_code) + '&limit=1');
        if (fam && fam.length > 0) family = fam[0];
      }
    }

    if (!family) {
      document.getElementById('petList').innerHTML =
        '<div style="text-align:center;padding:20px;">æœªç™»éŒ²ã§ã™ã€‚å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’ã—ã¦ãã ã•ã„ã€‚</div>';
      document.getElementById('submitBtn').style.display = 'none';
      return;
    }

    familyCode = family.family_code;

    // 3. ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ç¢ºèª
    var today = new Date().toISOString().substring(0, 10);
    var todayCheckins = await supaGet(
      'checkins?family_code=eq.' + encodeURIComponent(familyCode) +
      '&checkin_date=eq.' + today +
      '&reporter_line_id=eq.' + encodeURIComponent(lineId) +
      '&limit=1'
    );

    if (todayCheckins && todayCheckins.length > 0) {
      document.getElementById('petList').innerHTML =
        '<div style="text-align:center;padding:20px;">âœ… ä»Šæ—¥ã¯ã‚‚ã†ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã§ã™ï¼</div>';
      document.getElementById('submitBtn').style.display = 'none';
      return;
    }

    // 4. ãƒšãƒƒãƒˆãƒªã‚¹ãƒˆç”Ÿæˆ
    petNames = family.pet_names.split(',').map(function(s){ return s.trim(); }).filter(Boolean);
    petBreeds = (family.breeds || '').split(',').map(function(s){ return s.trim(); });

    var speciesIcons = {};
    var breedOptions = {
      dog: ['æŸ´çŠ¬','ãƒˆã‚¤ãƒ—ãƒ¼ãƒ‰ãƒ«','ãƒãƒ¯ãƒ¯','ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ¬ãƒˆãƒªãƒãƒ¼','ãƒ•ãƒ¬ãƒ³ãƒãƒ–ãƒ«ãƒ‰ãƒƒã‚°','ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒ€ãƒƒã‚¯ã‚¹','ãƒãƒ¡ãƒ©ãƒ‹ã‚¢ãƒ³','ã‚³ãƒ¼ã‚®ãƒ¼','MIX'],
      cat: ['ã‚¹ã‚³ãƒ†ã‚£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ãƒãƒ³ãƒã‚«ãƒ³','ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚·ãƒ§ãƒ¼ãƒˆãƒ˜ã‚¢','ãƒ©ã‚°ãƒ‰ãƒ¼ãƒ«'],
      other: ['ã†ã•ã','ãƒãƒ ã‚¹ã‚¿ãƒ¼','ãƒ•ã‚§ãƒ¬ãƒƒãƒˆ','é³¥']
    };

    function getIcon(breed) {
      if (!breed) return 'ğŸ¾';
      if (breedOptions.dog.indexOf(breed) !== -1) return 'ğŸ•';
      if (breedOptions.cat.indexOf(breed) !== -1) return 'ğŸˆ';
      if (breedOptions.other.indexOf(breed) !== -1) return 'ğŸ¾';
      return 'ğŸ¾';
    }

    document.getElementById('petList').innerHTML = petNames.map(function(name, i) {
      var breed = petBreeds[i] || '';
      var icon = getIcon(breed);
      var breedLabel = breed ? ' Â· ' + escapeHtml(breed) : '';
      return '<div class="pet-row ok" onclick="togglePet(this,\'' + escapeAttr(name) + '\')" data-name="' + escapeAttr(name) + '">' +
        '<div class="icon">' + icon + '</div>' +
        '<div class="name">' + escapeHtml(name) + '<span class="breed">' + breedLabel + '</span></div>' +
        '<div class="status">å…ƒæ°— âœ…</div>' +
      '</div>';
    }).join('');

  } catch (e) {
    document.getElementById('petList').innerHTML =
      '<div style="text-align:center;padding:20px;color:var(--rose);">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
  }
}

// â•â•â• Toggle â•â•â•
function togglePet(el, name) {
  if (el.classList.contains('ok')) {
    el.classList.remove('ok');
    el.classList.add('worried');
    el.querySelector('.status').textContent = 'å¿ƒé… âš ï¸';
    worriedPets[name] = true;
  } else {
    el.classList.remove('worried');
    el.classList.add('ok');
    el.querySelector('.status').textContent = 'å…ƒæ°— âœ…';
    delete worriedPets[name];
  }

  var count = Object.keys(worriedPets).length;
  document.getElementById('symptomArea').classList.toggle('show', count > 0);
  document.getElementById('submitBtn').disabled = count === 0;
}

function toggleSymptom(el) {
  el.classList.toggle('selected');
}

// â•â•â• Submit â•â•â•
async function submitWorry() {
  var wNames = Object.keys(worriedPets);
  if (wNames.length === 0) return;

  document.getElementById('main').style.display = 'none';
  document.getElementById('loading').classList.add('show');

  var symptoms = [];
  document.querySelectorAll('.symptom-btn.selected').forEach(function(el) {
    symptoms.push(el.textContent);
  });
  var memo = document.getElementById('memo').value.trim();

  var payload = {
    action: 'checkinWorry',
    lineId: lineId,
    familyCode: familyCode,
    worriedPets: wNames.join(', '),
    symptoms: symptoms.join(', '),
    memo: memo
  };

  try {
    // 1. GAS ã«é€ä¿¡ï¼ˆno-corsï¼‰
    await fetch(GAS_URL, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify(payload)
    }).catch(function(){});

    // 2. å¾…æ©Ÿ
    await new Promise(function(r){ setTimeout(r, 3000); });

    // 3. Supabase ã§ç¢ºèª
    var today = new Date().toISOString().substring(0, 10);
    var check = await supaGet(
      'checkins?family_code=eq.' + encodeURIComponent(familyCode) +
      '&checkin_date=eq.' + today +
      '&reporter_line_id=eq.' + encodeURIComponent(lineId) +
      '&limit=1'
    );

    document.getElementById('loading').classList.remove('show');

    if (check && check.length > 0) {
      document.getElementById('doneMsg').textContent =
        'âš ï¸ ' + wNames.join('ãƒ»') + 'ã®å¿ƒé…ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚\nå®¶æ—ã«ã‚‚çŠ¶æ³ã‚’ä¼ãˆã¾ã—ãŸã€‚';
    } else {
      document.getElementById('doneMsg').textContent =
        'âš ï¸ ' + wNames.join('ãƒ»') + 'ã®å¿ƒé…ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\nåæ˜ ã«å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚';
    }
    document.getElementById('done').style.display = 'block';

  } catch (e) {
    document.getElementById('loading').classList.remove('show');
    alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    document.getElementById('main').style.display = 'block';
  }
}

function closeLiff() {
  if (typeof liff !== 'undefined' && liff.isInClient()) { liff.closeWindow(); }
  else { window.close(); }
}

// â•â•â• Util â•â•â•
function escapeHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
function escapeAttr(s) {
  return s.replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
