<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” è¨­å®š</title>
<style>
:root{--rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;--rose-l:#FFF0F2;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:20px;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.section{padding:16px;}
.section-title{font-size:13px;font-weight:800;color:var(--s500);margin-bottom:10px;}
.card{background:var(--card);border-radius:16px;padding:0 16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.list-item{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--s100);cursor:pointer;}
.list-item:last-child{border:none;}
.list-ico{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.list-body{flex:1;}
.list-body .lt{font-size:14px;font-weight:700;}
.list-body .lb{font-size:11px;color:var(--s400);margin-top:1px;}
.list-arr{color:var(--s400);font-size:16px;}
.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:6px;display:block;}
.form-input,.form-select{width:100%;padding:12px 14px;border:1.5px solid var(--s200);border-radius:12px;font-size:14px;background:var(--card);appearance:none;font-family:inherit;margin-bottom:12px;}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--teal);}
.choice-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.choice-btn{padding:10px 16px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;border:1.5px solid var(--s200);background:var(--card);transition:all .15s;}
.choice-btn.selected{border-color:var(--teal);background:var(--teal-l);color:var(--teal-d);}
.btn{display:block;width:100%;padding:12px;border-radius:14px;font-size:14px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-primary{background:linear-gradient(135deg,var(--teal),var(--teal-d));color:#fff;}
.btn-ghost{background:transparent;color:var(--s500);font-size:13px;margin-top:8px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;align-items:flex-end;justify-content:center;}
.modal.show{display:flex;}
.modal-content{background:var(--bg);border-radius:20px 20px 0 0;padding:20px 16px 32px;width:100%;max-width:430px;max-height:80vh;overflow-y:auto;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.modal-header h3{font-size:16px;font-weight:800;}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--s100);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;font-size:16px;}
.loading{text-align:center;padding:60px;color:var(--s400);}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}
</style>
</head>
<body>

<div class="header">
  <h1>âš™ï¸ è¨­å®š</h1>
</div>

<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">âš™ï¸</div>
  <div>èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="content" style="display:none;">
  <div class="section">
    <div class="section-title">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
    <div class="card">
      <div class="list-item" onclick="openModal('profileModal')">
        <div class="list-ico" style="background:#EDE9FE;">ğŸ‘¤</div>
        <div class="list-body"><div class="lt">å€‹äººæƒ…å ±</div><div class="lb" id="profileSummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
    </div>
  </div>

  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ¾ ãƒšãƒƒãƒˆãƒ»å®¶æ—</div>
    <div class="card">
      <div class="list-item" onclick="openModal('petModal')">
        <div class="list-ico" style="background:var(--teal-l);">ğŸ¾</div>
        <div class="list-body"><div class="lt">ãƒšãƒƒãƒˆæƒ…å ±ç·¨é›†</div><div class="lb" id="petSummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
      <div class="list-item" onclick="openModal('areaModal')">
        <div class="list-ico" style="background:var(--amber-l);">ğŸ“</div>
        <div class="list-body"><div class="lt">åœ°åŸŸå¤‰æ›´</div><div class="lb" id="areaSummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
      <div class="list-item" onclick="openFamily()">
        <div class="list-ico" style="background:var(--rose-l);">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦</div>
        <div class="list-body"><div class="lt">å®¶æ—ç®¡ç†</div><div class="lb" id="familySummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.2.0 Beta<br>
  Â© 2026 PawBon Inc.
</div>

<!-- ===== å€‹äººæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ‘¤ å€‹äººæƒ…å ±</h3>
      <button class="modal-close" onclick="closeModal('profileModal')">âœ•</button>
    </div>
    <label class="form-label">ãŠåå‰</label>
    <input class="form-input" id="editDisplayName" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒ">
    <label class="form-label">ç¶šæŸ„</label>
    <div class="choice-grid" id="editRelationGrid">
      <div class="choice-btn" onclick="selectRelation(this,'ã‚ªãƒ¼ãƒŠãƒ¼')">ğŸ  ã‚ªãƒ¼ãƒŠãƒ¼</div>
      <div class="choice-btn" onclick="selectRelation(this,'ãƒ‘ãƒ‘')">ğŸ‘¨ ãƒ‘ãƒ‘</div>
      <div class="choice-btn" onclick="selectRelation(this,'ãƒãƒ')">ğŸ‘© ãƒãƒ</div>
      <div class="choice-btn" onclick="selectRelation(this,'å®¶æ—')">ğŸ‘¥ å®¶æ—</div>
    </div>
    <button class="btn btn-primary" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('profileModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ===== ãƒšãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="petModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ¾ ãƒšãƒƒãƒˆæƒ…å ±ç·¨é›†</h3>
      <button class="modal-close" onclick="closeModal('petModal')">âœ•</button>
    </div>
    <label class="form-label">ğŸ¾ ãƒšãƒƒãƒˆã®ãŠåå‰</label>
    <input class="form-input" id="editPetNames" placeholder="ä¾‹ï¼šãƒãƒ§ã‚³ï¼ˆè¤‡æ•°ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰">
    <div style="font-size:10px;color:var(--s400);margin-top:-8px;margin-bottom:12px;">ğŸ’¡ è¤‡æ•°ã®å ´åˆï¼šãƒãƒ§ã‚³, ãƒ¢ã‚«, ãƒ©ãƒ†</div>

    <label class="form-label">ğŸ“‹ ç¨®é¡</label>
    <div class="choice-grid" id="editSpeciesGrid">
      <div class="choice-btn" onclick="selectEditSpecies(this,'dog')">ğŸ• çŠ¬</div>
      <div class="choice-btn" onclick="selectEditSpecies(this,'cat')">ğŸˆ çŒ«</div>
      <div class="choice-btn" onclick="selectEditSpecies(this,'other')">ğŸ¾ ãã®ä»–</div>
    </div>

    <div id="editBreedGroup" style="display:none;">
      <label class="form-label">çŠ¬ç¨®ãƒ»çŒ«ç¨®</label>
      <select class="form-select" id="editBreeds"></select>
    </div>

    <label class="form-label">ğŸ”¢ ä½•åŒ¹é£¼ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ</label>
    <div class="choice-grid" id="editCountGrid">
      <div class="choice-btn" onclick="selectEditCount(this,1)">1åŒ¹</div>
      <div class="choice-btn" onclick="selectEditCount(this,2)">2åŒ¹</div>
      <div class="choice-btn" onclick="selectEditCount(this,3)">3åŒ¹</div>
      <div class="choice-btn" onclick="selectEditCount(this,4)">4åŒ¹+</div>
    </div>

    <button class="btn btn-primary" onclick="savePetInfo()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('petModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ===== åœ°åŸŸå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="areaModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“ åœ°åŸŸå¤‰æ›´</h3>
      <button class="modal-close" onclick="closeModal('areaModal')">âœ•</button>
    </div>
    <label class="form-label">éƒ½é“åºœçœŒ</label>
    <select class="form-select" id="editArea">
      <option value="">é¸æŠ</option>
      <option>åŒ—æµ·é“</option><option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option>
      <option>å¤§é˜ªåºœ</option><option>æ„›çŸ¥çœŒ</option><option>ç¦å²¡çœŒ</option>
      <option>ãã®ä»–</option>
    </select>
    <label class="form-label">å¸‚åŒºç”ºæ‘</label>
    <input class="form-input" id="editAreaDetail" placeholder="ä¸–ç”°è°·åŒº">
    <button class="btn btn-primary" onclick="saveArea()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('areaModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
var GAS_URL = PAWBON_CONFIG.GAS_URL;
var SUPA_URL = PAWBON_CONFIG.SUPABASE_URL;
var SUPA_KEY = PAWBON_CONFIG.SUPABASE_KEY;
var lineId = '';
var userData = null;
var editPetCount = 1;
var editSpecies = '';
var editRelation = '';

// Supabase helpers
function supaGet(path) {
  return fetch(SUPA_URL + '/rest/v1/' + path, {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  }).then(function(r){ return r.json(); });
}
function supaPatch(table, query, data) {
  return fetch(SUPA_URL + '/rest/v1/' + table + '?' + query, {
    method: 'PATCH',
    headers: {
      'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY,
      'Content-Type': 'application/json', 'Prefer': 'return=minimal'
    },
    body: JSON.stringify(data)
  });
}

// LIFF init
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.settings });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) {
    try {
      var latest = await supaGet('pet_families?order=registered_at.desc&limit=1');
      if (latest && latest.length > 0) lineId = latest[0].owner_line_id;
    } catch (e2) {}
  }
  loadSettings();
}
initLiff();

// Load data
async function loadSettings() {
  try {
    var families = await supaGet('pet_families?owner_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
    var role = 'owner';
    var family = null;
    var myMember = null;

    if (families && families.length > 0) {
      family = families[0];
    } else {
      var members = await supaGet('family_members?member_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
      if (members && members.length > 0) {
        role = 'member';
        myMember = members[0];
        var fam = await supaGet('pet_families?family_code=eq.' + encodeURIComponent(members[0].family_code) + '&limit=1');
        if (fam && fam.length > 0) family = fam[0];
      }
    }

    if (!family) {
      document.getElementById('loading').innerHTML =
        '<div style="font-size:40px;margin-bottom:12px;">ğŸ“</div>' +
        '<div>æœªç™»éŒ²ã§ã™ã€‚å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</div>' +
        '<div style="margin-top:16px;padding:12px;background:#fff;border-radius:12px;font-size:11px;color:#94A3B8;word-break:break-all;">' +
        '<strong>ãƒ‡ãƒãƒƒã‚°:</strong> lineId=' + lineId + '</div>';
      return;
    }

    if (!myMember) {
      var myMs = await supaGet('family_members?member_line_id=eq.' + encodeURIComponent(lineId) + '&family_code=eq.' + encodeURIComponent(family.family_code) + '&limit=1');
      if (myMs && myMs.length > 0) myMember = myMs[0];
    }

    var allMembers = await supaGet('family_members?family_code=eq.' + encodeURIComponent(family.family_code) + '&order=registered_at.asc');

    userData = {
      role: role,
      familyCode: family.family_code,
      petNames: family.pet_names,
      breeds: family.breeds || '',
      petCount: family.pet_count,
      area: family.area,
      areaDetail: family.area_detail || '',
      familyMembers: allMembers || [],
      myMember: myMember
    };
    renderSettings();
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<div style="font-size:40px;margin-bottom:12px;">âŒ</div><div>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
  }
}

// Render
function renderSettings() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('content').style.display = 'block';

  var myName = userData.myMember ? userData.myMember.display_name : '-';
  var myRel = userData.myMember ? userData.myMember.relation : '-';
  document.getElementById('profileSummary').textContent = myName + 'ï¼ˆ' + myRel + 'ï¼‰';

  document.getElementById('petSummary').textContent = userData.petNames + 'ï¼ˆ' + userData.petCount + 'åŒ¹ï¼‰';
  document.getElementById('areaSummary').textContent = userData.area + ' ' + (userData.areaDetail || '');
  var memCount = userData.familyMembers ? userData.familyMembers.length : 0;
  document.getElementById('familySummary').textContent = memCount + 'äººç™»éŒ²æ¸ˆã¿ Â· ã‚³ãƒ¼ãƒ‰: ' + userData.familyCode;

  // Profile form defaults
  document.getElementById('editDisplayName').value = myName !== '-' ? myName : '';
  editRelation = myRel !== '-' ? myRel : '';
  document.querySelectorAll('#editRelationGrid .choice-btn').forEach(function(b) {
    b.classList.remove('selected');
    if (editRelation && b.textContent.indexOf(editRelation) !== -1) b.classList.add('selected');
  });

  // Pet form defaults
  document.getElementById('editPetNames').value = userData.petNames;
  editPetCount = userData.petCount;
  document.querySelectorAll('#editCountGrid .choice-btn').forEach(function(b, i) {
    b.classList.remove('selected');
    if (i + 1 === editPetCount || (i === 3 && editPetCount >= 4)) b.classList.add('selected');
  });
  if (userData.breeds) {
    document.getElementById('editBreedGroup').style.display = 'block';
    document.getElementById('editBreeds').innerHTML = '<option>' + userData.breeds + '</option>';
  }

  // Area form defaults
  document.getElementById('editArea').value = userData.area;
  document.getElementById('editAreaDetail').value = userData.areaDetail || '';
}

// Modals
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// === Profile ===
function selectRelation(el, val) {
  document.querySelectorAll('#editRelationGrid .choice-btn').forEach(function(b){ b.classList.remove('selected'); });
  el.classList.add('selected');
  editRelation = val;
}

async function saveProfile() {
  var name = document.getElementById('editDisplayName').value.trim();
  if (!name) { alert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!userData.myMember) { alert('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  try {
    await supaPatch('family_members',
      'member_line_id=eq.' + encodeURIComponent(lineId) + '&family_code=eq.' + encodeURIComponent(userData.familyCode),
      { display_name: name, relation: editRelation || userData.myMember.relation }
    );
    closeModal('profileModal');
    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
    loadSettings();
  } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

// === Pet ===
var breedOptions = {
  dog: ['æŸ´çŠ¬','ãƒˆã‚¤ãƒ—ãƒ¼ãƒ‰ãƒ«','ãƒãƒ¯ãƒ¯','ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ¬ãƒˆãƒªãƒãƒ¼','ãƒ•ãƒ¬ãƒ³ãƒãƒ–ãƒ«ãƒ‰ãƒƒã‚°','ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒ€ãƒƒã‚¯ã‚¹','ãƒãƒ¡ãƒ©ãƒ‹ã‚¢ãƒ³','ã‚³ãƒ¼ã‚®ãƒ¼','MIX','ãã®ä»–'],
  cat: ['ã‚¹ã‚³ãƒ†ã‚£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ãƒãƒ³ãƒã‚«ãƒ³','ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚·ãƒ§ãƒ¼ãƒˆãƒ˜ã‚¢','ãƒ©ã‚°ãƒ‰ãƒ¼ãƒ«','MIX','ãã®ä»–'],
  other: ['ã†ã•ã','ãƒãƒ ã‚¹ã‚¿ãƒ¼','ãƒ•ã‚§ãƒ¬ãƒƒãƒˆ','é³¥','ãã®ä»–']
};

function selectEditSpecies(el, type) {
  document.querySelectorAll('#editSpeciesGrid .choice-btn').forEach(function(b){ b.classList.remove('selected'); });
  el.classList.add('selected');
  editSpecies = type;
  var sel = document.getElementById('editBreeds');
  sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  (breedOptions[type] || []).forEach(function(o){ sel.innerHTML += '<option>' + o + '</option>'; });
  document.getElementById('editBreedGroup').style.display = 'block';
}

function selectEditCount(el, n) {
  document.querySelectorAll('#editCountGrid .choice-btn').forEach(function(b){ b.classList.remove('selected'); });
  el.classList.add('selected');
  editPetCount = n;
}

async function savePetInfo() {
  var names = document.getElementById('editPetNames').value.trim();
  if (!names) { alert('ãƒšãƒƒãƒˆã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  try {
    await supaPatch('pet_families', 'family_code=eq.' + encodeURIComponent(userData.familyCode), {
      pet_names: names,
      breeds: document.getElementById('editBreeds').value || userData.breeds,
      pet_count: editPetCount
    });
    closeModal('petModal');
    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
    loadSettings();
  } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

// === Area ===
async function saveArea() {
  var area = document.getElementById('editArea').value;
  if (!area) { alert('éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  try {
    await supaPatch('pet_families', 'family_code=eq.' + encodeURIComponent(userData.familyCode), {
      area: area, area_detail: document.getElementById('editAreaDetail').value.trim()
    });
    closeModal('areaModal');
    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
    loadSettings();
  } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

// === Family ===
function openFamily() {
  window.location.href = 'https://liff.line.me/' + PAWBON_CONFIG.LIFF_ID.family;
}
</script>
</body>
</html>
