<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” è¨­å®š</title>
<style>
:root{--rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:20px;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.section{padding:16px;}
.section-title{font-size:13px;font-weight:800;color:var(--s500);margin-bottom:10px;}
.card{background:var(--card);border-radius:16px;padding:0 16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.list-item{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--s100);cursor:pointer;}
.list-item:last-child{border:none;}
.list-ico{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.list-body{flex:1;}
.list-body .lt{font-size:14px;font-weight:700;}
.list-body .lb{font-size:11px;color:var(--s400);margin-top:1px;}
.list-arr{color:var(--s400);font-size:16px;}
.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:6px;display:block;}
.form-input,.form-select{width:100%;padding:12px 14px;border:1.5px solid var(--s200);border-radius:12px;font-size:14px;background:var(--card);appearance:none;font-family:inherit;margin-bottom:12px;}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--teal);}
.btn{display:block;width:100%;padding:12px;border-radius:14px;font-size:14px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-primary{background:linear-gradient(135deg,var(--teal),var(--teal-d));color:#fff;}
.btn-outline{background:var(--card);color:var(--s500);border:1.5px solid var(--s200);margin-top:8px;}
.btn-ghost{background:transparent;color:var(--s500);font-size:13px;margin-top:8px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;align-items:flex-end;justify-content:center;}
.modal.show{display:flex;}
.modal-content{background:var(--bg);border-radius:20px 20px 0 0;padding:20px 16px 32px;width:100%;max-width:430px;max-height:80vh;overflow-y:auto;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.modal-header h3{font-size:16px;font-weight:800;}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--s100);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;font-size:16px;}
.info{padding:12px;border-radius:12px;font-size:12px;text-align:center;margin-top:12px;}
.info.teal{background:var(--teal-l);color:var(--teal-d);}
.loading{text-align:center;padding:60px;color:var(--s400);}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}
</style>
</head>
<body>

<div class="header">
  <h1>âš™ï¸ è¨­å®š</h1>
</div>

<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">âš™ï¸</div>
  <div>èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="content" style="display:none;">
  <div class="section">
    <div class="card">
      <div class="list-item" onclick="openModal('petModal')">
        <div class="list-ico" style="background:var(--teal-l);">ğŸ¾</div>
        <div class="list-body"><div class="lt">ãƒšãƒƒãƒˆæƒ…å ±ç·¨é›†</div><div class="lb" id="petSummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
      <div class="list-item" onclick="openModal('areaModal')">
        <div class="list-ico" style="background:var(--amber-l);">ğŸ“</div>
        <div class="list-body"><div class="lt">åœ°åŸŸå¤‰æ›´</div><div class="lb" id="areaSummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
      <div class="list-item" onclick="openFamily()">
        <div class="list-ico" style="background:var(--rose-l);">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦</div>
        <div class="list-body"><div class="lt">å®¶æ—ç®¡ç†</div><div class="lb" id="familySummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
    </div>
  </div>
  
  <div class="footer">
    PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.1.0 Beta<br>
    Â© 2026 PawBon Inc.
  </div>
</div>

<!-- ===== ãƒšãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="petModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ¾ ãƒšãƒƒãƒˆæƒ…å ±ç·¨é›†</h3>
      <button class="modal-close" onclick="closeModal('petModal')">âœ•</button>
    </div>
    <label class="form-label">ãƒšãƒƒãƒˆã®åå‰</label>
    <input class="form-input" id="editPetNames" placeholder="ãƒãƒ§ã‚³, ãƒ¢ã‚«, ãƒ©ãƒ†">
    <label class="form-label">å“ç¨®</label>
    <input class="form-input" id="editBreeds" placeholder="æŸ´çŠ¬, æŸ´çŠ¬, ãƒˆã‚¤ãƒ—ãƒ¼ãƒ‰ãƒ«">
    <label class="form-label">é ­æ•°</label>
    <input class="form-input" id="editPetCount" type="number" min="1" max="10">
    <button class="btn btn-primary" onclick="savePetInfo()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('petModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ===== åœ°åŸŸå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="areaModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“ åœ°åŸŸå¤‰æ›´</h3>
      <button class="modal-close" onclick="closeModal('areaModal')">âœ•</button>
    </div>
    <label class="form-label">éƒ½é“åºœçœŒ</label>
    <select class="form-select" id="editArea">
      <option value="">é¸æŠ</option>
      <option>åŒ—æµ·é“</option><option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option>
      <option>å¤§é˜ªåºœ</option><option>æ„›çŸ¥çœŒ</option><option>ç¦å²¡çœŒ</option>
    </select>
    <label class="form-label">å¸‚åŒºç”ºæ‘</label>
    <input class="form-input" id="editAreaDetail" placeholder="ä¸–ç”°è°·åŒº">
    <button class="btn btn-primary" onclick="saveArea()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('areaModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
const GAS_URL = PAWBON_CONFIG.GAS_URL;
const SUPA_URL = PAWBON_CONFIG.SUPABASE_URL;
const SUPA_KEY = PAWBON_CONFIG.SUPABASE_KEY;
let lineId = '';
let userData = null;

function supaGet(path) {
  return fetch(SUPA_URL + '/rest/v1/' + path, {
    headers: {
      'apikey': SUPA_KEY,
      'Authorization': 'Bearer ' + SUPA_KEY
    }
  }).then(function(r){ return r.json(); });
}

async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.settings });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) { lineId = 'debug_user'; }
  loadSettings();
}
initLiff();

async function loadSettings() {
  try {
    // 1. pet_families ã‹ã‚‰ã‚ªãƒ¼ãƒŠãƒ¼æƒ…å ±ã‚’å–å¾—
    var families = await supaGet('pet_families?owner_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
    
    // ã‚ªãƒ¼ãƒŠãƒ¼ã¨ã—ã¦è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€family_members ã‹ã‚‰æ¢ã™
    var role = 'owner';
    var family = null;
    
    if (families && families.length > 0) {
      family = families[0];
    } else {
      var members = await supaGet('family_members?member_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
      if (members && members.length > 0) {
        role = 'member';
        var fam = await supaGet('pet_families?family_code=eq.' + encodeURIComponent(members[0].family_code) + '&limit=1');
        if (fam && fam.length > 0) family = fam[0];
      }
    }
    
    if (!family) {
      document.getElementById('loading').innerHTML = '<div style="font-size:40px;margin-bottom:12px;">ğŸ“</div><div>æœªç™»éŒ²ã§ã™ã€‚å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</div>';
      return;
    }
    
    // 2. family_members ã‚’å–å¾—
    var allMembers = await supaGet('family_members?family_code=eq.' + encodeURIComponent(family.family_code) + '&order=registered_at.asc');
    
    userData = {
      registered: true,
      role: role,
      familyCode: family.family_code,
      petNames: family.pet_names,
      breeds: family.breeds || '',
      petCount: family.pet_count,
      area: family.area,
      areaDetail: family.area_detail || '',
      familyMembers: allMembers || []
    };
    
    renderSettings();
  } catch (e) {
    document.getElementById('loading').innerHTML = '<div style="font-size:40px;margin-bottom:12px;">âŒ</div><div>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
  }
}

function renderSettings() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('content').style.display = 'block';
  
  document.getElementById('petSummary').textContent = userData.petNames + 'ï¼ˆ' + userData.petCount + 'åŒ¹ï¼‰';
  document.getElementById('areaSummary').textContent = userData.area + ' ' + (userData.areaDetail || '');
  var memCount = userData.familyMembers ? userData.familyMembers.length : 0;
  document.getElementById('familySummary').textContent = memCount + 'äººç™»éŒ²æ¸ˆã¿ Â· ã‚³ãƒ¼ãƒ‰: ' + userData.familyCode;
  
  // ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸå€¤ã‚»ãƒƒãƒˆ
  document.getElementById('editPetNames').value = userData.petNames;
  document.getElementById('editBreeds').value = userData.breeds || '';
  document.getElementById('editPetCount').value = userData.petCount;
  document.getElementById('editArea').value = userData.area;
  document.getElementById('editAreaDetail').value = userData.areaDetail || '';
}

function openModal(id) {
  document.getElementById(id).classList.add('show');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

async function savePetInfo() {
  var updates = {
    pet_names: document.getElementById('editPetNames').value.trim(),
    breeds: document.getElementById('editBreeds').value.trim(),
    pet_count: parseInt(document.getElementById('editPetCount').value) || 1
  };
  
  try {
    await fetch(SUPA_URL + '/rest/v1/pet_families?family_code=eq.' + encodeURIComponent(userData.familyCode), {
      method: 'PATCH',
      headers: {
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + SUPA_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify(updates)
    });
    closeModal('petModal');
    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
    loadSettings();
  } catch (e) {
    alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

async function saveArea() {
  var updates = {
    area: document.getElementById('editArea').value,
    area_detail: document.getElementById('editAreaDetail').value.trim()
  };
  
  try {
    await fetch(SUPA_URL + '/rest/v1/pet_families?family_code=eq.' + encodeURIComponent(userData.familyCode), {
      method: 'PATCH',
      headers: {
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + SUPA_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify(updates)
    });
    closeModal('areaModal');
    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
    loadSettings();
  } catch (e) {
    alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

function openFamily() {
  window.location.href = 'https://liff.line.me/' + PAWBON_CONFIG.LIFF_ID.family;
}
</script>
</body>
</html>
