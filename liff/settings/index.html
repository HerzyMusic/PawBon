<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” è¨­å®š</title>
<style>
:root{--rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;--rose-l:#FFF0F2;--blue-l:#EEF2FF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:20px;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.section{padding:16px;}
.section-title{font-size:13px;font-weight:800;color:var(--s500);margin-bottom:10px;}
.card{background:var(--card);border-radius:16px;padding:0 16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.list-item{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--s100);cursor:pointer;}
.list-item:last-child{border:none;}
.list-ico{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.list-body{flex:1;}
.list-body .lt{font-size:14px;font-weight:700;}
.list-body .lb{font-size:11px;color:var(--s400);margin-top:1px;}
.list-arr{color:var(--s400);font-size:16px;}
.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:6px;display:block;}
.form-input,.form-select{width:100%;padding:12px 14px;border:1.5px solid var(--s200);border-radius:12px;font-size:14px;background:var(--card);appearance:none;font-family:inherit;margin-bottom:12px;}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--teal);}
.form-input:disabled{background:var(--s100);color:var(--s400);}
.choice-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.choice-btn{padding:10px 16px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;border:1.5px solid var(--s200);background:var(--card);transition:all .15s;}
.choice-btn.selected{border-color:var(--teal);background:var(--teal-l);color:var(--teal-d);}
.choice-btn.disabled{opacity:.4;cursor:not-allowed;pointer-events:none;}
.btn{display:block;width:100%;padding:12px;border-radius:14px;font-size:14px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-primary{background:linear-gradient(135deg,var(--teal),var(--teal-d));color:#fff;}
.btn-ghost{background:transparent;color:var(--s500);font-size:13px;margin-top:8px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;align-items:flex-end;justify-content:center;}
.modal.show{display:flex;}
.modal-content{background:var(--bg);border-radius:20px 20px 0 0;padding:20px 16px 32px;width:100%;max-width:430px;max-height:80vh;overflow-y:auto;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.modal-header h3{font-size:16px;font-weight:800;}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--s100);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;font-size:16px;}
.loading{text-align:center;padding:60px;color:var(--s400);}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}
.pet-entry{background:var(--card);border:1.5px solid var(--s200);border-radius:14px;padding:14px;margin-bottom:12px;}
.pet-entry-header{font-size:13px;font-weight:800;color:var(--teal-d);margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.pet-entry .form-input,.pet-entry .form-select{margin-bottom:8px;}
.relation-locked{display:inline-block;padding:8px 14px;border-radius:12px;font-size:13px;font-weight:700;background:var(--s100);color:var(--s500);margin-bottom:16px;}
.hint-text{font-size:10px;color:var(--s400);margin-top:-4px;margin-bottom:8px;}
</style>
</head>
<body>

<div class="header"><h1>âš™ï¸ è¨­å®š</h1></div>

<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">âš™ï¸</div>
  <div>èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="content" style="display:none;">
  <div class="section">
    <div class="section-title">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
    <div class="card">
      <div class="list-item" onclick="openModal('profileModal')">
        <div class="list-ico" style="background:#EDE9FE;">ğŸ‘¤</div>
        <div class="list-body"><div class="lt">å€‹äººæƒ…å ±</div><div class="lb" id="profileSummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
    </div>
  </div>
  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ¾ ãƒšãƒƒãƒˆãƒ»å®¶æ—</div>
    <div class="card">
      <div class="list-item" onclick="openPetModal()">
        <div class="list-ico" style="background:var(--teal-l);">ğŸ¾</div>
        <div class="list-body"><div class="lt">ãƒšãƒƒãƒˆæƒ…å ±ç·¨é›†</div><div class="lb" id="petSummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
      <div class="list-item" onclick="openModal('areaModal')">
        <div class="list-ico" style="background:var(--amber-l);">ğŸ“</div>
        <div class="list-body"><div class="lt">åœ°åŸŸå¤‰æ›´</div><div class="lb" id="areaSummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
      <div class="list-item" onclick="openFamily()">
        <div class="list-ico" style="background:var(--rose-l);">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦</div>
        <div class="list-body"><div class="lt">å®¶æ—ç®¡ç†</div><div class="lb" id="familySummary">-</div></div>
        <div class="list-arr">â€º</div>
      </div>
    </div>
  </div>
</div>

<div class="footer">PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.3.2 Beta<br>Â© 2026 PawBon Inc.</div>

<!-- ===== å€‹äººæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ‘¤ å€‹äººæƒ…å ±</h3>
      <button class="modal-close" onclick="closeModal('profileModal')">âœ•</button>
    </div>
    <label class="form-label">ãŠåå‰</label>
    <input class="form-input" id="editDisplayName" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒ">
    <label class="form-label">ç¶šæŸ„</label>
    <div id="relationArea"></div>
    <button class="btn btn-primary" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('profileModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ===== ãƒšãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="petModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ¾ ãƒšãƒƒãƒˆæƒ…å ±ç·¨é›†</h3>
      <button class="modal-close" onclick="closeModal('petModal')">âœ•</button>
    </div>
    <label class="form-label">ğŸ”¢ ä½•åŒ¹é£¼ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ</label>
    <div class="choice-grid" id="editCountGrid">
      <div class="choice-btn" onclick="selectEditCount(this,1)">1åŒ¹</div>
      <div class="choice-btn" onclick="selectEditCount(this,2)">2åŒ¹</div>
      <div class="choice-btn" onclick="selectEditCount(this,3)">3åŒ¹</div>
      <div class="choice-btn" onclick="selectEditCount(this,4)">4åŒ¹+</div>
    </div>
    <div id="petEntriesContainer"></div>
    <button class="btn btn-primary" onclick="savePetInfo()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('petModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ===== åœ°åŸŸå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="areaModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“ åœ°åŸŸå¤‰æ›´</h3>
      <button class="modal-close" onclick="closeModal('areaModal')">âœ•</button>
    </div>
    <label class="form-label">éƒ½é“åºœçœŒ</label>
    <select class="form-select" id="editArea" onchange="onEditAreaChange()">
      <option value="">é¸æŠ</option>
      <option>åŒ—æµ·é“</option><option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option>
      <option>å¤§é˜ªåºœ</option><option>æ„›çŸ¥çœŒ</option><option>ç¦å²¡çœŒ</option>
      <option>ãã®ä»–</option>
    </select>
    <div id="editDetailGroup" style="display:none;">
      <label class="form-label">å¸‚åŒºç”ºæ‘</label>
      <select class="form-select" id="editAreaDetail">
        <option value="">é¸æŠ</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="saveArea()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('areaModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
var SUPA_URL = PAWBON_CONFIG.SUPABASE_URL;
var SUPA_KEY = PAWBON_CONFIG.SUPABASE_KEY;
var lineId = '';
var userData = null;
var editPetCount = 1;
var editRelation = '';

var breedOptions = {
  dog: ['æŸ´çŠ¬','ãƒˆã‚¤ãƒ—ãƒ¼ãƒ‰ãƒ«','ãƒãƒ¯ãƒ¯','ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ¬ãƒˆãƒªãƒãƒ¼','ãƒ•ãƒ¬ãƒ³ãƒãƒ–ãƒ«ãƒ‰ãƒƒã‚°','ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒ€ãƒƒã‚¯ã‚¹','ãƒãƒ¡ãƒ©ãƒ‹ã‚¢ãƒ³','ã‚³ãƒ¼ã‚®ãƒ¼','MIX','ãã®ä»–'],
  cat: ['ã‚¹ã‚³ãƒ†ã‚£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ãƒãƒ³ãƒã‚«ãƒ³','ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚·ãƒ§ãƒ¼ãƒˆãƒ˜ã‚¢','ãƒ©ã‚°ãƒ‰ãƒ¼ãƒ«','MIX','ãã®ä»–'],
  other: ['ã†ã•ã','ãƒãƒ ã‚¹ã‚¿ãƒ¼','ãƒ•ã‚§ãƒ¬ãƒƒãƒˆ','é³¥','ãã®ä»–']
};

// â•â•â• Supabase â•â•â•
function supaGet(path) {
  return fetch(SUPA_URL + '/rest/v1/' + path, {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  }).then(function(r){ return r.json(); });
}
function supaPatch(table, query, data) {
  return fetch(SUPA_URL + '/rest/v1/' + table + '?' + query, {
    method: 'PATCH',
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
    body: JSON.stringify(data)
  });
}

// â•â•â• LIFF â•â•â•
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.settings });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) {
    try {
      var latest = await supaGet('pet_families?order=registered_at.desc&limit=1');
      if (latest && latest.length > 0) lineId = latest[0].owner_line_id;
    } catch (e2) {}
  }
  loadSettings();
}
initLiff();

// â•â•â• Load â•â•â•
async function loadSettings() {
  try {
    var families = await supaGet('pet_families?owner_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
    var role = 'owner';
    var family = null;
    var myMember = null;

    if (families && families.length > 0) {
      family = families[0];
    } else {
      var members = await supaGet('family_members?member_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
      if (members && members.length > 0) {
        role = 'member';
        myMember = members[0];
        var fam = await supaGet('pet_families?family_code=eq.' + encodeURIComponent(members[0].family_code) + '&limit=1');
        if (fam && fam.length > 0) family = fam[0];
      }
    }

    if (!family) {
      document.getElementById('loading').innerHTML =
        '<div style="font-size:40px;margin-bottom:12px;">ğŸ“</div><div>æœªç™»éŒ²ã§ã™ã€‚å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</div>';
      return;
    }

    if (!myMember) {
      var myMs = await supaGet('family_members?member_line_id=eq.' + encodeURIComponent(lineId) + '&family_code=eq.' + encodeURIComponent(family.family_code) + '&limit=1');
      if (myMs && myMs.length > 0) myMember = myMs[0];
    }

    var allMembers = await supaGet('family_members?family_code=eq.' + encodeURIComponent(family.family_code) + '&order=registered_at.asc');

    userData = {
      role: role,
      familyCode: family.family_code,
      petNames: family.pet_names,
      breeds: family.breeds || '',
      petCount: family.pet_count,
      area: family.area,
      areaDetail: family.area_detail || '',
      familyMembers: allMembers || [],
      myMember: myMember
    };
    renderSettings();
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<div style="font-size:40px;margin-bottom:12px;">âŒ</div><div>ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
  }
}

// â•â•â• Render â•â•â•
function renderSettings() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('content').style.display = 'block';

  var myName = userData.myMember ? userData.myMember.display_name : '-';
  var myRel = userData.myMember ? userData.myMember.relation : '-';
  document.getElementById('profileSummary').textContent = myName + 'ï¼ˆ' + myRel + 'ï¼‰';

  // ãƒšãƒƒãƒˆã‚µãƒãƒªãƒ¼ï¼šåå‰ãƒªã‚¹ãƒˆè¡¨ç¤º
  var nameList = userData.petNames.split(',').map(function(s){ return s.trim(); }).filter(Boolean);
  document.getElementById('petSummary').textContent = nameList.join('ã€') + 'ï¼ˆ' + userData.petCount + 'åŒ¹ï¼‰';
  document.getElementById('areaSummary').textContent = userData.area + ' ' + (userData.areaDetail || '');
  var memCount = userData.familyMembers ? userData.familyMembers.length : 0;
  document.getElementById('familySummary').textContent = memCount + 'äººç™»éŒ²æ¸ˆã¿ Â· ã‚³ãƒ¼ãƒ‰: ' + userData.familyCode;

  // Profile defaults
  document.getElementById('editDisplayName').value = myName !== '-' ? myName : '';
  editRelation = myRel !== '-' ? myRel : '';

  // ç¶šæŸ„ã‚¨ãƒªã‚¢ï¼šã‚ªãƒ¼ãƒŠãƒ¼ã¯ãƒ­ãƒƒã‚¯ / ãã‚Œä»¥å¤–ã¯é¸æŠ
  var relationArea = document.getElementById('relationArea');
  if (userData.role === 'owner') {
    relationArea.innerHTML = '<div class="relation-locked">ğŸ  ã‚ªãƒ¼ãƒŠãƒ¼ï¼ˆå¤‰æ›´ä¸å¯ï¼‰</div>';
    editRelation = 'ã‚ªãƒ¼ãƒŠãƒ¼';
  } else {
    relationArea.innerHTML =
      '<div class="choice-grid" id="editRelationGrid">' +
        '<div class="choice-btn" onclick="selectRelation(this,\'ãƒ‘ãƒ‘\')">ğŸ‘¨ ãƒ‘ãƒ‘</div>' +
        '<div class="choice-btn" onclick="selectRelation(this,\'ãƒãƒ\')">ğŸ‘© ãƒãƒ</div>' +
        '<div class="choice-btn" onclick="selectRelation(this,\'ãŠã˜ã„ã¡ã‚ƒã‚“\')">ğŸ‘´ ãŠã˜ã„ã¡ã‚ƒã‚“</div>' +
        '<div class="choice-btn" onclick="selectRelation(this,\'ãŠã°ã‚ã¡ã‚ƒã‚“\')">ğŸ‘µ ãŠã°ã‚ã¡ã‚ƒã‚“</div>' +
        '<div class="choice-btn" onclick="selectRelation(this,\'å®¶æ—\')">ğŸ‘¥ å®¶æ—</div>' +
      '</div>';
    document.querySelectorAll('#editRelationGrid .choice-btn').forEach(function(b) {
      if (editRelation && b.textContent.indexOf(editRelation) !== -1) b.classList.add('selected');
    });
  }

  // Area defaults
  document.getElementById('editArea').value = userData.area;
  onEditAreaChange();
  document.getElementById('editAreaDetail').value = userData.areaDetail || '';
}

// â•â•â• Modal â•â•â•
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// â•â•â• Profile â•â•â•
function selectRelation(el, val) {
  document.querySelectorAll('#editRelationGrid .choice-btn').forEach(function(b){ b.classList.remove('selected'); });
  el.classList.add('selected');
  editRelation = val;
}

async function saveProfile() {
  var name = document.getElementById('editDisplayName').value.trim();
  if (!name) { alert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!userData.myMember) { alert('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  try {
    await supaPatch('family_members',
      'member_line_id=eq.' + encodeURIComponent(lineId) + '&family_code=eq.' + encodeURIComponent(userData.familyCode),
      { display_name: name, relation: editRelation || userData.myMember.relation }
    );
    closeModal('profileModal');
    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
    loadSettings();
  } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

// â•â•â• Pet Modal â•â•â•
function openPetModal() {
  openModal('petModal');
  // ç¾åœ¨ã®æ•°ã‚’ã‚»ãƒƒãƒˆ
  editPetCount = userData.petCount;
  document.querySelectorAll('#editCountGrid .choice-btn').forEach(function(b, i) {
    b.classList.remove('selected');
    if (i + 1 === editPetCount || (i === 3 && editPetCount >= 4)) b.classList.add('selected');
  });
  renderPetEntries();
}

function selectEditCount(el, n) {
  document.querySelectorAll('#editCountGrid .choice-btn').forEach(function(b){ b.classList.remove('selected'); });
  el.classList.add('selected');
  editPetCount = n;
  renderPetEntries();
}

function renderPetEntries() {
  var container = document.getElementById('petEntriesContainer');
  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
  var existingNames = userData.petNames.split(',').map(function(s){ return s.trim(); });
  var existingBreeds = userData.breeds.split(',').map(function(s){ return s.trim(); });
  var count = editPetCount;
  var html = '';

  for (var i = 0; i < count; i++) {
    var petNum = i + 1;
    var curName = existingNames[i] || '';
    var curBreed = existingBreeds[i] || '';

    html += '<div class="pet-entry">';
    html += '<div class="pet-entry-header">ğŸ¾ ãƒšãƒƒãƒˆ ' + petNum + '</div>';

    // åå‰
    html += '<label class="form-label">ãŠåå‰</label>';
    html += '<input class="form-input" id="petName_' + i + '" placeholder="ä¾‹ï¼šãƒãƒ§ã‚³" value="' + escapeAttr(curName) + '">';

    // ç¨®é¡
    html += '<label class="form-label">ç¨®é¡</label>';
    html += '<div class="choice-grid" id="speciesGrid_' + i + '">';
    html += '<div class="choice-btn" onclick="selectPetSpecies(' + i + ',this,\'dog\')">ğŸ• çŠ¬</div>';
    html += '<div class="choice-btn" onclick="selectPetSpecies(' + i + ',this,\'cat\')">ğŸˆ çŒ«</div>';
    html += '<div class="choice-btn" onclick="selectPetSpecies(' + i + ',this,\'other\')">ğŸ¾ ãã®ä»–</div>';
    html += '</div>';

    // å“ç¨®
    html += '<div id="breedGroup_' + i + '" style="display:none;">';
    html += '<label class="form-label">å“ç¨®</label>';
    html += '<select class="form-select" id="breed_' + i + '"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>';
    html += '</div>';

    html += '</div>';
  }

  container.innerHTML = html;

  // æ—¢å­˜å“ç¨®ãŒã‚ã‚‹å ´åˆã¯å¾©å…ƒ
  for (var j = 0; j < count; j++) {
    var breed = existingBreeds[j] || '';
    if (breed) {
      // å“ç¨®ã‹ã‚‰ç¨®é¡ã‚’æ¨å®š
      var species = guessSpecies(breed);
      if (species) {
        var btns = document.querySelectorAll('#speciesGrid_' + j + ' .choice-btn');
        btns.forEach(function(b) {
          if ((species === 'dog' && b.textContent.indexOf('çŠ¬') !== -1) ||
              (species === 'cat' && b.textContent.indexOf('çŒ«') !== -1) ||
              (species === 'other' && b.textContent.indexOf('ãã®ä»–') !== -1)) {
            b.classList.add('selected');
          }
        });
        populateBreedSelect(j, species, breed);
      }
    }
  }
}

function guessSpecies(breed) {
  if (breedOptions.dog.indexOf(breed) !== -1) return 'dog';
  if (breedOptions.cat.indexOf(breed) !== -1) return 'cat';
  if (breedOptions.other.indexOf(breed) !== -1) return 'other';
  return '';
}

function selectPetSpecies(idx, el, type) {
  document.querySelectorAll('#speciesGrid_' + idx + ' .choice-btn').forEach(function(b){ b.classList.remove('selected'); });
  el.classList.add('selected');
  populateBreedSelect(idx, type, '');
}

function populateBreedSelect(idx, type, current) {
  var sel = document.getElementById('breed_' + idx);
  sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  (breedOptions[type] || []).forEach(function(o) {
    var selected = (o === current) ? ' selected' : '';
    sel.innerHTML += '<option' + selected + '>' + o + '</option>';
  });
  document.getElementById('breedGroup_' + idx).style.display = 'block';
}

async function savePetInfo() {
  var names = [];
  var breeds = [];
  for (var i = 0; i < editPetCount; i++) {
    var name = document.getElementById('petName_' + i).value.trim();
    if (!name) { alert('ãƒšãƒƒãƒˆ ' + (i+1) + ' ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    names.push(name);
    var breed = document.getElementById('breed_' + i);
    breeds.push(breed ? breed.value || '' : '');
  }

  try {
    await supaPatch('pet_families', 'family_code=eq.' + encodeURIComponent(userData.familyCode), {
      pet_names: names.join(', '),
      breeds: breeds.join(', '),
      pet_count: editPetCount
    });
    closeModal('petModal');
    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
    loadSettings();
  } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

// â•â•â• Area â•â•â•
var areaDetails = {
  'åŒ—æµ·é“':['æœ­å¹Œå¸‚','æ—­å·å¸‚','å‡½é¤¨å¸‚','ãã®ä»–'],
  'æ±äº¬éƒ½':['ä¸–ç”°è°·åŒº','æ¸‹è°·åŒº','ç›®é»’åŒº','æ¸¯åŒº','æ–°å®¿åŒº','å“å·åŒº','æ‰ä¸¦åŒº','ç·´é¦¬åŒº','ãã®ä»–'],
  'ç¥å¥ˆå·çœŒ':['æ¨ªæµœå¸‚','å·å´å¸‚','è—¤æ²¢å¸‚','éŒå€‰å¸‚','ãã®ä»–'],
  'å¤§é˜ªåºœ':['å¤§é˜ªå¸‚','å ºå¸‚','è±Šä¸­å¸‚','ãã®ä»–'],
  'æ„›çŸ¥çœŒ':['åå¤å±‹å¸‚','è±Šç”°å¸‚','ãã®ä»–'],
  'ç¦å²¡çœŒ':['ç¦å²¡å¸‚','åŒ—ä¹å·å¸‚','ãã®ä»–']
};

function onEditAreaChange() {
  var area = document.getElementById('editArea').value;
  var sel = document.getElementById('editAreaDetail');
  var group = document.getElementById('editDetailGroup');
  if (!area || !areaDetails[area]) {
    group.style.display = 'none';
    sel.innerHTML = '<option value="">é¸æŠ</option>';
    return;
  }
  sel.innerHTML = '<option value="">é¸æŠ</option>';
  areaDetails[area].forEach(function(a) {
    sel.innerHTML += '<option>' + a + '</option>';
  });
  group.style.display = 'block';
}

async function saveArea() {
  var area = document.getElementById('editArea').value;
  if (!area) { alert('éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  try {
    await supaPatch('pet_families', 'family_code=eq.' + encodeURIComponent(userData.familyCode), {
      area: area, area_detail: document.getElementById('editAreaDetail').value.trim()
    });
    closeModal('areaModal');
    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
    loadSettings();
  } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

// â•â•â• Family â•â•â•
function openFamily() {
  window.location.href = 'https://liff.line.me/' + PAWBON_CONFIG.LIFF_ID.family;
}

// â•â•â• Util â•â•â•
function escapeAttr(s) {
  return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
