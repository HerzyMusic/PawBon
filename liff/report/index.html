<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å…ƒæ°—ãƒ¬ãƒãƒ¼ãƒˆ</title>
<style>
:root{--rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:20px;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.section{padding:16px;}
.stat-row{display:flex;gap:8px;margin-bottom:16px;}
.stat-box{flex:1;background:var(--s100);border-radius:14px;padding:14px 8px;text-align:center;}
.stat-box .sv{font-size:24px;font-weight:900;}
.stat-box .sv.rose{color:var(--rose);}
.stat-box .sv.teal{color:var(--teal-d);}
.stat-box .sv.amber{color:var(--amber);}
.stat-box .sl{font-size:9px;color:var(--s400);margin-top:2px;}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.cal-month{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.cal-month h3{font-size:15px;font-weight:800;}
.cal-month .nav{width:30px;height:30px;border-radius:50%;background:var(--s100);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;border:none;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center;}
.cal-day-label{font-size:9px;font-weight:700;color:var(--s400);padding:4px 0;}
.cal-day{aspect-ratio:1;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--s500);}
.cal-day.genki{background:#DCFCE7;color:var(--teal-d);}
.cal-day.worry{background:#FEF3C7;color:#92400E;}
.cal-day.today{box-shadow:0 0 0 2px var(--rose);}
.cal-legend{display:flex;gap:16px;margin-top:10px;font-size:10px;color:var(--s400);justify-content:center;}
.cal-legend span::before{content:'';display:inline-block;width:10px;height:10px;border-radius:3px;vertical-align:middle;margin-right:4px;}
.cal-legend .g::before{background:#DCFCE7;}
.cal-legend .y::before{background:#FEF3C7;}
.section-title{font-size:13px;font-weight:800;color:var(--s500);margin-bottom:10px;}
.record-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--s100);font-size:13px;}
.record-row:last-child{border:none;}
.record-row .date{color:var(--s500);}
.record-row .status-g{color:var(--teal-d);font-weight:700;}
.record-row .status-w{color:#92400E;font-weight:700;}
.region{display:flex;align-items:center;gap:10px;background:var(--teal-l);border-radius:14px;padding:12px 14px;margin-bottom:16px;}
.region .num{font-size:24px;font-weight:900;color:var(--teal-d);}
.region .txt{font-size:11px;color:var(--s500);line-height:1.4;}
.loading{text-align:center;padding:60px 20px;color:var(--s400);}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ“Š å…ƒæ°—ãƒ¬ãƒãƒ¼ãƒˆ</h1>
</div>

<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">ğŸ“Š</div>
  <div>èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="content" style="display:none;">
  <!-- Stats -->
  <div class="section">
    <div class="stat-row">
      <div class="stat-box"><div class="sv rose" id="totalDays">-</div><div class="sl">ãƒˆãƒ¼ã‚¿ãƒ«æ—¥æ•°</div></div>
      <div class="stat-box"><div class="sv teal" id="streak">-</div><div class="sl">é€£ç¶šæ—¥æ•° ğŸ”¥</div></div>
      <div class="stat-box"><div class="sv amber" id="healthRate">-</div><div class="sl">å…ƒæ°—ç‡</div></div>
    </div>
    
    <div class="region">
      <div class="num" id="regionCount">-</div>
      <div class="txt">åŒ¹ãŒ<span id="regionArea">åœ°åŸŸ</span>ã§<br>ä»Šæ—¥å…ƒæ°—ã§ã™ ğŸ˜ï¸</div>
    </div>
  </div>

  <!-- Calendar -->
  <div class="section" style="padding-top:0;">
    <div class="card">
      <div class="cal-month">
        <button class="nav" onclick="changeMonth(-1)">â€¹</button>
        <h3 id="calTitle">ğŸ“… 2026å¹´2æœˆ</h3>
        <button class="nav" onclick="changeMonth(1)">â€º</button>
      </div>
      <div class="cal-days" id="calGrid"></div>
      <div class="cal-legend">
        <span class="g">å…ƒæ°—</span>
        <span class="y">å¿ƒé…</span>
      </div>
    </div>
  </div>

  <!-- Recent History -->
  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ“‹ æœ€è¿‘ã®ãƒã‚§ãƒƒã‚¯å±¥æ­´</div>
    <div class="card" id="historyList" style="padding:0 16px;">
      <!-- JSç”Ÿæˆ -->
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const GAS_URL = 'https://aaa.gashi.workers.dev/';
let lineId = '';
let reportData = null;
let currentYear = 2026, currentMonth = 2;

async function initLiff() {
  try {
    await liff.init({ liffId: '2009150735-xVqRCfBp' });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) { lineId = 'debug_user'; }
  loadReport();
}
initLiff();

async function loadReport() {
  try {
    const res = await fetch(GAS_URL + '?action=getReport&lineId=' + lineId);
    reportData = await res.json();
    
    if (reportData.error) {
      document.getElementById('loading').innerHTML = '<div style="font-size:40px;margin-bottom:12px;">ğŸ“</div><div>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    
    renderReport();
  } catch (e) {
    // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    reportData = {
      petNames:'ãƒãƒ§ã‚³, ãƒ¢ã‚«, ãƒ©ãƒ†', totalDays:847, streak:32, healthRate:96,
      regionCount:143, familyCode:'P-8472',
      records: Array.from({length:30}, (_, i) => ({
        date: `2026-02-${String(17-i).padStart(2,'0')}`,
        status: Math.random() > 0.1 ? 'genki' : 'worry',
        worriedPets: 'ãƒ¢ã‚«', symptoms: 'é£Ÿæ¬²ãªã—'
      }))
    };
    renderReport();
  }
}

function renderReport() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('content').style.display = 'block';
  
  document.getElementById('totalDays').textContent = reportData.totalDays;
  document.getElementById('streak').textContent = reportData.streak;
  document.getElementById('healthRate').textContent = reportData.healthRate + '%';
  document.getElementById('regionCount').textContent = reportData.regionCount || '-';
  
  const now = new Date();
  currentYear = now.getFullYear();
  currentMonth = now.getMonth() + 1;
  renderCalendar();
  renderHistory();
}

function renderCalendar() {
  document.getElementById('calTitle').textContent = `ğŸ“… ${currentYear}å¹´${currentMonth}æœˆ`;
  
  const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
  const offset = firstDay === 0 ? 6 : firstDay - 1;
  const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
  const todayD = new Date().getDate();
  const todayM = new Date().getMonth() + 1;
  const todayY = new Date().getFullYear();
  
  // è¨˜éŒ²ã‚’dateã§ãƒãƒƒãƒ”ãƒ³ã‚°
  const dateMap = {};
  if (reportData && reportData.records) {
    reportData.records.forEach(r => {
      dateMap[r.date] = r.status;
    });
  }
  
  let html = '<div class="cal-day-label">æœˆ</div><div class="cal-day-label">ç«</div><div class="cal-day-label">æ°´</div><div class="cal-day-label">æœ¨</div><div class="cal-day-label">é‡‘</div><div class="cal-day-label">åœŸ</div><div class="cal-day-label">æ—¥</div>';
  
  for (let i = 0; i < offset; i++) html += '<div class="cal-day"></div>';
  
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const status = dateMap[dateStr];
    let cls = 'cal-day';
    if (status === 'genki') cls += ' genki';
    else if (status === 'worry') cls += ' worry';
    if (d === todayD && currentMonth === todayM && currentYear === todayY) cls += ' today';
    html += `<div class="${cls}">${d}</div>`;
  }
  
  document.getElementById('calGrid').innerHTML = html;
}

function changeMonth(d) {
  currentMonth += d;
  if (currentMonth > 12) { currentMonth = 1; currentYear++; }
  if (currentMonth < 1) { currentMonth = 12; currentYear--; }
  renderCalendar();
}

function renderHistory() {
  if (!reportData || !reportData.records) return;
  
  const weekdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  
  document.getElementById('historyList').innerHTML = reportData.records.slice(0, 14).map(r => {
    const d = new Date(r.date);
    const dayLabel = `${d.getMonth()+1}/${d.getDate()}ï¼ˆ${weekdays[d.getDay()]}ï¼‰`;
    
    if (r.status === 'genki') {
      return `<div class="record-row"><span class="date">${dayLabel}</span><span class="status-g">âœ… å…¨å“¡å…ƒæ°—</span></div>`;
    } else {
      return `<div class="record-row"><span class="date">${dayLabel}</span><span class="status-w">âš ï¸ ${r.worriedPets || 'å¿ƒé…'}${r.symptoms ? 'ï¼ˆ'+r.symptoms+')' : ''}</span></div>`;
    }
  }).join('');
}
</script>
</body>
</html>
