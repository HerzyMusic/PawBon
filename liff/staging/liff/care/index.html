<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å®¶æ—ã®ã‚±ã‚¢</title>
<style>
:root{--rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:80px;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}

/* ã‚¿ãƒ– */
.tabs{display:flex;background:var(--card);border-bottom:1px solid var(--s200);}
.tab{flex:1;padding:12px 0;text-align:center;font-size:13px;font-weight:700;color:var(--s400);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;}
.tab.active{color:var(--teal-d);border-bottom-color:var(--teal);}

/* å…±é€š */
.section{padding:16px;}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.section-title{font-size:13px;font-weight:800;color:var(--s500);margin-bottom:10px;}
.loading{text-align:center;padding:60px 20px;color:var(--s400);}

/* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ */
@keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
.sk{border-radius:10px;background:linear-gradient(90deg,var(--s100) 25%,var(--s200) 50%,var(--s100) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;}
.sk-status{height:60px;border-radius:16px;margin-bottom:12px;}
.sk-stat{height:58px;border-radius:14px;}
.sk-grid-item{height:56px;border-radius:12px;}
.sk-line{height:14px;margin-bottom:8px;}
.sk-line.w60{width:60%;}
.sk-line.w40{width:40%;}

/* ã‚±ã‚¢ãƒœãƒ¼ãƒ‰ */
.checkin-status{padding:16px;border-radius:16px;margin-bottom:12px;text-align:center;font-weight:700;}
.checkin-status.done{background:#DCFCE7;color:var(--teal-d);}
.checkin-status.pending{background:var(--amber-l);color:#92400E;}
.checkin-status .big{font-size:18px;margin-bottom:4px;}
.checkin-status .sub{font-size:12px;font-weight:400;}

.stat-row{display:flex;gap:8px;margin-bottom:16px;}
.stat-box{flex:1;background:var(--s100);border-radius:14px;padding:14px 8px;text-align:center;}
.stat-box .sv{font-size:24px;font-weight:900;}
.stat-box .sv.rose{color:var(--rose);}
.stat-box .sv.teal{color:var(--teal-d);}
.stat-box .sv.amber{color:var(--amber);}
.stat-box .sl{font-size:9px;color:var(--s400);margin-top:2px;}

/* ã‚±ã‚¢ã‚°ãƒªãƒƒãƒ‰ â€” ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åŒ– */
.care-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;}
.care-item{background:var(--s100);border-radius:12px;padding:10px 4px;text-align:center;font-size:11px;font-weight:600;color:var(--s500);cursor:pointer;transition:background .15s,transform .1s;position:relative;-webkit-user-select:none;user-select:none;}
.care-item:active{transform:scale(.93);background:var(--teal-l);}
.care-item .icon{font-size:22px;margin-bottom:4px;}
.care-item .count{font-size:16px;font-weight:900;color:var(--teal-d);}
.care-item.has-log{background:var(--teal-l);}
.care-item.has-log .count{color:var(--teal-d);}
.care-item .badge{position:absolute;top:4px;right:4px;min-width:18px;height:18px;border-radius:9px;background:var(--teal);color:#fff;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;padding:0 4px;}

/* CTAã‚«ãƒ¼ãƒ‰ â€” 0ä»¶æ™‚è¡¨ç¤º */
.cta-card{background:linear-gradient(135deg,var(--teal),var(--teal-d));border-radius:16px;padding:20px;margin-bottom:16px;text-align:center;color:#fff;}
.cta-card .cta-title{font-size:16px;font-weight:800;margin-bottom:4px;}
.cta-card .cta-sub{font-size:12px;opacity:.85;margin-bottom:14px;}
.cta-card .cta-btn{display:inline-block;width:100%;padding:12px;border:none;border-radius:12px;background:rgba(255,255,255,.95);color:var(--teal-d);font-size:14px;font-weight:800;cursor:pointer;transition:background .15s;}
.cta-card .cta-btn:active{background:rgba(255,255,255,.75);}

/* 0ä»¶ã‚¨ãƒ³ãƒ—ãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ãƒˆ */
.empty-care-msg{text-align:center;padding:16px;color:var(--s400);font-size:13px;line-height:1.6;}

/* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
.tl-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--s100);}
.tl-item:last-child{border:none;}
.tl-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.tl-icon.care{background:var(--teal-l);}
.tl-icon.genki{background:#DCFCE7;}
.tl-icon.worry{background:#FEF3C7;}
.tl-body{flex:1;min-width:0;}
.tl-title{font-size:13px;font-weight:700;}
.tl-meta{font-size:11px;color:var(--s400);margin-top:2px;}
.tl-memo{font-size:11px;color:var(--s500);margin-top:4px;padding:6px 8px;background:var(--s100);border-radius:8px;}

/* FAB â€” ãƒ”ãƒ«å‹ãƒ†ã‚­ã‚¹ãƒˆä»˜ãã€ä¸­å¤®ä¸‹é…ç½® */
.fab{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);height:52px;width:auto;padding:0 28px;border-radius:26px;background:var(--teal);color:#fff;border:none;font-size:15px;font-weight:800;box-shadow:0 4px 16px rgba(46,205,167,.45);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;z-index:100;white-space:nowrap;}
.fab:active{transform:translateX(-50%) scale(.94);}
.fab.pulse{animation:fabPulse 2s ease-in-out 3;}
@keyframes fabPulse{0%,100%{box-shadow:0 4px 16px rgba(46,205,167,.45);}50%{box-shadow:0 4px 24px rgba(46,205,167,.7),0 0 0 8px rgba(46,205,167,.15);}}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--card);width:100%;max-width:480px;border-radius:20px 20px 0 0;padding:20px;max-height:85vh;overflow-y:auto;}
.modal-title{font-size:16px;font-weight:800;margin-bottom:16px;text-align:center;}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;font-size:20px;cursor:pointer;color:var(--s400);}

.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:6px;margin-top:14px;}
.pet-select{display:flex;flex-wrap:wrap;gap:8px;}
.pet-chip{padding:8px 16px;border-radius:20px;font-size:13px;font-weight:700;background:var(--s100);color:var(--s500);border:2px solid transparent;cursor:pointer;transition:all .2s;}
.pet-chip.selected{background:var(--teal-l);color:var(--teal-d);border-color:var(--teal);}
.care-select{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.care-chip{padding:10px 4px;border-radius:12px;text-align:center;font-size:11px;font-weight:600;background:var(--s100);color:var(--s500);border:2px solid transparent;cursor:pointer;transition:all .2s;}
.care-chip .icon{font-size:20px;display:block;margin-bottom:2px;}
.care-chip.selected{background:var(--teal-l);color:var(--teal-d);border-color:var(--teal);}
.form-input{width:100%;padding:10px 12px;border:1px solid var(--s200);border-radius:10px;font-size:14px;margin-top:4px;outline:none;}
.form-input:focus{border-color:var(--teal);}
.btn-submit{width:100%;padding:14px;border:none;border-radius:14px;background:var(--teal);color:#fff;font-size:15px;font-weight:800;cursor:pointer;margin-top:20px;}
.btn-submit:disabled{background:var(--s200);color:var(--s400);cursor:not-allowed;}
.btn-submit:not(:disabled):active{background:var(--teal-d);}

.member-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.member-tag{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;background:var(--s100);color:var(--s500);}

.empty-state{text-align:center;padding:30px 16px;color:var(--s400);}
.empty-state .icon{font-size:48px;margin-bottom:12px;}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ¾ å®¶æ—ã®ã‚±ã‚¢</h1>
  <p id="headerSub">èª­ã¿è¾¼ã¿ä¸­...</p>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('board')">ğŸ“‹ ã‚±ã‚¢ãƒœãƒ¼ãƒ‰</div>
  <div class="tab" onclick="switchTab('timeline')">ğŸ“… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
</div>

<!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ï¼ˆåˆå›è¡¨ç¤ºç”¨ï¼‰ -->
<div id="skeleton" class="section">
  <div class="sk sk-status"></div>
  <div class="stat-row">
    <div class="sk sk-stat" style="flex:1;"></div>
    <div class="sk sk-stat" style="flex:1;"></div>
    <div class="sk sk-stat" style="flex:1;"></div>
  </div>
  <div class="sk sk-line w60"></div>
  <div class="care-grid">
    <div class="sk sk-grid-item"></div><div class="sk sk-grid-item"></div>
    <div class="sk sk-grid-item"></div><div class="sk sk-grid-item"></div>
    <div class="sk sk-grid-item"></div><div class="sk sk-grid-item"></div>
    <div class="sk sk-grid-item"></div>
  </div>
</div>

<!-- ===== ã‚±ã‚¢ãƒœãƒ¼ãƒ‰ ===== -->
<div id="boardView" style="display:none;">
  <div class="section">
    <!-- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³çŠ¶æ³ -->
    <div id="checkinStatus" class="checkin-status pending">
      <div class="big">â³ ã¾ã ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã›ã‚“</div>
      <div class="sub">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å…ƒæ°—ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†</div>
    </div>

    <!-- çµ±è¨ˆ -->
    <div class="stat-row">
      <div class="stat-box"><div class="sv rose" id="totalDays">0</div><div class="sl">ãƒˆãƒ¼ã‚¿ãƒ«æ—¥æ•°</div></div>
      <div class="stat-box"><div class="sv teal" id="streak">0</div><div class="sl">é€£ç¶šæ—¥æ•° ğŸ”¥</div></div>
      <div class="stat-box"><div class="sv amber" id="healthRate">-</div><div class="sl">å…ƒæ°—ç‡</div></div>
    </div>

    <!-- ãƒ¡ãƒ³ãƒãƒ¼ -->
    <div id="memberSection" style="display:none;">
      <div class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼</div>
      <div id="memberList" class="member-list"></div>
    </div>

    <!-- CTAã‚«ãƒ¼ãƒ‰ï¼ˆ0ä»¶æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div id="ctaCard" class="cta-card" style="display:none;">
      <div class="cta-title">ğŸ“ ã‚±ã‚¢ã‚’è¨˜éŒ²ã—ã‚ˆã†</div>
      <div class="cta-sub">ã‚¿ãƒƒãƒ—ã—ã¦ãŠä¸–è©±ã‚’è¨˜éŒ²</div>
      <button class="cta-btn" onclick="openModal()">ğŸ“ è¨˜éŒ²ã™ã‚‹</button>
    </div>

    <!-- ä»Šæ—¥ã®ã‚±ã‚¢ -->
    <div class="section-title">ğŸ“‹ ä»Šæ—¥ã®ã‚±ã‚¢</div>
    <div id="careGrid" class="care-grid"></div>
    <div id="emptyCareMsg" class="empty-care-msg" style="display:none;"></div>

    <!-- ä»Šæ—¥ã®ã‚±ã‚¢è©³ç´° -->
    <div id="todayCareList" class="card" style="padding:0 16px;display:none;"></div>
  </div>
</div>

<!-- ===== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ ===== -->
<div id="timelineView" style="display:none;">
  <div class="section">
    <div class="section-title">ğŸ“… ç›´è¿‘7æ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</div>
    <div id="timelineList" class="card" style="padding:0 16px;"></div>
  </div>
</div>

<!-- FAB â€” ãƒ”ãƒ«å‹ãƒ†ã‚­ã‚¹ãƒˆä»˜ã -->
<button class="fab pulse" id="fabBtn" onclick="openModal()">ğŸ“ è¨˜éŒ²ã™ã‚‹</button>

<!-- è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="modal">
  <div class="modal" style="position:relative;">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <div class="modal-title">ğŸ“ ã‚±ã‚¢è¨˜éŒ²</div>

    <div class="form-label">ğŸ¾ ãƒšãƒƒãƒˆã‚’é¸æŠ</div>
    <div id="modalPets" class="pet-select"></div>

    <div class="form-label">ã‚±ã‚¢ã®ç¨®é¡</div>
    <div id="modalCareTypes" class="care-select"></div>

    <div class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
    <input type="text" id="modalMemo" class="form-input" placeholder="ä¾‹: 30åˆ†ã‚³ãƒ¼ã‚¹ã€å…¬åœ’ã§">

    <button class="btn-submit" id="btnSubmit" disabled onclick="submitCare()">è¨˜éŒ²ã™ã‚‹</button>
    <div id="submitMsg" style="text-align:center;font-size:12px;margin-top:8px;color:var(--s400);"></div>
  </div>
</div>

<div class="footer">PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.5.0 Beta<br>&copy; 2026 PawBon Inc.</div>

<script src="../config.js"></script>
<script>
var API_BASE = PAWBON_CONFIG.API_BASE;
var CACHE_KEY = 'pawbon_care_board';
var CACHE_ID_KEY = 'pawbon_line_id';
var lineId = '';
var boardData = null;
var timelineData = null;
var selectedPet = '';
var selectedCare = '';

var CARE_TYPES = [
  { id: 'walk',     icon: 'ğŸ•', label: 'ãŠæ•£æ­©' },
  { id: 'feed',     icon: 'ğŸ½ï¸', label: 'ã”ã¯ã‚“' },
  { id: 'medicine', icon: 'ğŸ’Š', label: 'ãŠè–¬' },
  { id: 'bath',     icon: 'ğŸ›', label: 'ãŠé¢¨å‘‚' },
  { id: 'vet',      icon: 'ğŸ¥', label: 'ç—…é™¢' },
  { id: 'groom',    icon: 'âœ‚ï¸', label: 'ãƒˆãƒªãƒŸãƒ³ã‚°' },
  { id: 'other',    icon: 'ğŸ“', label: 'ãã®ä»–' },
];

// â•â•â• é«˜é€ŸåˆæœŸåŒ–ï¼ˆä¸¦è¡Œãƒ­ãƒ¼ãƒ‰ + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰â•â•â•
(function() {
  // 1) ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³æ™‚è¡¨ç¤º / ä»ç¼“å­˜å³æ—¶æ˜¾ç¤º
  var cached = null;
  try {
    var raw = localStorage.getItem(CACHE_KEY);
    if (raw) {
      cached = JSON.parse(raw);
      boardData = cached;
      showBoard();
      renderBoard();
    }
  } catch(e) {}

  // 2) LIFF SDK ã‚’éåŒæœŸãƒ­ãƒ¼ãƒ‰ / å¼‚æ­¥åŠ è½½ LIFF SDK
  var cachedLineId = '';
  try { cachedLineId = localStorage.getItem(CACHE_ID_KEY) || ''; } catch(e) {}

  var apiPromise = null;
  // 3) ã‚­ãƒ£ãƒƒã‚·ãƒ¥ lineId ãŒã‚ã‚Œã° API ã‚’å…ˆè¡Œå‘¼å‡º / æœ‰ç¼“å­˜lineIdåˆ™å…ˆè¡Œè°ƒç”¨API
  if (cachedLineId) {
    apiPromise = fetchBoard(cachedLineId);
  }

  // 4) LIFF SDK ãƒ­ãƒ¼ãƒ‰ + åˆæœŸåŒ–ã‚’ä¸¦è¡Œ / å¹¶è¡ŒåŠ è½½LIFF SDK
  var script = document.createElement('script');
  script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
  script.onload = function() { initLiff(cachedLineId, apiPromise); };
  script.onerror = function() {
    // LIFF SDK ãƒ­ãƒ¼ãƒ‰å¤±æ•— â†’ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
    lineId = cachedLineId || 'debug_user_' + Date.now();
    if (!apiPromise) apiPromise = fetchBoard(lineId);
    apiPromise.then(applyBoardData);
  };
  document.head.appendChild(script);
})();

async function initLiff(cachedLineId, earlyApiPromise) {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.report });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
    // lineId ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ / ç¼“å­˜lineId
    try { localStorage.setItem(CACHE_ID_KEY, lineId); } catch(e) {}
  } catch (e) {
    lineId = cachedLineId || 'debug_user_' + Date.now();
  }

  // lineId ãŒåŒã˜ãªã‚‰å…ˆè¡Œ API ã‚’ä½¿ã† / lineIdç›¸åŒåˆ™å¤ç”¨å…ˆè¡ŒAPI
  if (earlyApiPromise && lineId === cachedLineId) {
    earlyApiPromise.then(applyBoardData);
  } else {
    // lineId ãŒå¤‰ã‚ã£ãŸ â†’ å†å–å¾— / lineIdå˜äº†åˆ™é‡æ–°è·å–
    fetchBoard(lineId).then(applyBoardData);
  }
}

function fetchBoard(id) {
  return fetch(API_BASE + '/api-care-board?lineId=' + encodeURIComponent(id))
    .then(function(r) { return r.json(); });
}

function applyBoardData(json) {
  if (!json.success) {
    document.getElementById('skeleton').innerHTML =
      '<div style="text-align:center;padding:40px 20px;"><div style="font-size:40px;margin-bottom:12px;">ğŸ“</div><div style="color:var(--s400);">æœªç™»éŒ²ã§ã™ã€‚å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</div></div>';
    return;
  }
  boardData = json.data;
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–° / æ›´æ–°ç¼“å­˜
  try { localStorage.setItem(CACHE_KEY, JSON.stringify(boardData)); } catch(e) {}
  showBoard();
  renderBoard();
}

function showBoard() {
  document.getElementById('skeleton').style.display = 'none';
  document.getElementById('boardView').style.display = 'block';
}

// â•â•â• ã‚±ã‚¢ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ï¼ˆè¨˜éŒ²å¾Œã®ãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰â•â•â•
async function loadBoard() {
  try {
    var json = await fetchBoard(lineId);
    applyBoardData(json);
  } catch (e) {
    document.getElementById('skeleton').innerHTML =
      '<div style="text-align:center;padding:40px 20px;"><div style="font-size:40px;margin-bottom:12px;">âŒ</div><div style="color:var(--s400);">ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div></div>';
  }
}

function renderBoard() {
  var d = boardData;
  var petNames = d.petNames || [];

  document.getElementById('headerSub').textContent = petNames.join('ã€') + ' ã®ã‚±ã‚¢çŠ¶æ³';

  // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³çŠ¶æ³
  var csEl = document.getElementById('checkinStatus');
  if (d.checkedInToday) {
    csEl.className = 'checkin-status done';
    var byText = d.checkedBy && d.checkedBy.name ? 'ï¼ˆ' + escapeHtml(d.checkedBy.name) + 'ï¼‰' : '';
    csEl.innerHTML = '<div class="big">âœ… ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯å®Œäº†' + byText + '</div>' +
      '<div class="sub">ã¿ã‚“ãªå…ƒæ°—ã§ã™ã‚ˆï¼</div>';
  } else {
    csEl.className = 'checkin-status pending';
    csEl.innerHTML = '<div class="big">â³ ã¾ã ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã›ã‚“</div>' +
      '<div class="sub">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å…ƒæ°—ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†</div>';
  }

  // çµ±è¨ˆ
  document.getElementById('totalDays').textContent = d.stats.totalDays || 0;
  document.getElementById('streak').textContent = d.stats.streak || 0;
  document.getElementById('healthRate').textContent = (d.stats.healthRate || 0) + '%';

  // ãƒ¡ãƒ³ãƒãƒ¼
  if (d.members && d.members.length > 0) {
    document.getElementById('memberSection').style.display = 'block';
    document.getElementById('memberList').innerHTML = d.members.map(function(m) {
      return '<span class="member-tag">ğŸ‘¤ ' + escapeHtml(m.displayName) + 'ï¼ˆ' + escapeHtml(m.relation) + 'ï¼‰</span>';
    }).join('');
  }

  // ä»Šæ—¥ã®ã‚±ã‚¢ã‚°ãƒªãƒƒãƒ‰ â€” å…¨7ç¨® + ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  var todayLogs = d.todayCareLogs || [];
  var careCounts = {};
  todayLogs.forEach(function(log) {
    careCounts[log.care_type] = (careCounts[log.care_type] || 0) + 1;
  });

  document.getElementById('careGrid').innerHTML = CARE_TYPES.map(function(ct) {
    var count = careCounts[ct.id] || 0;
    var cls = count > 0 ? 'care-item has-log' : 'care-item';
    var badge = count > 0 ? '<span class="badge">' + count + '</span>' : '';
    return '<div class="' + cls + '" onclick="quickCare(\'' + ct.id + '\')">' + badge +
      '<div class="icon">' + ct.icon + '</div>' + ct.label + '</div>';
  }).join('');

  // CTAã‚«ãƒ¼ãƒ‰ â€” ä»Šæ—¥0ä»¶æ™‚ã®ã¿è¡¨ç¤º
  document.getElementById('ctaCard').style.display = todayLogs.length === 0 ? 'block' : 'none';

  // 0ä»¶ã‚¨ãƒ³ãƒ—ãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ãƒˆ
  var emptyEl = document.getElementById('emptyCareMsg');
  if (todayLogs.length === 0) {
    emptyEl.style.display = 'block';
    emptyEl.innerHTML = 'ğŸ¾ ã¾ã ä»Šæ—¥ã®ã‚±ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“<br>ä¸Šã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã—ã‚ˆã†';
  } else {
    emptyEl.style.display = 'none';
    // è¨˜éŒ²ãŒã‚ã‚Œã°FABã®pulseåœæ­¢
    var fab = document.getElementById('fabBtn');
    if (fab) fab.classList.remove('pulse');
  }

  // ä»Šæ—¥ã®ã‚±ã‚¢è©³ç´°
  if (todayLogs.length > 0) {
    var listEl = document.getElementById('todayCareList');
    listEl.style.display = 'block';
    listEl.innerHTML = todayLogs.map(function(log) {
      var ct = CARE_TYPES.find(function(c) { return c.id === log.care_type; });
      var icon = ct ? ct.icon : 'ğŸ“‹';
      var label = ct ? ct.label : log.care_type;
      var time = new Date(log.care_time);
      var timeStr = time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0');
      var byName = log.recorded_by_name ? 'ï¼ˆ' + escapeHtml(log.recorded_by_name) + 'ï¼‰' : '';
      return '<div class="tl-item">' +
        '<div class="tl-icon care">' + icon + '</div>' +
        '<div class="tl-body"><div class="tl-title">' + escapeHtml(log.pet_name) + ' â€” ' + label + '</div>' +
        '<div class="tl-meta">' + timeStr + ' ğŸ‘¤ ' + byName + '</div>' +
        (log.memo ? '<div class="tl-memo">' + escapeHtml(log.memo) + '</div>' : '') +
        '</div></div>';
    }).join('');
  }
}

// â•â•â• ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ â•â•â•
var TL_CACHE_KEY = 'pawbon_care_timeline';

async function loadTimeline() {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³æ™‚è¡¨ç¤º / ä»ç¼“å­˜å³æ—¶æ˜¾ç¤º
  if (!timelineData) {
    try {
      var raw = localStorage.getItem(TL_CACHE_KEY);
      if (raw) { timelineData = JSON.parse(raw); renderTimeline(); }
    } catch(e) {}
  } else {
    renderTimeline();
  }
  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ›´æ–° / åå°æ›´æ–°
  try {
    var res = await fetch(API_BASE + '/api-care-log?lineId=' + encodeURIComponent(lineId) + '&days=7');
    var json = await res.json();
    if (json.success) {
      timelineData = json.data.logs || [];
      try { localStorage.setItem(TL_CACHE_KEY, JSON.stringify(timelineData)); } catch(e) {}
      renderTimeline();
    }
  } catch (e) {
    if (!timelineData) {
      document.getElementById('timelineList').innerHTML =
        '<div style="padding:16px;text-align:center;color:var(--s400);">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
    }
  }
}

function renderTimeline() {
  var list = timelineData || [];
  var el = document.getElementById('timelineList');

  if (list.length === 0) {
    el.innerHTML = '<div style="padding:16px;text-align:center;color:var(--s400);font-size:12px;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  el.innerHTML = list.map(function(item) {
    var time = new Date(item.time);
    var dateStr = (time.getMonth() + 1) + '/' + time.getDate();
    var timeStr = time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0');

    if (item.type === 'care') {
      var ct = CARE_TYPES.find(function(c) { return c.id === item.careType; });
      var icon = ct ? ct.icon : 'ğŸ“‹';
      var label = ct ? ct.label : item.careType;
      var careBy = item.recordedByName ? 'ï¼ˆ' + escapeHtml(item.recordedByName) + 'ï¼‰' : '';
      return '<div class="tl-item">' +
        '<div class="tl-icon care">' + icon + '</div>' +
        '<div class="tl-body"><div class="tl-title">' + escapeHtml(item.petName) + ' â€” ' + label + careBy + '</div>' +
        '<div class="tl-meta">' + dateStr + ' ' + timeStr + '</div>' +
        (item.memo ? '<div class="tl-memo">' + escapeHtml(item.memo) + '</div>' : '') +
        '</div></div>';
    } else {
      // checkin
      var iconClass = item.status === 'genki' ? 'genki' : 'worry';
      var statusIcon = item.status === 'genki' ? 'âœ…' : 'âš ï¸';
      var statusText = item.status === 'genki' ? 'å…¨å“¡å…ƒæ°—' : 'å¿ƒé…';
      if (item.status === 'worry' && item.worriedPets) statusText = item.worriedPets;
      var byText = item.checkedByName ? 'ï¼ˆ' + escapeHtml(item.checkedByName) + 'ï¼‰' : '';
      return '<div class="tl-item">' +
        '<div class="tl-icon ' + iconClass + '">' + statusIcon + '</div>' +
        '<div class="tl-body"><div class="tl-title">å…ƒæ°—ãƒã‚§ãƒƒã‚¯' + byText + '</div>' +
        '<div class="tl-meta">' + dateStr + ' â€” ' + statusText + '</div>' +
        (item.symptoms ? '<div class="tl-memo">' + escapeHtml(item.symptoms) + '</div>' : '') +
        '</div></div>';
    }
  }).join('');
}

// â•â•â• ã‚¿ãƒ–åˆ‡æ›¿ â•â•â•
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(function(el, i) {
    el.classList.toggle('active', (i === 0 && name === 'board') || (i === 1 && name === 'timeline'));
  });
  document.getElementById('boardView').style.display = name === 'board' ? 'block' : 'none';
  document.getElementById('timelineView').style.display = name === 'timeline' ? 'block' : 'none';
  if (name === 'timeline') loadTimeline();
}

// â•â•â• ãƒ¢ãƒ¼ãƒ€ãƒ« â•â•â•
function openModal(presetCareType) {
  if (!boardData) return;
  selectedPet = '';
  selectedCare = '';
  document.getElementById('modalMemo').value = '';
  document.getElementById('submitMsg').textContent = '';
  document.getElementById('btnSubmit').disabled = true;

  // ãƒšãƒƒãƒˆé¸æŠ â€” 1åŒ¹ã®å ´åˆã¯è‡ªå‹•é¸æŠ
  var petNames = boardData.petNames || [];
  document.getElementById('modalPets').innerHTML = petNames.map(function(name) {
    return '<div class="pet-chip" onclick="selectPet(this,\'' + escapeAttr(name) + '\')">' + escapeHtml(name) + '</div>';
  }).join('');
  if (petNames.length === 1) {
    selectedPet = petNames[0];
    var petChip = document.querySelector('.pet-chip');
    if (petChip) petChip.classList.add('selected');
  }

  // ã‚±ã‚¢ã‚¿ã‚¤ãƒ—é¸æŠ â€” presetãŒã‚ã‚Œã°äº‹å‰é¸æŠ
  document.getElementById('modalCareTypes').innerHTML = CARE_TYPES.map(function(ct) {
    var sel = (presetCareType && ct.id === presetCareType) ? ' selected' : '';
    return '<div class="care-chip' + sel + '" onclick="selectCare(this,\'' + ct.id + '\')">' +
      '<span class="icon">' + ct.icon + '</span>' + ct.label + '</div>';
  }).join('');
  if (presetCareType) {
    selectedCare = presetCareType;
  }

  updateSubmitState();
  document.getElementById('modal').classList.add('open');
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚±ã‚¢ â€” ã‚°ãƒªãƒƒãƒ‰ã‹ã‚‰ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
function quickCare(careType) {
  openModal(careType);
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

function selectPet(el, name) {
  selectedPet = name;
  document.querySelectorAll('.pet-chip').forEach(function(c) { c.classList.remove('selected'); });
  el.classList.add('selected');
  updateSubmitState();
}

function selectCare(el, id) {
  selectedCare = id;
  document.querySelectorAll('.care-chip').forEach(function(c) { c.classList.remove('selected'); });
  el.classList.add('selected');
  updateSubmitState();
}

function updateSubmitState() {
  document.getElementById('btnSubmit').disabled = !(selectedPet && selectedCare);
}

async function submitCare() {
  var btn = document.getElementById('btnSubmit');
  var msg = document.getElementById('submitMsg');
  btn.disabled = true;
  msg.textContent = 'é€ä¿¡ä¸­...';

  try {
    var res = await fetch(API_BASE + '/api-care-log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        lineId: lineId,
        petName: selectedPet,
        careType: selectedCare,
        memo: document.getElementById('modalMemo').value.trim(),
      }),
    });
    var json = await res.json();
    if (json.success) {
      msg.style.color = 'var(--teal-d)';
      msg.textContent = 'âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼';
      // FAB pulseåœæ­¢ï¼ˆè¨˜éŒ²æˆåŠŸå¾Œï¼‰
      var fab = document.getElementById('fabBtn');
      if (fab) fab.classList.remove('pulse');
      // ãƒ‡ãƒ¼ã‚¿æ›´æ–° + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
      boardData = null;
      timelineData = null;
      try { localStorage.removeItem(CACHE_KEY); localStorage.removeItem(TL_CACHE_KEY); } catch(e) {}
      setTimeout(function() {
        closeModal();
        loadBoard();
      }, 800);
    } else {
      msg.style.color = 'var(--rose)';
      msg.textContent = 'âŒ ' + (json.error ? json.error.message : 'ã‚¨ãƒ©ãƒ¼');
      btn.disabled = false;
    }
  } catch (e) {
    msg.style.color = 'var(--rose)';
    msg.textContent = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼';
    btn.disabled = false;
  }
}

// â•â•â• Util â•â•â•
function escapeHtml(s) {
  var d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}
function escapeAttr(s) {
  return (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}
</script>
</body>
</html>
