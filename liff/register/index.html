<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” ãƒšãƒƒãƒˆç™»éŒ²</title>
<style>
:root { --rose:#E8475F;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF; }
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}
.progress{display:flex;gap:4px;padding:0 16px;margin-top:12px;}
.progress .dot{flex:1;height:4px;border-radius:2px;background:var(--s200);}
.progress .dot.active{background:var(--teal);}
.section{padding:20px 16px;}
.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:6px;display:block;}
.form-input,.form-select{width:100%;padding:12px 14px;border:1.5px solid var(--s200);border-radius:12px;font-size:14px;background:var(--card);appearance:none;font-family:inherit;margin-bottom:16px;}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--teal);}
.choice-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.choice-btn{padding:10px 16px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;border:1.5px solid var(--s200);background:var(--card);transition:all .15s;}
.choice-btn.selected{border-color:var(--teal);background:var(--teal-l);color:var(--teal-d);}
.btn{display:block;width:100%;padding:14px;border-radius:14px;font-size:15px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-primary{background:linear-gradient(135deg,var(--teal),var(--teal-d));color:#fff;box-shadow:0 4px 16px rgba(46,205,167,.25);}
.btn-outline{background:var(--card);color:var(--s500);border:1.5px solid var(--s200);margin-top:8px;}
.btn:disabled{opacity:.5;cursor:not-allowed;}
.info{padding:12px;border-radius:12px;font-size:12px;text-align:center;background:var(--amber-l);color:var(--orange);margin-top:12px;}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;border:1.5px solid var(--s200);}
.data-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--s100);font-size:13px;}
.data-row:last-child{border:none;}
.data-row .label{color:var(--s500);}
.data-row .value{font-weight:700;}
.done{text-align:center;padding:40px 16px;}
.done .icon{font-size:64px;}
.done h2{font-size:20px;font-weight:900;margin-top:12px;}
.done p{font-size:13px;color:var(--s500);margin-top:6px;line-height:1.6;}
.code-box{background:linear-gradient(135deg,#FFF0F2,#FFF4F0);border:1.5px dashed var(--rose);border-radius:16px;padding:20px;text-align:center;margin:16px 0;}
.code-box .code{font-family:monospace;font-size:28px;font-weight:700;color:var(--rose);letter-spacing:6px;}
.code-box .hint{font-size:11px;color:var(--s400);margin-top:4px;}
.hint-text{font-size:10px;color:var(--s400);margin-top:-8px;margin-bottom:12px;}
.loading{display:none;text-align:center;padding:40px;font-size:14px;color:var(--s500);}
.loading.show{display:block;}
</style>
</head>
<body>

<!-- ===== Step 1: ãƒšãƒƒãƒˆæƒ…å ± ===== -->
<div id="step1">
  <div class="header">
    <h1>ğŸ“ ãƒšãƒƒãƒˆç™»éŒ²</h1>
    <p>ã‚¹ãƒ†ãƒƒãƒ— 1/3</p>
  </div>
  <div class="progress"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
  <div class="section">
    <label class="form-label">ğŸ¾ ãƒšãƒƒãƒˆã®ãŠåå‰</label>
    <input class="form-input" id="petNames" placeholder="ä¾‹ï¼šãƒãƒ§ã‚³ï¼ˆè¤‡æ•°ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰">
    <div class="hint-text">ğŸ’¡ è¤‡æ•°ã®å ´åˆï¼šãƒãƒ§ã‚³, ãƒ¢ã‚«, ãƒ©ãƒ†</div>

    <label class="form-label">ğŸ“‹ ç¨®é¡</label>
    <div class="choice-grid" id="speciesGrid">
      <div class="choice-btn" onclick="selectSpecies(this,'dog')">ğŸ• çŠ¬</div>
      <div class="choice-btn" onclick="selectSpecies(this,'cat')">ğŸˆ çŒ«</div>
      <div class="choice-btn" onclick="selectSpecies(this,'other')">ğŸ¾ ãã®ä»–</div>
    </div>

    <div id="breedGroup" style="display:none;">
      <label class="form-label">çŠ¬ç¨®ãƒ»çŒ«ç¨®</label>
      <select class="form-select" id="breeds"></select>
    </div>

    <label class="form-label">ğŸ”¢ ä½•åŒ¹é£¼ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ</label>
    <div class="choice-grid" id="countGrid">
      <div class="choice-btn selected" onclick="selectCount(this,1)">1åŒ¹</div>
      <div class="choice-btn" onclick="selectCount(this,2)">2åŒ¹</div>
      <div class="choice-btn" onclick="selectCount(this,3)">3åŒ¹</div>
      <div class="choice-btn" onclick="selectCount(this,4)">4åŒ¹+</div>
    </div>

    <button class="btn btn-primary" onclick="goStep2()">æ¬¡ã¸ â†’</button>
  </div>
</div>

<!-- ===== Step 2: åœ°åŸŸé¸æŠ ===== -->
<div id="step2" style="display:none;">
  <div class="header">
    <h1>ğŸ“ åœ°åŸŸè¨­å®š</h1>
    <p>ã‚¹ãƒ†ãƒƒãƒ— 2/3</p>
  </div>
  <div class="progress"><div class="dot active"></div><div class="dot active"></div><div class="dot"></div></div>
  <div class="section">
    <label class="form-label">ğŸ“ éƒ½é“åºœçœŒ</label>
    <select class="form-select" id="area" onchange="onAreaChange()">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option>åŒ—æµ·é“</option><option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option>
      <option>å¤§é˜ªåºœ</option><option>æ„›çŸ¥çœŒ</option><option>ç¦å²¡çœŒ</option>
      <option>ãã®ä»–</option>
    </select>

    <div id="detailGroup" style="display:none;">
      <label class="form-label">ğŸ  å¸‚åŒºç”ºæ‘</label>
      <select class="form-select" id="areaDetail"></select>
    </div>

    <button class="btn btn-primary" onclick="goStep3()">æ¬¡ã¸ â†’</button>
    <button class="btn btn-outline" onclick="show('step1');hide('step2')">â† æˆ»ã‚‹</button>
  </div>
</div>

<!-- ===== Step 3: ç¢ºèª ===== -->
<div id="step3" style="display:none;">
  <div class="header">
    <h1>âœ… ç¢ºèª</h1>
    <p>ã‚¹ãƒ†ãƒƒãƒ— 3/3</p>
  </div>
  <div class="progress"><div class="dot active"></div><div class="dot active"></div><div class="dot active"></div></div>
  <div class="section">
    <div class="card" id="confirmCard"></div>
    <button class="btn btn-primary" onclick="submitRegister()">âœ… ã“ã®å†…å®¹ã§ç™»éŒ²ã™ã‚‹</button>
    <button class="btn btn-outline" onclick="show('step1');hide('step3')">âœï¸ ä¿®æ­£ã™ã‚‹</button>
  </div>
</div>

<!-- ===== Loading ===== -->
<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">â³</div>
  <div>ç™»éŒ²ä¸­...</div>
</div>

<!-- ===== Step 4: å®Œäº† ===== -->
<div id="step4" style="display:none;">
  <div class="done">
    <div class="icon">ğŸ‰</div>
    <h2>ç™»éŒ²å®Œäº†ï¼</h2>
    <p id="doneMsg"></p>
  </div>
  <div class="section" style="padding-top:0;">
    <div class="code-box">
      <div style="font-size:11px;color:var(--rose);font-weight:700;">ã‚ãªãŸã®å®¶æ—ã‚³ãƒ¼ãƒ‰</div>
      <div class="code" id="familyCodeDisplay"></div>
      <div class="hint">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®¶æ—ã«ã‚·ã‚§ã‚¢ã—ã¦ãã ã•ã„</div>
    </div>
    <div class="info">ğŸ’¡ å®¶æ—ãŒã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨<br>æ¯æ—¥ã®å…ƒæ°—é€šçŸ¥ãŒå±Šãã¾ã™ï¼</div>
    <button class="btn btn-primary" style="margin-top:16px;" onclick="closeLiff()">ğŸ¾ ã•ã£ãããƒã‚§ãƒƒã‚¯ï¼</button>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
// ===== è¨­å®š =====
const GAS_URL = PAWBON_CONFIG.GAS_URL;

let state = { species: '', breeds: '', petCount: 1, lineId: '' };

// ===== LIFF åˆæœŸåŒ– =====
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.register });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    state.lineId = profile.userId;
  } catch (e) {
    console.error('LIFF init error:', e);
    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šLIFFå¤–ã§ã‚‚å‹•ä½œ
    state.lineId = 'debug_user_' + Date.now();
  }
}
initLiff();

// ===== UI =====
function show(id) { document.getElementById(id).style.display = 'block'; }
function hide(id) { document.getElementById(id).style.display = 'none'; }

function selectSpecies(el, type) {
  document.querySelectorAll('#speciesGrid .choice-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  state.species = type;
  
  const sel = document.getElementById('breeds');
  sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  const opts = {
    dog: ['æŸ´çŠ¬','ãƒˆã‚¤ãƒ—ãƒ¼ãƒ‰ãƒ«','ãƒãƒ¯ãƒ¯','ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ¬ãƒˆãƒªãƒãƒ¼','ãƒ•ãƒ¬ãƒ³ãƒãƒ–ãƒ«ãƒ‰ãƒƒã‚°','ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒ€ãƒƒã‚¯ã‚¹','ãƒãƒ¡ãƒ©ãƒ‹ã‚¢ãƒ³','ã‚³ãƒ¼ã‚®ãƒ¼','MIX','ãã®ä»–'],
    cat: ['ã‚¹ã‚³ãƒ†ã‚£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ãƒãƒ³ãƒã‚«ãƒ³','ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚·ãƒ§ãƒ¼ãƒˆãƒ˜ã‚¢','ãƒ©ã‚°ãƒ‰ãƒ¼ãƒ«','MIX','ãã®ä»–'],
    other: ['ã†ã•ã','ãƒãƒ ã‚¹ã‚¿ãƒ¼','ãƒ•ã‚§ãƒ¬ãƒƒãƒˆ','é³¥','ãã®ä»–']
  };
  (opts[type]||[]).forEach(o => sel.innerHTML += `<option>${o}</option>`);
  document.getElementById('breedGroup').style.display = 'block';
}

function selectCount(el, n) {
  document.querySelectorAll('#countGrid .choice-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  state.petCount = n;
}

const areas = {
  'æ±äº¬éƒ½':['ä¸–ç”°è°·åŒº','æ¸‹è°·åŒº','ç›®é»’åŒº','æ¸¯åŒº','æ–°å®¿åŒº','å“å·åŒº','æ‰ä¸¦åŒº','ç·´é¦¬åŒº','ãã®ä»–'],
  'ç¥å¥ˆå·çœŒ':['æ¨ªæµœå¸‚','å·å´å¸‚','è—¤æ²¢å¸‚','éŒå€‰å¸‚','ãã®ä»–'],
  'å¤§é˜ªåºœ':['å¤§é˜ªå¸‚','å ºå¸‚','è±Šä¸­å¸‚','ãã®ä»–'],
  'æ„›çŸ¥çœŒ':['åå¤å±‹å¸‚','è±Šç”°å¸‚','ãã®ä»–'],
  'ç¦å²¡çœŒ':['ç¦å²¡å¸‚','åŒ—ä¹å·å¸‚','ãã®ä»–'],
  'åŒ—æµ·é“':['æœ­å¹Œå¸‚','æ—­å·å¸‚','ãã®ä»–']
};

function onAreaChange() {
  const area = document.getElementById('area').value;
  const sel = document.getElementById('areaDetail');
  if (!area || !areas[area]) { document.getElementById('detailGroup').style.display='none'; return; }
  sel.innerHTML = '<option value="">é¸æŠ</option>';
  areas[area].forEach(a => sel.innerHTML += `<option>${a}</option>`);
  document.getElementById('detailGroup').style.display = 'block';
}

// ===== ã‚¹ãƒ†ãƒƒãƒ—é·ç§» =====
function goStep2() {
  const names = document.getElementById('petNames').value.trim();
  if (!names) { alert('ãƒšãƒƒãƒˆã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  hide('step1'); show('step2');
}

function goStep3() {
  const area = document.getElementById('area').value;
  if (!area) { alert('åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  
  // ç¢ºèªç”»é¢ç”Ÿæˆ
  const names = document.getElementById('petNames').value.trim();
  const breed = document.getElementById('breeds').value || 'æœªé¸æŠ';
  const detail = document.getElementById('areaDetail').value || '';
  
  document.getElementById('confirmCard').innerHTML = `
    <div class="data-row"><span class="label">ğŸ¾ ãƒšãƒƒãƒˆ</span><span class="value">${names}</span></div>
    <div class="data-row"><span class="label">ğŸ“‹ å“ç¨®</span><span class="value">${breed}</span></div>
    <div class="data-row"><span class="label">ğŸ”¢ é ­æ•°</span><span class="value">${state.petCount}åŒ¹</span></div>
    <div class="data-row"><span class="label">ğŸ“ åœ°åŸŸ</span><span class="value">${area} ${detail}</span></div>
  `;
  
  state.breeds = breed;
  hide('step2'); show('step3');
}

// ===== ç™»éŒ²é€ä¿¡ =====
async function submitRegister() {
  hide('step3');
  document.getElementById('loading').classList.add('show');
  
  const payload = {
    action: 'register',
    lineId: state.lineId,
    petNames: document.getElementById('petNames').value.trim(),
    breeds: state.breeds,
    petCount: state.petCount,
    area: document.getElementById('area').value,
    areaDetail: document.getElementById('areaDetail').value || ''
  };
  
  try {
    // 1. ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯èª­ã‚ãªã„å ´åˆãŒã‚ã‚‹ï¼‰
    await fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    }).catch(function(){});
    
    // 2. å°‘ã—å¾…ã£ã¦ã‹ã‚‰ GET ã§ç™»éŒ²ç¢ºèª
    await new Promise(function(r){ setTimeout(r, 2000); });
    
    var checkUrl = GAS_URL + '?action=getUserData&lineId=' + encodeURIComponent(state.lineId);
    var checkRes = await fetch(checkUrl);
    var checkData = await checkRes.json();
    
    document.getElementById('loading').classList.remove('show');
    
    if (checkData && checkData.registered && checkData.familyCode) {
      document.getElementById('familyCodeDisplay').textContent = checkData.familyCode;
      document.getElementById('doneMsg').textContent = payload.petNames + 'ã®æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ';
      show('step4');
    } else {
      alert('ç™»éŒ²ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      show('step3');
    }
  } catch (e) {
    document.getElementById('loading').classList.remove('show');
    alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    show('step3');
  }
}

function closeLiff() {
  if (liff.isInClient()) { liff.closeWindow(); }
  else { window.close(); }
}
</script>
</body>
</html>
