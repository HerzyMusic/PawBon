<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å®¶æ—ã¨ã—ã¦å‚åŠ </title>
<style>
:root{--rose:#E8475F;--rose-l:#FFF0F2;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--orange-l:#FFF4F0;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}
.steps{display:flex;gap:4px;padding:12px 16px 0;}
.steps .dot{flex:1;height:4px;border-radius:2px;background:var(--s200);transition:background .3s;}
.steps .dot.active{background:var(--teal);}
.section{padding:20px 16px;}
.form-label{font-size:12px;font-weight:700;color:var(--s500);margin-bottom:6px;display:block;}
.form-input{width:100%;padding:14px;border:1.5px solid var(--s200);border-radius:14px;font-size:16px;background:var(--card);font-family:'Courier New',monospace;text-align:center;letter-spacing:6px;transition:border-color .2s;}
.form-input:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px rgba(46,205,167,.12);}
.form-input.error{border-color:var(--rose);animation:shake .4s;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);}}
.name-input{width:100%;padding:12px 14px;border:1.5px solid var(--s200);border-radius:12px;font-size:14px;background:var(--card);font-family:inherit;margin-bottom:16px;}
.name-input:focus{outline:none;border-color:var(--teal);}
.found-card{text-align:center;border:1.5px solid var(--teal);background:var(--teal-l);border-radius:16px;padding:20px 16px;margin-bottom:16px;}
.found-card .emoji{font-size:40px;margin-bottom:8px;}
.found-card .name{font-size:17px;font-weight:900;}
.found-card .sub{font-size:12px;color:var(--s500);margin-top:4px;}
.relation-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}
.relation-btn{padding:14px 10px;border-radius:14px;border:1.5px solid var(--s200);background:var(--card);text-align:center;cursor:pointer;transition:all .15s;}
.relation-btn .emoji{font-size:28px;display:block;margin-bottom:4px;}
.relation-btn .label{font-size:12px;font-weight:700;color:var(--s500);}
.relation-btn.selected{border-color:var(--teal);background:var(--teal-l);box-shadow:0 0 0 3px rgba(46,205,167,.12);}
.relation-btn.selected .label{color:var(--teal-d);}
.relation-btn:active{transform:scale(.96);}
.btn{display:block;width:100%;padding:14px;border-radius:14px;font-size:15px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none;}
.btn-primary{background:linear-gradient(135deg,var(--teal),var(--teal-d));color:#fff;box-shadow:0 4px 16px rgba(46,205,167,.25);}
.btn-outline{background:var(--card);color:var(--s500);border:1.5px solid var(--s200);margin-top:8px;}
.btn-ghost{background:transparent;color:var(--s500);font-size:13px;margin-top:8px;}
.info{padding:12px;border-radius:12px;font-size:12px;line-height:1.6;text-align:center;margin-top:12px;}
.info.teal{background:var(--teal-l);color:var(--teal-d);border:1px solid rgba(46,205,167,.2);}
.info.amber{background:var(--amber-l);color:var(--orange);border:1px solid rgba(255,179,71,.25);}
.error-msg{font-size:12px;color:var(--rose);text-align:center;margin-top:8px;display:none;}
.error-msg.show{display:block;}
.done{text-align:center;padding:40px 16px 20px;}
.done .icon{font-size:64px;}
.done h2{font-size:22px;font-weight:900;margin-top:12px;color:var(--teal-d);}
.done p{font-size:13px;color:var(--s500);margin-top:8px;line-height:1.8;}
.done .pets{font-size:15px;font-weight:800;margin-top:4px;}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.loading{display:none;text-align:center;padding:60px 20px;}
.loading.show{display:block;}
.loading .spinner{width:40px;height:40px;border:3px solid var(--s200);border-top-color:var(--teal);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px;}
@keyframes spin{to{transform:rotate(360deg);}}
.hidden{display:none;}
.center{text-align:center;}
.mt16{margin-top:16px;}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}
</style>
</head>
<body>

<!-- â•â•â• STEP 1 â€” ã‚³ãƒ¼ãƒ‰å…¥åŠ› â•â•â• -->
<div id="step1">
  <div class="header">
    <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—ã¨ã—ã¦å‚åŠ </h1>
    <p>ã‚¹ãƒ†ãƒƒãƒ— 1/3 â€” ã‚³ãƒ¼ãƒ‰å…¥åŠ›</p>
  </div>
  <div class="steps"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
  <div class="section">
    <div class="center" style="margin-bottom:24px;">
      <div style="font-size:56px;">ğŸ”‘</div>
      <p style="font-size:13px;color:var(--s500);margin-top:8px;line-height:1.6;">
        å®¶æ—ã‹ã‚‰ã‚‚ã‚‰ã£ãŸ<br>4æ¡ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
      </p>
    </div>
    <div class="form-label">ğŸ”‘ å®¶æ—ã‚³ãƒ¼ãƒ‰</div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
      <span style="font-size:18px;font-weight:700;color:var(--s400);flex-shrink:0;">P-</span>
      <input class="form-input" id="codeInput" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="0000" autocomplete="off">
    </div>
    <div class="error-msg" id="codeError"></div>
    <button class="btn btn-primary mt16" id="verifyBtn" onclick="verifyCode()" disabled>ç¢ºèªã™ã‚‹</button>
    <div class="info amber mt16">ğŸ’¡ ã‚³ãƒ¼ãƒ‰ãŒåˆ†ã‹ã‚‰ãªã„å ´åˆã¯<br>ãƒšãƒƒãƒˆã®é£¼ã„ä¸»ã•ã‚“ã«èã„ã¦ãã ã•ã„</div>
  </div>
</div>

<!-- â•â•â• STEP 2 â€” ç¢ºèª + ç¶šæŸ„ â•â•â• -->
<div id="step2" class="hidden">
  <div class="header">
    <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—ã¨ã—ã¦å‚åŠ </h1>
    <p>ã‚¹ãƒ†ãƒƒãƒ— 2/3 â€” æƒ…å ±å…¥åŠ›</p>
  </div>
  <div class="steps"><div class="dot active"></div><div class="dot active"></div><div class="dot"></div></div>
  <div class="section">
    <div class="found-card">
      <div class="emoji" id="foundEmoji">ğŸ•</div>
      <div class="name" id="foundName">-</div>
      <div class="sub" id="foundSub">-</div>
    </div>

    <div class="form-label">ğŸ‘¤ ã‚ãªãŸã®ãŠåå‰</div>
    <input class="name-input" id="joinDisplayName" placeholder="ä¾‹ï¼šãŠã°ã‚ã¡ã‚ƒã‚“">

    <div class="form-label">ã‚ãªãŸã®ç¶šæŸ„ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="relation-grid" id="relationGrid">
      <div class="relation-btn" onclick="selectRelation(this,'ãƒ‘ãƒ‘')">
        <span class="emoji">ğŸ‘¨</span><span class="label">ãƒ‘ãƒ‘</span>
      </div>
      <div class="relation-btn" onclick="selectRelation(this,'ãƒãƒ')">
        <span class="emoji">ğŸ‘©</span><span class="label">ãƒãƒ</span>
      </div>
      <div class="relation-btn" onclick="selectRelation(this,'ãŠã˜ã„ã¡ã‚ƒã‚“')">
        <span class="emoji">ğŸ‘´</span><span class="label">ãŠã˜ã„ã¡ã‚ƒã‚“</span>
      </div>
      <div class="relation-btn" onclick="selectRelation(this,'ãŠã°ã‚ã¡ã‚ƒã‚“')">
        <span class="emoji">ğŸ‘µ</span><span class="label">ãŠã°ã‚ã¡ã‚ƒã‚“</span>
      </div>
      <div class="relation-btn" onclick="selectRelation(this,'å…„å¼Ÿãƒ»å§‰å¦¹')">
        <span class="emoji">ğŸ‘¦</span><span class="label">å…„å¼Ÿãƒ»å§‰å¦¹</span>
      </div>
      <div class="relation-btn" onclick="selectRelation(this,'å‹äºº')">
        <span class="emoji">ğŸ‘«</span><span class="label">å‹äºº</span>
      </div>
      <div class="relation-btn" onclick="selectRelation(this,'ãƒšãƒƒãƒˆã‚·ãƒƒã‚¿ãƒ¼')">
        <span class="emoji">ğŸ§‘â€âš•ï¸</span><span class="label">ãƒšãƒƒãƒˆã‚·ãƒƒã‚¿ãƒ¼</span>
      </div>
      <div class="relation-btn" onclick="selectRelation(this,'ãã®ä»–')">
        <span class="emoji">ğŸ“</span><span class="label">ãã®ä»–</span>
      </div>
    </div>

    <button class="btn btn-primary" id="joinBtn" onclick="submitJoin()" disabled>âœ… ã“ã®å†…å®¹ã§å‚åŠ ã™ã‚‹</button>
    <button class="btn btn-outline" onclick="goBack(1)">â† ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
  </div>
</div>

<!-- â•â•â• STEP 3 â€” å®Œäº† â•â•â• -->
<div id="step3" class="hidden">
  <div class="header">
    <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—ã¨ã—ã¦å‚åŠ </h1>
    <p>ã‚¹ãƒ†ãƒƒãƒ— 3/3 â€” å®Œäº†</p>
  </div>
  <div class="steps"><div class="dot active"></div><div class="dot active"></div><div class="dot active"></div></div>
  <div class="done">
    <div class="icon">ğŸ‰</div>
    <h2>ç™»éŒ²å®Œäº†ï¼</h2>
    <div class="pets" id="donePets">-</div>
    <p id="doneMsg">-</p>
  </div>
  <div class="section" style="padding-top:0;">
    <div class="card" style="text-align:center;background:var(--teal-l);border:1.5px solid var(--teal);">
      <div style="font-size:14px;font-weight:800;margin-bottom:6px;">ğŸ’Œ æ˜æ—¥ã‹ã‚‰å±Šãã‚‚ã®</div>
      <div style="font-size:13px;line-height:2;color:var(--s500);">
        âœ… æ¯æ—¥ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯çµæœ<br>
        âš ï¸ å¿ƒé…ãªæ™‚ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ<br>
        ğŸ”¥ é€£ç¶šæ—¥æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
      </div>
    </div>
    <div class="info teal">é£¼ã„ä¸»ã•ã‚“ãŒå…ƒæ°—ãƒã‚§ãƒƒã‚¯ã‚’ã™ã‚‹ã¨<br>ã‚ãªãŸã«LINEé€šçŸ¥ãŒå±Šãã¾ã™ ğŸ’Œ</div>
    <button class="btn btn-primary mt16" onclick="closeLiff()">ğŸ¾ LINEã«æˆ»ã‚‹</button>
  </div>
</div>

<!-- â•â•â• Loading â•â•â• -->
<div id="loading" class="loading">
  <div class="spinner"></div>
  <div id="loadingText" style="font-size:14px;color:var(--s500);">ç¢ºèªä¸­...</div>
</div>

<div class="footer">PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.3.3 Beta<br>Â© 2026 PawBon Inc.</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
var GAS_URL = PAWBON_CONFIG.GAS_URL;
var SUPA_URL = PAWBON_CONFIG.SUPABASE_URL;
var SUPA_KEY = PAWBON_CONFIG.SUPABASE_KEY;

var lineId = '';
var displayName = '';
var selectedRelation = '';
var foundFamily = null;

function supaGet(path) {
  return fetch(SUPA_URL + '/rest/v1/' + path, {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  }).then(function(r){ return r.json(); });
}

function supaInsert(table, data) {
  return fetch(SUPA_URL + '/rest/v1/' + table, {
    method: 'POST',
    headers: {
      'apikey': SUPA_KEY,
      'Authorization': 'Bearer ' + SUPA_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify(data)
  });
}

// â•â•â• LIFF â•â•â•
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.familyJoin });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
    displayName = profile.displayName || 'å®¶æ—';
  } catch (e) {
    lineId = 'debug_user_' + Date.now();
    displayName = 'ãƒ‡ãƒãƒƒã‚°ãƒ¦ãƒ¼ã‚¶ãƒ¼';
  }

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰è‡ªå‹•å…¥åŠ›
  var params = new URLSearchParams(window.location.search);
  var preCode = params.get('code');
  if (preCode && /^\d{4}$/.test(preCode)) {
    document.getElementById('codeInput').value = preCode;
    document.getElementById('verifyBtn').disabled = false;
    setTimeout(function(){ verifyCode(); }, 300);
  }
}
initLiff();

// â•â•â• UI â•â•â•
function show(id) { var el = document.getElementById(id); el.classList.remove('hidden'); el.style.display = ''; }
function hide(id) { var el = document.getElementById(id); el.classList.add('hidden'); el.style.display = 'none'; }
function goBack(step) {
  hide('step2'); hide('step3');
  show('step' + step);
  selectedRelation = '';
  document.querySelectorAll('#relationGrid .relation-btn').forEach(function(b){ b.classList.remove('selected'); });
  document.getElementById('joinBtn').disabled = true;
}

// â•â•â• ã‚³ãƒ¼ãƒ‰å…¥åŠ› â•â•â•
var codeInput = document.getElementById('codeInput');
codeInput.addEventListener('input', function() {
  this.value = this.value.replace(/[^\d]/g, '').slice(0, 4);
  document.getElementById('verifyBtn').disabled = this.value.length !== 4;
  document.getElementById('codeError').classList.remove('show');
  this.classList.remove('error');
});
codeInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && this.value.length === 4) verifyCode();
});

// â•â•â• STEP 1 â†’ ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆSupabaseç›´æ¥ï¼‰ â•â•â•
async function verifyCode() {
  var code = 'P-' + codeInput.value.trim();
  if (codeInput.value.length !== 4) return;

  hide('step1');
  document.getElementById('loadingText').textContent = 'ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªä¸­...';
  document.getElementById('loading').classList.add('show');

  try {
    // 1. Supabase ã§ã‚³ãƒ¼ãƒ‰æ¤œç´¢
    var families = await supaGet('pet_families?family_code=eq.' + encodeURIComponent(code) + '&limit=1');

    document.getElementById('loading').classList.remove('show');

    if (!families || families.length === 0) {
      show('step1');
      codeInput.classList.add('error');
      var errEl = document.getElementById('codeError');
      errEl.textContent = 'âŒ ã‚³ãƒ¼ãƒ‰ã€Œ' + code + 'ã€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
      errEl.classList.add('show');
      return;
    }

    var family = families[0];

    // 2. è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã‹ãƒã‚§ãƒƒã‚¯
    if (family.owner_line_id === lineId) {
      show('step1');
      codeInput.classList.add('error');
      var errEl2 = document.getElementById('codeError');
      errEl2.textContent = 'â„¹ï¸ ã“ã‚Œã¯ã‚ãªãŸè‡ªèº«ã®å®¶æ—ã‚³ãƒ¼ãƒ‰ã§ã™';
      errEl2.classList.add('show');
      return;
    }

    // 3. æ—¢ã«ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
    var existing = await supaGet(
      'family_members?family_code=eq.' + encodeURIComponent(code) +
      '&member_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1'
    );
    if (existing && existing.length > 0) {
      show('step1');
      codeInput.classList.add('error');
      var errEl3 = document.getElementById('codeError');
      errEl3.textContent = 'â„¹ï¸ æ—¢ã«ã“ã®å®¶æ—ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™';
      errEl3.classList.add('show');
      return;
    }

    // 4. æˆåŠŸ â†’ Step 2
    foundFamily = family;
    renderFoundFamily();
    document.getElementById('joinDisplayName').value = displayName;
    show('step2');

  } catch (e) {
    document.getElementById('loading').classList.remove('show');
    show('step1');
    codeInput.classList.add('error');
    var errEl4 = document.getElementById('codeError');
    errEl4.textContent = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message;
    errEl4.classList.add('show');
  }
}

function renderFoundFamily() {
  var names = foundFamily.pet_names;
  var count = foundFamily.pet_count || names.split(',').length;
  var area = (foundFamily.area || '') + ' ' + (foundFamily.area_detail || '');
  document.getElementById('foundEmoji').textContent = count > 2 ? 'ğŸ•ğŸˆğŸ¾' : count > 1 ? 'ğŸ•ğŸˆ' : 'ğŸ•';
  document.getElementById('foundName').textContent = 'ğŸ¾ ' + names;
  document.getElementById('foundSub').textContent = 'ğŸ“ ' + area.trim() + ' Â· ' + count + 'åŒ¹';
}

// â•â•â• STEP 2 â†’ ç¶šæŸ„é¸æŠ â•â•â•
function selectRelation(el, relation) {
  document.querySelectorAll('#relationGrid .relation-btn').forEach(function(b){ b.classList.remove('selected'); });
  el.classList.add('selected');
  selectedRelation = relation;
  document.getElementById('joinBtn').disabled = false;
}

// â•â•â• STEP 2 â†’ å‚åŠ ç¢ºå®š â•â•â•
async function submitJoin() {
  if (!selectedRelation || !foundFamily) return;
  var joinName = document.getElementById('joinDisplayName').value.trim();
  if (!joinName) { alert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  hide('step2');
  document.getElementById('loadingText').textContent = 'ç™»éŒ²ä¸­...';
  document.getElementById('loading').classList.add('show');

  try {
    // 1. Supabase ã«ç›´æ¥ INSERT
    var res = await supaInsert('family_members', {
      family_code: foundFamily.family_code,
      member_line_id: lineId,
      relation: selectedRelation,
      display_name: joinName
    });

    if (!res.ok) {
      var errText = await res.text();
      throw new Error(errText);
    }

    // 2. GAS ã«ã‚‚é€šçŸ¥ï¼ˆLINEé€šçŸ¥é€ä¿¡ç”¨ã€å¤±æ•—ã—ã¦ã‚‚å•é¡Œãªã—ï¼‰
    fetch(GAS_URL, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify({
        action: 'joinFamily',
        lineId: lineId,
        familyCode: foundFamily.family_code,
        relation: selectedRelation,
        displayName: joinName
      })
    }).catch(function(){});

    document.getElementById('loading').classList.remove('show');

    // 3. å®Œäº†ç”»é¢
    document.getElementById('donePets').textContent = 'ğŸ¾ ' + foundFamily.pet_names;
    document.getElementById('doneMsg').innerHTML =
      escapeHtml(selectedRelation) + 'ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸï¼<br>' +
      'æ˜æ—¥ã‹ã‚‰æ¯æ—¥ã€å…ƒæ°—ãƒ¬ãƒãƒ¼ãƒˆã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚';
    show('step3');

  } catch (e) {
    document.getElementById('loading').classList.remove('show');
    show('step2');
    alert('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

// â•â•â• é–‰ã˜ã‚‹ â•â•â•
function closeLiff() {
  if (typeof liff !== 'undefined' && liff.isInClient()) { liff.closeWindow(); }
  else { window.close(); }
}

// â•â•â• Util â•â•â•
function escapeHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
