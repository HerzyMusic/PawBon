<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å®¶æ—ç®¡ç†</title>
<style>
:root{--rose:#E8475F;--rose-l:#FFF0F2;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--orange-l:#FFF4F0;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:20px;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}
.section{padding:16px;}
.section-title{font-size:13px;font-weight:800;color:var(--s500);margin-bottom:10px;}
.code-box{background:linear-gradient(135deg,var(--rose-l),var(--orange-l));border:1.5px dashed var(--rose);border-radius:16px;padding:20px;text-align:center;margin-bottom:16px;}
.code-box .label{font-size:11px;color:var(--rose);font-weight:700;}
.code-box .code{font-family:monospace;font-size:28px;font-weight:700;color:var(--rose);letter-spacing:6px;margin:8px 0;}
.code-box .hint{font-size:11px;color:var(--s400);}
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.btn{display:block;width:100%;padding:12px;border-radius:14px;font-size:14px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-primary{background:linear-gradient(135deg,var(--rose),var(--orange));color:#fff;}
.btn-teal{background:linear-gradient(135deg,var(--teal),var(--teal-d));color:#fff;}
.btn-outline{background:var(--card);color:var(--s500);border:1.5px solid var(--s200);}
.btn-line{background:#06C755;color:#fff;font-size:15px;}
.btn:disabled{opacity:.45;cursor:not-allowed;}
.member-card{display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:14px;border:1px solid var(--s200);margin-bottom:8px;}
.member-av{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;background:var(--rose-l);}
.member-info{flex:1;}
.member-info .name{font-size:14px;font-weight:700;}
.member-info .detail{font-size:10px;color:var(--s400);}
.member-status{font-size:10px;padding:4px 8px;border-radius:20px;font-weight:700;background:var(--teal-l);color:var(--teal-d);}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.info{padding:12px;border-radius:12px;font-size:12px;text-align:center;margin-bottom:12px;}
.info.amber{background:var(--amber-l);color:var(--orange);border:1px solid var(--amber);}
.info.teal{background:var(--teal-l);color:var(--teal-d);border:1px solid var(--teal);}
.info.rose{background:var(--rose-l);color:var(--rose);border:1px solid rgba(232,71,95,.2);}
.record-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--s100);font-size:12px;}
.record-row:last-child{border:none;}
.record-row .g{color:var(--teal-d);font-weight:700;}
.record-row .w{color:#92400E;font-weight:700;}
.loading{text-align:center;padding:60px 20px;color:var(--s400);}
.empty{text-align:center;padding:40px 20px;color:var(--s400);}
.empty .icon{font-size:48px;margin-bottom:12px;}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}

/* â•â•â• åé¡ Quota â•â•â• */
.quota-bar{margin-bottom:16px;}
.quota-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.quota-header .label{font-size:12px;font-weight:700;color:var(--s500);}
.quota-header .count{font-size:12px;font-weight:800;}
.quota-track{height:8px;border-radius:4px;background:var(--s200);overflow:hidden;}
.quota-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--teal),var(--teal-d));transition:width .3s;}
.quota-fill.full{background:linear-gradient(90deg,var(--amber),var(--orange));}

/* â•â•â• æ è¿½åŠ ã‚«ãƒ¼ãƒ‰ â•â•â• */
.upgrade-card{background:var(--card);border-radius:16px;border:1.5px solid var(--s200);overflow:hidden;margin-bottom:12px;}
.upgrade-header{padding:14px 16px 10px;font-size:13px;font-weight:800;color:var(--ink);}
.upgrade-option{display:flex;align-items:center;gap:12px;padding:12px 16px;border-top:1px solid var(--s100);cursor:pointer;transition:background .15s;}
.upgrade-option:active{background:var(--s100);}
.upgrade-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.upgrade-icon.invite{background:var(--teal-l);}
.upgrade-icon.pay{background:var(--amber-l);}
.upgrade-body{flex:1;}
.upgrade-body .title{font-size:13px;font-weight:700;}
.upgrade-body .desc{font-size:10px;color:var(--s400);margin-top:2px;line-height:1.4;}
.upgrade-arrow{color:var(--s400);font-size:14px;}
.upgrade-badge{display:inline-block;font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;margin-left:4px;}
.badge-free{background:var(--teal-l);color:var(--teal-d);}
.badge-pro{background:var(--amber-l);color:var(--orange);}

/* â•â•â• æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ« â•â•â• */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal{background:var(--card);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:24px 16px 32px;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:40px;height:4px;border-radius:2px;background:var(--s200);margin:0 auto 16px;}
.modal h3{font-size:16px;font-weight:800;text-align:center;margin-bottom:16px;}
.modal .desc{font-size:12px;color:var(--s500);text-align:center;line-height:1.6;margin-bottom:20px;}
.modal .btn{margin-bottom:8px;}
.invite-steps{padding:12px;background:var(--s100);border-radius:12px;margin-bottom:16px;font-size:11px;line-height:2;color:var(--s500);}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—</h1>
  <p id="headerSub">èª­ã¿è¾¼ã¿ä¸­...</p>
</div>

<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦</div>
  <div>èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<!-- â•â•â• ã‚ªãƒ¼ãƒŠãƒ¼ãƒ“ãƒ¥ãƒ¼ â•â•â• -->
<div id="ownerView" style="display:none;">
  <!-- å®¶æ—ã‚³ãƒ¼ãƒ‰ + ã‚·ã‚§ã‚¢ -->
  <div class="section">
    <div class="code-box">
      <div class="label">ã‚ãªãŸã®å®¶æ—ã‚³ãƒ¼ãƒ‰</div>
      <div class="code" id="ownerCode">-</div>
      <div class="hint">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®¶æ—ã«ã‚·ã‚§ã‚¢ã—ã¦ãã ã•ã„</div>
    </div>
    <button class="btn btn-line" onclick="shareLine()" style="margin-bottom:8px;">ğŸ“¤ LINEã§å®¶æ—ã‚’æ‹›å¾…ã™ã‚‹</button>
    <div class="btn-row">
      <button class="btn btn-outline" onclick="copyCode()">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-outline" onclick="shareGeneral()">ğŸ“¤ ãã®ä»–ã§ã‚·ã‚§ã‚¢</button>
    </div>
  </div>

  <!-- åé¡ãƒãƒ¼ -->
  <div class="section" style="padding-top:0;">
    <div class="quota-bar">
      <div class="quota-header">
        <span class="label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼æ </span>
        <span class="count" id="quotaCount">0 / 2</span>
      </div>
      <div class="quota-track"><div class="quota-fill" id="quotaFill" style="width:0%"></div></div>
    </div>
    <div id="quotaInfo"></div>
  </div>

  <!-- ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ -->
  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ ç™»éŒ²æ¸ˆã¿å®¶æ—</div>
    <div id="memberList">
      <div class="empty"><div class="icon">ğŸ‘‹</div>ã¾ã å®¶æ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><br>å®¶æ—ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¦<br>æ‹›å¾…ã—ã¾ã—ã‚‡ã†ï¼</div>
    </div>
  </div>

  <!-- æ è¿½åŠ ã‚«ãƒ¼ãƒ‰ -->
  <div class="section" style="padding-top:0;" id="upgradeSection">
    <div class="upgrade-card">
      <div class="upgrade-header">ğŸ”“ å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼æ ã‚’å¢—ã‚„ã™</div>
      <div class="upgrade-option" onclick="showInviteModal()">
        <div class="upgrade-icon invite">ğŸ</div>
        <div class="upgrade-body">
          <div class="title">å‹ã ã¡ã‚’æ‹›å¾…ã™ã‚‹ <span class="upgrade-badge badge-free">ç„¡æ–™</span></div>
          <div class="desc">ãƒšãƒƒãƒˆé£¼ã„ä¸»ã®å‹ã ã¡ãŒPawBonã«ç™»éŒ²ã™ã‚‹ã¨<br>ã‚ãªãŸã®å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼æ ãŒ+1ã•ã‚Œã¾ã™</div>
        </div>
        <div class="upgrade-arrow">â€º</div>
      </div>
      <div class="upgrade-option" onclick="showPayModal()">
        <div class="upgrade-icon pay">ğŸ’</div>
        <div class="upgrade-body">
          <div class="title">è¿½åŠ æ ã‚’è³¼å…¥ <span class="upgrade-badge badge-pro">PRO</span></div>
          <div class="desc">æœˆé¡Â¥100/æ ã§ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã§ãã¾ã™</div>
        </div>
        <div class="upgrade-arrow">â€º</div>
      </div>
    </div>
  </div>

  <!-- ãƒã‚§ãƒƒã‚¯å±¥æ­´ -->
  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ“‹ æœ€è¿‘ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯</div>
    <div class="card" id="ownerHistory" style="padding:0 16px;">
      <div style="padding:16px 0;text-align:center;color:var(--s400);font-size:12px;">ã¾ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>
</div>

<!-- â•â•â• ãƒ¡ãƒ³ãƒãƒ¼ãƒ“ãƒ¥ãƒ¼ â•â•â• -->
<div id="memberView" style="display:none;">
  <div class="section">
    <div class="card" style="text-align:center;background:var(--teal-l);border:1.5px solid var(--teal);">
      <div style="font-size:28px;">ğŸ•</div>
      <div style="font-size:16px;font-weight:800;margin-top:6px;" id="memberPets">-</div>
      <div style="font-size:11px;color:var(--s400);margin-top:2px;" id="memberArea">-</div>
    </div>
    <div class="info teal">ğŸ’Œ ã‚ãªãŸã¯å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™</div>
  </div>
  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼</div>
    <div id="memberFamilyList"></div>
  </div>
  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ“‹ æœ€è¿‘ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯</div>
    <div class="card" id="memberHistory" style="padding:0 16px;">
      <div style="padding:16px 0;text-align:center;color:var(--s400);font-size:12px;">ã¾ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>
</div>

<!-- â•â•â• æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ« â•â•â• -->
<div class="modal-overlay" id="inviteModal" onclick="closeModal(event,'inviteModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>ğŸ å‹ã ã¡æ‹›å¾…ã§æ ã‚’å¢—ã‚„ã™</h3>
    <div class="desc">ãƒšãƒƒãƒˆé£¼ã„ä¸»ã®å‹ã ã¡ã«PawBonã‚’ç´¹ä»‹ã—ã¾ã—ã‚‡ã†ï¼<br>å‹ã ã¡ãŒæ–°è¦ç™»éŒ²ã™ã‚‹ã¨ã€ã‚ãªãŸã®å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼æ ãŒ<strong>+1</strong>ã•ã‚Œã¾ã™ã€‚</div>
    <div class="invite-steps">
      <strong>ğŸ“‹ æ‰‹é †</strong><br>
      â‘  ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚·ã‚§ã‚¢<br>
      â‘¡ å‹ã ã¡ãŒPawBonã‚’å‹ã ã¡è¿½åŠ <br>
      â‘¢ å‹ã ã¡ãŒãƒšãƒƒãƒˆç™»éŒ²ã‚’å®Œäº†<br>
      â‘£ ã‚ãªãŸã®å®¶æ—æ ãŒè‡ªå‹•ã§+1 ğŸ‰
    </div>
    <button class="btn btn-line" onclick="shareInviteLink()">ğŸ“¤ LINEã§æ‹›å¾…ã™ã‚‹</button>
    <button class="btn btn-outline" onclick="copyInviteLink()">ğŸ“‹ æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
    <button class="btn" style="background:transparent;color:var(--s400);font-size:13px;" onclick="hideModal('inviteModal')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- â•â•â• è³¼å…¥ãƒ¢ãƒ¼ãƒ€ãƒ« â•â•â• -->
<div class="modal-overlay" id="payModal" onclick="closeModal(event,'payModal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>ğŸ’ è¿½åŠ ãƒ¡ãƒ³ãƒãƒ¼æ ã®è³¼å…¥</h3>
    <div class="desc">æœˆé¡ãƒ—ãƒ©ãƒ³ã§å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼æ ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</div>
    <div class="card" style="text-align:center;border:1.5px solid var(--amber);background:var(--amber-l);">
      <div style="font-size:11px;color:var(--s500);margin-bottom:4px;">è¿½åŠ ãƒ¡ãƒ³ãƒãƒ¼æ </div>
      <div style="font-size:32px;font-weight:900;color:var(--orange);">Â¥100<span style="font-size:14px;font-weight:700;color:var(--s500);">/æœˆãƒ»æ </span></div>
      <div style="font-size:11px;color:var(--s400);margin-top:4px;">ã„ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½</div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="btn btn-outline pay-qty" onclick="selectQty(this,1)" style="flex:1;border-color:var(--amber);background:var(--amber-l);color:var(--orange);">+1æ <br><span style="font-size:10px;">Â¥100/æœˆ</span></button>
      <button class="btn btn-outline pay-qty" onclick="selectQty(this,2)" style="flex:1;">+2æ <br><span style="font-size:10px;">Â¥200/æœˆ</span></button>
      <button class="btn btn-outline pay-qty" onclick="selectQty(this,3)" style="flex:1;">+3æ <br><span style="font-size:10px;">Â¥300/æœˆ</span></button>
    </div>
    <button class="btn btn-primary" style="background:linear-gradient(135deg,var(--amber),var(--orange));" onclick="handlePurchase()">ğŸ’ è³¼å…¥æ‰‹ç¶šãã¸</button>
    <button class="btn" style="background:transparent;color:var(--s400);font-size:13px;margin-top:4px;" onclick="hideModal('payModal')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div class="footer">PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.3.6 Beta<br>Â© 2026 PawBon Inc.</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
var SUPA_URL = PAWBON_CONFIG.SUPABASE_URL;
var SUPA_KEY = PAWBON_CONFIG.SUPABASE_KEY;
var lineId = '';
var familyData = null;
var FREE_SLOTS = 2;
var bonusSlots = 0;
var paidSlots = 0;
var selectedPayQty = 1;

function supaGet(path) {
  return fetch(SUPA_URL + '/rest/v1/' + path, {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  }).then(function(r){ return r.json(); });
}

// â•â•â• LIFF â•â•â•
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.family });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) {
    try {
      var latest = await supaGet('pet_families?order=registered_at.desc&limit=1');
      if (Array.isArray(latest) && latest.length > 0) lineId = latest[0].owner_line_id;
    } catch (e2) {}
  }
  loadFamily();
}
initLiff();

// â•â•â• Load â•â•â•
async function loadFamily() {
  try {
    var families = await supaGet('pet_families?owner_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
    var role = 'owner';
    var family = null;

    if (Array.isArray(families) && families.length > 0) {
      family = families[0];
    } else {
      var members = await supaGet('family_members?member_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
      if (Array.isArray(members) && members.length > 0) {
        role = 'member';
        var fam = await supaGet('pet_families?family_code=eq.' + encodeURIComponent(members[0].family_code) + '&limit=1');
        if (Array.isArray(fam) && fam.length > 0) family = fam[0];
      }
    }

    if (!family) {
      document.getElementById('loading').innerHTML =
        '<div class="empty"><div class="icon">ğŸ“</div>ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><br>å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„</div>';
      return;
    }

    var rawMembers = await supaGet('family_members?family_code=eq.' + encodeURIComponent(family.family_code) + '&order=registered_at.asc');
    var allMembers = Array.isArray(rawMembers) ? rawMembers : [];

    var rawCheckins = await supaGet('checkins?family_code=eq.' + encodeURIComponent(family.family_code) + '&order=checkin_date.desc&limit=7');
    var recentCheckins = Array.isArray(rawCheckins) ? rawCheckins : [];

    // ãƒœãƒ¼ãƒŠã‚¹æ : invited_by ã‚’æŒã¤ pet_families ã®æ•°ï¼ˆã“ã®äººãŒæ‹›å¾…ã—ãŸæ–°è¦ã‚ªãƒ¼ãƒŠãƒ¼æ•°ï¼‰
    bonusSlots = family.bonus_slots || 0;
    paidSlots = family.paid_slots || 0;

    familyData = {
      role: role,
      familyCode: family.family_code,
      petNames: family.pet_names,
      area: family.area + ' ' + (family.area_detail || ''),
      members: allMembers,
      recentCheckins: recentCheckins
    };

    document.getElementById('loading').style.display = 'none';

    if (role === 'owner') {
      renderOwnerView();
    } else {
      renderMemberView();
    }
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<div class="empty"><div class="icon">âŒ</div>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼<br><br>' + e.message + '</div>';
  }
}

// â•â•â• Render â•â•â•
var relationIcons = {
  'ã‚ªãƒ¼ãƒŠãƒ¼':'ğŸ ','ãƒ‘ãƒ‘':'ğŸ‘¨','ãƒãƒ':'ğŸ‘©',
  'ãŠã˜ã„ã¡ã‚ƒã‚“':'ğŸ‘´','ãŠã°ã‚ã¡ã‚ƒã‚“':'ğŸ‘µ','å®¶æ—':'ğŸ‘¥',
  'å…„å¼Ÿãƒ»å§‰å¦¹':'ğŸ‘¦','å‹äºº':'ğŸ‘«','ãƒšãƒƒãƒˆã‚·ãƒƒã‚¿ãƒ¼':'ğŸ§‘â€âš•ï¸'
};

function renderMemberCards(members, containerId) {
  var container = document.getElementById(containerId);
  if (!members || members.length === 0) {
    container.innerHTML = '<div class="empty"><div class="icon">ğŸ‘‹</div>ã¾ã å®¶æ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><br>ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ‹›å¾…ã—ã¾ã—ã‚‡ã†ï¼</div>';
    return;
  }
  container.innerHTML = members.map(function(m) {
    var icon = relationIcons[m.relation] || 'ğŸ‘¤';
    var date = m.registered_at ? m.registered_at.substring(0, 10) : '';
    return '<div class="member-card">' +
      '<div class="member-av">' + icon + '</div>' +
      '<div class="member-info">' +
        '<div class="name">' + escapeHtml(m.display_name) + '</div>' +
        '<div class="detail">' + escapeHtml(m.relation || '') + ' Â· ' + date + ' ç™»éŒ²</div>' +
      '</div>' +
      '<div class="member-status">é€šçŸ¥ON</div>' +
    '</div>';
  }).join('');
}

function renderCheckins(checkins, containerId) {
  var container = document.getElementById(containerId);
  if (!checkins || checkins.length === 0) {
    container.innerHTML = '<div style="padding:16px 0;text-align:center;color:var(--s400);font-size:12px;">ã¾ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  var weekdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  container.innerHTML = checkins.map(function(r) {
    var d = new Date(r.checkin_date);
    var label = (d.getMonth()+1) + '/' + d.getDate() + 'ï¼ˆ' + weekdays[d.getDay()] + 'ï¼‰';
    if (r.status === 'genki') {
      return '<div class="record-row"><span>' + label + '</span><span class="g">âœ… å…¨å“¡å…ƒæ°—</span></div>';
    } else {
      var worry = r.worried_pets || 'å¿ƒé…';
      return '<div class="record-row"><span>' + label + '</span><span class="w">âš ï¸ ' + escapeHtml(worry) + '</span></div>';
    }
  }).join('');
}

function renderOwnerView() {
  document.getElementById('ownerView').style.display = 'block';
  document.getElementById('headerSub').textContent = familyData.petNames + ' Â· ã‚ªãƒ¼ãƒŠãƒ¼';
  document.getElementById('ownerCode').textContent = familyData.familyCode;

  // ã‚ªãƒ¼ãƒŠãƒ¼ä»¥å¤–
  var otherMembers = familyData.members.filter(function(m) { return m.member_line_id !== lineId; });

  // åé¡è¨ˆç®—
  var totalSlots = FREE_SLOTS + bonusSlots + paidSlots;
  var usedSlots = otherMembers.length;
  var percent = totalSlots > 0 ? Math.min(100, Math.round((usedSlots / totalSlots) * 100)) : 0;

  document.getElementById('quotaCount').textContent = usedSlots + ' / ' + totalSlots;
  var fill = document.getElementById('quotaFill');
  fill.style.width = percent + '%';
  if (usedSlots >= totalSlots) fill.classList.add('full');

  // åé¡æƒ…å ±
  var quotaInfo = document.getElementById('quotaInfo');
  var parts = [];
  parts.push('ç„¡æ–™æ  ' + FREE_SLOTS);
  if (bonusSlots > 0) parts.push('æ‹›å¾…ãƒœãƒ¼ãƒŠã‚¹ +' + bonusSlots);
  if (paidSlots > 0) parts.push('è³¼å…¥æ  +' + paidSlots);
  var remaining = totalSlots - usedSlots;

  if (remaining > 0) {
    quotaInfo.innerHTML = '<div class="info teal">ğŸ« ' + parts.join(' / ') + '<br>æ®‹ã‚Š <strong>' + remaining + 'æ </strong> æ‹›å¾…å¯èƒ½ã§ã™</div>';
  } else {
    quotaInfo.innerHTML = '<div class="info rose">ğŸ”’ ' + parts.join(' / ') + '<br>ãƒ¡ãƒ³ãƒãƒ¼æ ãŒã„ã£ã±ã„ã§ã™ã€‚ä¸‹ã‹ã‚‰æ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
  }

  // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ï¼šæ ãŒã„ã£ã±ã„ã®å ´åˆã¯ç„¡åŠ¹åŒ–
  // ï¼ˆã‚³ãƒ¼ãƒ‰ã¯è¦‹ã›ã‚‹ãŒã€å‚åŠ å´ã§åˆ¶é™ã™ã‚‹ã®ã§é€ä¿¡è‡ªä½“ã¯è¨±å¯ï¼‰

  renderMemberCards(otherMembers, 'memberList');
  renderCheckins(familyData.recentCheckins, 'ownerHistory');

  // æ ã«ä½™è£•ãŒã‚ã‚‹å ´åˆã¯ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›®ç«‹ãŸãªãã™ã‚‹
  if (remaining > 2) {
    document.getElementById('upgradeSection').style.display = 'none';
  }
}

function renderMemberView() {
  document.getElementById('memberView').style.display = 'block';
  document.getElementById('headerSub').textContent = 'å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼';
  document.getElementById('memberPets').textContent = 'ğŸ¾ ' + familyData.petNames;
  document.getElementById('memberArea').textContent = 'ğŸ“ ' + familyData.area;
  renderMemberCards(familyData.members, 'memberFamilyList');
  renderCheckins(familyData.recentCheckins, 'memberHistory');
}

// â•â•â• LINE ã‚·ã‚§ã‚¢ï¼ˆFlex Message + å‚åŠ ãƒªãƒ³ã‚¯ä»˜ãï¼‰ â•â•â•
function getJoinUrl(code) {
  // LIFF URL with family code parameter
  var liffId = PAWBON_CONFIG.LIFF_ID.familyJoin;
  var codeNum = code.replace('P-','');
  return 'https://liff.line.me/' + liffId + '?code=' + codeNum;
}

function getAddFriendAndJoinUrl(code) {
  // LINEå‹ã ã¡è¿½åŠ  â†’ è¿½åŠ å¾Œã«LIFFã§å®¶æ—å‚åŠ 
  var codeNum = code.replace('P-','');
  var liffId = PAWBON_CONFIG.LIFF_ID.familyJoin;
  // LINE URL scheme: å‹ã ã¡è¿½åŠ å¾Œã«LIFFãƒšãƒ¼ã‚¸ã¸é·ç§»
  return PAWBON_CONFIG.LINE_ADD_FRIEND_URL + '#~/' + 'family-join?code=' + codeNum;
}

function shareLine() {
  var joinUrl = getJoinUrl(familyData.familyCode);
  var addFriendUrl = PAWBON_CONFIG.LINE_ADD_FRIEND_URL;
  var codeNum = familyData.familyCode.replace('P-','');

  if (typeof liff !== 'undefined' && liff.isApiAvailable('shareTargetPicker')) {
    liff.shareTargetPicker([
      {
        type: 'flex',
        altText: 'ğŸ¾ ' + familyData.petNames + 'ã®å®¶æ—ã«ãªã‚Šã¾ã›ã‚“ã‹ï¼Ÿ å®¶æ—ã‚³ãƒ¼ãƒ‰: ' + familyData.familyCode,
        contents: {
          type: 'bubble',
          size: 'mega',
          header: {
            type: 'box', layout: 'horizontal',
            backgroundColor: '#FFF0F2',
            paddingAll: '16px',
            contents: [
              { type: 'text', text: 'ğŸ¾', size: 'xl', flex: 0 },
              { type: 'text', text: 'PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯', size: 'sm', weight: 'bold', color: '#E8475F', gravity: 'center', margin: 'sm' }
            ]
          },
          hero: {
            type: 'box', layout: 'vertical',
            backgroundColor: '#FFFFFF',
            paddingAll: '20px',
            contents: [
              { type: 'text', text: familyData.petNames + 'ã®', size: 'md', weight: 'bold', align: 'center' },
              { type: 'text', text: 'å®¶æ—ã«ãªã‚Šã¾ã›ã‚“ã‹ï¼Ÿ', size: 'lg', weight: 'bold', align: 'center', margin: 'xs' }
            ]
          },
          body: {
            type: 'box', layout: 'vertical',
            paddingAll: '20px',
            contents: [
              { type: 'box', layout: 'vertical',
                backgroundColor: '#FFF0F2',
                cornerRadius: '12px',
                paddingAll: '16px',
                contents: [
                  { type: 'text', text: 'å®¶æ—ã‚³ãƒ¼ãƒ‰', size: 'xs', color: '#999999', align: 'center' },
                  { type: 'text', text: familyData.familyCode, size: 'xxl', weight: 'bold', color: '#E8475F', align: 'center', margin: 'sm' }
                ]
              },
              { type: 'separator', margin: 'lg' },
              { type: 'box', layout: 'vertical', margin: 'lg', spacing: 'sm', contents: [
                { type: 'text', text: 'ğŸ“± å‚åŠ æ–¹æ³•', size: 'sm', weight: 'bold', color: '#1A1A2E' },
                { type: 'text', text: 'â¶ ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰PawBonã‚’å‹ã ã¡è¿½åŠ ', size: 'xs', color: '#64748B', margin: 'sm' },
                { type: 'text', text: 'â· ã€Œå®¶æ—ã¨ã—ã¦å‚åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—', size: 'xs', color: '#64748B' },
                { type: 'text', text: 'â¸ å®¶æ—ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦å®Œäº†ï¼', size: 'xs', color: '#64748B' }
              ]},
              { type: 'text', text: 'æ¯æ—¥ãƒšãƒƒãƒˆã®å…ƒæ°—çŠ¶æ³ãŒå±Šãã¾ã™ ğŸ’Œ', size: 'xxs', color: '#AAAAAA', align: 'center', wrap: true, margin: 'lg' }
            ]
          },
          footer: {
            type: 'box', layout: 'vertical',
            paddingAll: '16px',
            spacing: 'sm',
            contents: [
              {
                type: 'button',
                action: {
                  type: 'uri',
                  label: 'ğŸ¾ PawBonã‚’å‹ã ã¡è¿½åŠ ã™ã‚‹',
                  uri: addFriendUrl
                },
                style: 'primary',
                color: '#06C755',
                height: 'md'
              },
              {
                type: 'button',
                action: {
                  type: 'uri',
                  label: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—ã¨ã—ã¦å‚åŠ ã™ã‚‹',
                  uri: joinUrl
                },
                style: 'primary',
                color: '#E8475F',
                height: 'md'
              }
            ]
          }
        }
      }
    ]).then(function(res) {
      if (res) alert('âœ… æ‹›å¾…ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');
    }).catch(function() {
      copyCode();
    });
  } else {
    copyCode();
  }
}

// â•â•â• ã‚³ãƒ”ãƒ¼ï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰ â•â•â•
function copyCode() {
  var code = familyData.familyCode;
  var addUrl = PAWBON_CONFIG.LINE_ADD_FRIEND_URL;
  var joinUrl = getJoinUrl(code);
  var text = 'ğŸ¾ PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯\n\n' +
    familyData.petNames + 'ã®å®¶æ—ã«ãªã‚Šã¾ã›ã‚“ã‹ï¼Ÿ\n\n' +
    'å®¶æ—ã‚³ãƒ¼ãƒ‰: ' + code + '\n\n' +
    'ğŸ“± å‚åŠ æ–¹æ³•:\n' +
    'â‘  ã¾ãšPawBonã‚’å‹ã ã¡è¿½åŠ  ğŸ‘‡\n' + addUrl + '\n\n' +
    'â‘¡ ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å®¶æ—å‚åŠ  ğŸ‘‡\n' + joinUrl + '\n\n' +
    'æ¯æ—¥ãƒšãƒƒãƒˆã®å…ƒæ°—çŠ¶æ³ãŒå±Šãã¾ã™ ğŸ’Œ';
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(function() {
      alert('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nLINEã®ãƒˆãƒ¼ã‚¯ã«è²¼ã‚Šä»˜ã‘ã¦é€ä¿¡ã—ã¦ãã ã•ã„ ğŸ¾');
    });
  } else {
    var ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nLINEã®ãƒˆãƒ¼ã‚¯ã«è²¼ã‚Šä»˜ã‘ã¦é€ä¿¡ã—ã¦ãã ã•ã„ ğŸ¾');
  }
}

// â•â•â• ãã®ä»–ã‚·ã‚§ã‚¢ï¼ˆWeb Share APIï¼‰ â•â•â•
function shareGeneral() {
  var code = familyData.familyCode;
  var addUrl = PAWBON_CONFIG.LINE_ADD_FRIEND_URL;
  var joinUrl = getJoinUrl(code);
  var text = 'ğŸ¾ PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯\n' +
    familyData.petNames + 'ã®å®¶æ—ã«ãªã‚Šã¾ã›ã‚“ã‹ï¼Ÿ\n\n' +
    'å®¶æ—ã‚³ãƒ¼ãƒ‰: ' + code + '\n\n' +
    'â‘  å‹ã ã¡è¿½åŠ : ' + addUrl + '\n' +
    'â‘¡ å®¶æ—å‚åŠ : ' + joinUrl;
  if (navigator.share) {
    navigator.share({ title: 'PawBon å®¶æ—æ‹›å¾…', text: text }).catch(function(){});
  } else {
    copyCode();
  }
}

// â•â•â• æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ« â•â•â•
function showInviteModal() { document.getElementById('inviteModal').classList.add('show'); }
function showPayModal() { document.getElementById('payModal').classList.add('show'); }
function hideModal(id) { document.getElementById(id).classList.remove('show'); }
function closeModal(e, id) { if (e.target === e.currentTarget) hideModal(id); }

function shareInviteLink() {
  var addFriendUrl = PAWBON_CONFIG.LINE_ADD_FRIEND_URL;
  if (typeof liff !== 'undefined' && liff.isApiAvailable('shareTargetPicker')) {
    liff.shareTargetPicker([
      {
        type: 'flex',
        altText: 'ğŸ¾ PawBonã§ãƒšãƒƒãƒˆã®å…ƒæ°—ã‚’æ¯æ—¥ãƒã‚§ãƒƒã‚¯ï¼å‹ã ã¡è¿½åŠ ã—ã¦å§‹ã‚ã‚ˆã†',
        contents: {
          type: 'bubble', size: 'mega',
          header: {
            type: 'box', layout: 'horizontal', backgroundColor: '#EDFCF7', paddingAll: '16px',
            contents: [
              { type: 'text', text: 'ğŸ', size: 'xl', flex: 0 },
              { type: 'text', text: 'PawBon ã®ã”æ‹›å¾…', size: 'sm', weight: 'bold', color: '#1FA882', gravity: 'center', margin: 'sm' }
            ]
          },
          body: {
            type: 'box', layout: 'vertical', paddingAll: '20px',
            contents: [
              { type: 'text', text: 'ãƒšãƒƒãƒˆã®å…ƒæ°—ã‚’\næ¯æ—¥ãƒã‚§ãƒƒã‚¯ï¼', size: 'lg', weight: 'bold', wrap: true, align: 'center' },
              { type: 'text', text: 'å®¶æ—ã‚„å‹ã ã¡ã«ãƒšãƒƒãƒˆã®å…ƒæ°—çŠ¶æ³ã‚’\nç°¡å˜ã«ã‚·ã‚§ã‚¢ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™', size: 'xs', color: '#999999', wrap: true, margin: 'md', align: 'center' },
              { type: 'separator', margin: 'lg' },
              { type: 'box', layout: 'vertical', margin: 'lg', spacing: 'sm', contents: [
                { type: 'text', text: 'âœ… å®Œå…¨ç„¡æ–™ã§å§‹ã‚ã‚‰ã‚Œã¾ã™', size: 'xs', color: '#64748B' },
                { type: 'text', text: 'âœ… æ¯æ—¥30ç§’ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯', size: 'xs', color: '#64748B' },
                { type: 'text', text: 'âœ… å®¶æ—ã«è‡ªå‹•ã§é€šçŸ¥', size: 'xs', color: '#64748B' },
                { type: 'text', text: 'âœ… é›¢ã‚Œã¦æš®ã‚‰ã™å®¶æ—ã‚‚å®‰å¿ƒ', size: 'xs', color: '#64748B' }
              ]}
            ]
          },
          footer: {
            type: 'box', layout: 'vertical', paddingAll: '16px',
            contents: [
              {
                type: 'button',
                action: { type: 'uri', label: 'ğŸ¾ PawBonã‚’å‹ã ã¡è¿½åŠ ã™ã‚‹', uri: addFriendUrl },
                style: 'primary', color: '#06C755', height: 'md'
              },
              { type: 'text', text: 'å‹ã ã¡è¿½åŠ å¾Œã€ãƒšãƒƒãƒˆç™»éŒ²ã‚’ã™ã‚‹ã ã‘ï¼', size: 'xxs', color: '#AAAAAA', align: 'center', margin: 'sm' }
            ]
          }
        }
      }
    ]).then(function(res) {
      if (res) {
        hideModal('inviteModal');
        alert('âœ… æ‹›å¾…ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n\nå‹ã ã¡ãŒPawBonã«ç™»éŒ²ã™ã‚‹ã¨ã€ã‚ãªãŸã®å®¶æ—æ ãŒ+1ã•ã‚Œã¾ã™ ğŸ‰');
      }
    }).catch(function(){});
  } else {
    copyInviteLink();
  }
}

function copyInviteLink() {
  var addUrl = PAWBON_CONFIG.LINE_ADD_FRIEND_URL;
  var text = 'ğŸ¾ PawBonã§ãƒšãƒƒãƒˆã®å…ƒæ°—ã‚’æ¯æ—¥ãƒã‚§ãƒƒã‚¯ï¼\n\n' +
    'å®¶æ—ã‚„å‹ã ã¡ã«ãƒšãƒƒãƒˆã®å…ƒæ°—çŠ¶æ³ã‚’ç°¡å˜ã‚·ã‚§ã‚¢ã€‚\n' +
    'ç§ã®ç´¹ä»‹ã§ç™»éŒ²ã™ã‚‹ã¨ã€ãŠäº’ã„å¬‰ã—ã„ç‰¹å…¸ãŒã‚ã‚Šã¾ã™ï¼\n\n' +
    'ğŸ‘‰ ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å‹ã ã¡è¿½åŠ ã—ã¦å§‹ã‚ã‚ˆã†ï¼\n' + addUrl;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(function() {
      alert('âœ… æ‹›å¾…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nLINEã®ãƒˆãƒ¼ã‚¯ã«è²¼ã‚Šä»˜ã‘ã¦é€ä¿¡ã—ã¦ãã ã•ã„');
    });
  } else {
    var ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('âœ… æ‹›å¾…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  }
}

// â•â•â• è³¼å…¥ â•â•â•
function selectQty(el, qty) {
  selectedPayQty = qty;
  document.querySelectorAll('.pay-qty').forEach(function(b) {
    b.style.borderColor = '';
    b.style.background = '';
    b.style.color = '';
  });
  el.style.borderColor = 'var(--amber)';
  el.style.background = 'var(--amber-l)';
  el.style.color = 'var(--orange)';
}

function handlePurchase() {
  var monthly = selectedPayQty * 100;
  alert('ğŸ’ è³¼å…¥æ©Ÿèƒ½ã¯è¿‘æ—¥å…¬é–‹äºˆå®šã§ã™ï¼\n\n' + selectedPayQty + 'æ  Ã— Â¥100 = æœˆé¡Â¥' + monthly + '\n\nãƒªãƒªãƒ¼ã‚¹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ ğŸ¾');
  hideModal('payModal');
}

// â•â•â• Util â•â•â•
function escapeHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
