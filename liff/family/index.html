<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PawBon â€” å®¶æ—ç®¡ç†</title>
<style>
:root{--rose:#E8475F;--rose-l:#FFF0F2;--teal:#2ECDA7;--teal-d:#1FA882;--teal-l:#EDFCF7;--amber:#FFB347;--amber-l:#FFF8EC;--orange:#FF7B54;--orange-l:#FFF4F0;--ink:#1A1A2E;--s500:#64748B;--s400:#94A3B8;--s200:#E2E8F0;--s100:#F1F5F9;--bg:#F8F6F3;--card:#FFF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Helvetica Neue','Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:20px;}
.header{background:var(--card);padding:16px;border-bottom:1px solid var(--s200);text-align:center;}
.header h1{font-size:18px;font-weight:800;}
.header p{font-size:12px;color:var(--s400);margin-top:2px;}
.section{padding:16px;}
.section-title{font-size:13px;font-weight:800;color:var(--s500);margin-bottom:10px;}
.code-box{background:linear-gradient(135deg,var(--rose-l),var(--orange-l));border:1.5px dashed var(--rose);border-radius:16px;padding:20px;text-align:center;margin-bottom:16px;}
.code-box .label{font-size:11px;color:var(--rose);font-weight:700;}
.code-box .code{font-family:monospace;font-size:28px;font-weight:700;color:var(--rose);letter-spacing:6px;margin:8px 0;}
.code-box .hint{font-size:11px;color:var(--s400);}
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.btn{display:block;width:100%;padding:12px;border-radius:14px;font-size:14px;font-weight:800;text-align:center;cursor:pointer;border:none;font-family:inherit;transition:all .15s;}
.btn:active{transform:scale(.97);}
.btn-primary{background:linear-gradient(135deg,var(--rose),var(--orange));color:#fff;}
.btn-outline{background:var(--card);color:var(--s500);border:1.5px solid var(--s200);}
.member-card{display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:14px;border:1px solid var(--s200);margin-bottom:8px;}
.member-av{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;background:var(--rose-l);}
.member-info{flex:1;}
.member-info .name{font-size:14px;font-weight:700;}
.member-info .detail{font-size:10px;color:var(--s400);}
.member-status{font-size:10px;padding:4px 8px;border-radius:20px;font-weight:700;background:var(--teal-l);color:var(--teal-d);}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.info{padding:12px;border-radius:12px;font-size:12px;text-align:center;margin-bottom:12px;}
.info.amber{background:var(--amber-l);color:var(--orange);border:1px solid var(--amber);}
.info.teal{background:var(--teal-l);color:var(--teal-d);border:1px solid var(--teal);}
.record-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--s100);font-size:12px;}
.record-row:last-child{border:none;}
.record-row .g{color:var(--teal-d);font-weight:700;}
.record-row .w{color:#92400E;font-weight:700;}
.loading{text-align:center;padding:60px 20px;color:var(--s400);}
.empty{text-align:center;padding:40px 20px;color:var(--s400);}
.empty .icon{font-size:48px;margin-bottom:12px;}
.footer{text-align:center;padding:24px;font-size:10px;color:var(--s400);}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—</h1>
  <p id="headerSub">èª­ã¿è¾¼ã¿ä¸­...</p>
</div>

<div id="loading" class="loading">
  <div style="font-size:40px;margin-bottom:12px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦</div>
  <div>èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<!-- ===== ã‚ªãƒ¼ãƒŠãƒ¼ãƒ“ãƒ¥ãƒ¼ ===== -->
<div id="ownerView" style="display:none;">
  <div class="section">
    <div class="code-box">
      <div class="label">ã‚ãªãŸã®å®¶æ—ã‚³ãƒ¼ãƒ‰</div>
      <div class="code" id="ownerCode">-</div>
      <div class="hint">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®¶æ—ã«ã‚·ã‚§ã‚¢ã—ã¦ãã ã•ã„</div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="shareLine()">ğŸ“¤ LINEã§ã‚·ã‚§ã‚¢</button>
      <button class="btn btn-outline" onclick="copyCode()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ ç™»éŒ²æ¸ˆã¿å®¶æ—</div>
    <div id="memberList">
      <div class="empty"><div class="icon">ğŸ‘‹</div>ã¾ã å®¶æ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><br>å®¶æ—ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¦<br>æ‹›å¾…ã—ã¾ã—ã‚‡ã†ï¼</div>
    </div>
  </div>

  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ“‹ æœ€è¿‘ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯</div>
    <div class="card" id="ownerHistory" style="padding:0 16px;">
      <div style="padding:16px 0;text-align:center;color:var(--s400);font-size:12px;">ã¾ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>

  <div class="section" style="padding-top:0;">
    <div class="info amber">ğŸ’¡ å®¶æ—ãŒã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨<br>æ¯æ—¥ã®å…ƒæ°—é€šçŸ¥ãŒå±Šãã¾ã™ï¼</div>
  </div>
</div>

<!-- ===== ãƒ¡ãƒ³ãƒãƒ¼ãƒ“ãƒ¥ãƒ¼ ===== -->
<div id="memberView" style="display:none;">
  <div class="section">
    <div class="card" style="text-align:center;background:var(--teal-l);border:1.5px solid var(--teal);">
      <div style="font-size:28px;">ğŸ•</div>
      <div style="font-size:16px;font-weight:800;margin-top:6px;" id="memberPets">-</div>
      <div style="font-size:11px;color:var(--s400);margin-top:2px;" id="memberArea">-</div>
    </div>
    <div class="info teal">ğŸ’Œ ã‚ãªãŸã¯å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™</div>
  </div>

  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼</div>
    <div id="memberFamilyList"></div>
  </div>

  <div class="section" style="padding-top:0;">
    <div class="section-title">ğŸ“‹ æœ€è¿‘ã®å…ƒæ°—ãƒã‚§ãƒƒã‚¯</div>
    <div class="card" id="memberHistory" style="padding:0 16px;">
      <div style="padding:16px 0;text-align:center;color:var(--s400);font-size:12px;">ã¾ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>
</div>

<div class="footer">PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯ v0.3.2 Beta<br>Â© 2026 PawBon Inc.</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="../config.js"></script>
<script>
var SUPA_URL = PAWBON_CONFIG.SUPABASE_URL;
var SUPA_KEY = PAWBON_CONFIG.SUPABASE_KEY;
var lineId = '';
var familyData = null;

function supaGet(path) {
  return fetch(SUPA_URL + '/rest/v1/' + path, {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  }).then(function(r){ return r.json(); });
}

// â•â•â• LIFF â•â•â•
async function initLiff() {
  try {
    await liff.init({ liffId: PAWBON_CONFIG.LIFF_ID.family });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    var profile = await liff.getProfile();
    lineId = profile.userId;
  } catch (e) {
    try {
      var latest = await supaGet('pet_families?order=registered_at.desc&limit=1');
      if (latest && latest.length > 0) lineId = latest[0].owner_line_id;
    } catch (e2) {}
  }
  loadFamily();
}
initLiff();

// â•â•â• Load â•â•â•
async function loadFamily() {
  try {
    // 1. ã‚ªãƒ¼ãƒŠãƒ¼ã¨ã—ã¦æ¤œç´¢
    var families = await supaGet('pet_families?owner_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
    var role = 'owner';
    var family = null;

    if (families && families.length > 0) {
      family = families[0];
    } else {
      // 2. ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦æ¤œç´¢
      var members = await supaGet('family_members?member_line_id=eq.' + encodeURIComponent(lineId) + '&limit=1');
      if (members && members.length > 0) {
        role = 'member';
        var fam = await supaGet('pet_families?family_code=eq.' + encodeURIComponent(members[0].family_code) + '&limit=1');
        if (fam && fam.length > 0) family = fam[0];
      }
    }

    if (!family) {
      document.getElementById('loading').innerHTML =
        '<div class="empty"><div class="icon">ğŸ“</div>ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><br>å…ˆã«ãƒšãƒƒãƒˆç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„</div>';
      return;
    }

    // 3. å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼å–å¾—
    var allMembers = await supaGet('family_members?family_code=eq.' + encodeURIComponent(family.family_code) + '&order=registered_at.asc');

    // 4. æœ€è¿‘ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å–å¾—
    var recentCheckins = await supaGet('checkins?family_code=eq.' + encodeURIComponent(family.family_code) + '&order=checkin_date.desc&limit=7');

    familyData = {
      role: role,
      familyCode: family.family_code,
      petNames: family.pet_names,
      area: family.area + ' ' + (family.area_detail || ''),
      members: allMembers || [],
      recentCheckins: recentCheckins || []
    };

    document.getElementById('loading').style.display = 'none';

    if (role === 'owner') {
      renderOwnerView();
    } else {
      renderMemberView();
    }
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<div class="empty"><div class="icon">âŒ</div>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼<br><br>' + e.message + '</div>';
  }
}

// â•â•â• Render â•â•â•
var relationIcons = {
  'ã‚ªãƒ¼ãƒŠãƒ¼':'ğŸ ','ãƒ‘ãƒ‘':'ğŸ‘¨','ãƒãƒ':'ğŸ‘©',
  'ãŠã˜ã„ã¡ã‚ƒã‚“':'ğŸ‘´','ãŠã°ã‚ã¡ã‚ƒã‚“':'ğŸ‘µ','å®¶æ—':'ğŸ‘¥'
};

function renderMemberCards(members, containerId) {
  var container = document.getElementById(containerId);
  if (!members || members.length === 0) {
    container.innerHTML = '<div class="empty"><div class="icon">ğŸ‘‹</div>ã¾ã å®¶æ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><br>å®¶æ—ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¦<br>æ‹›å¾…ã—ã¾ã—ã‚‡ã†ï¼</div>';
    return;
  }
  container.innerHTML = members.map(function(m) {
    var icon = relationIcons[m.relation] || 'ğŸ‘¤';
    var date = m.registered_at ? m.registered_at.substring(0, 10) : '';
    return '<div class="member-card">' +
      '<div class="member-av">' + icon + '</div>' +
      '<div class="member-info">' +
        '<div class="name">' + escapeHtml(m.display_name) + '</div>' +
        '<div class="detail">' + escapeHtml(m.relation || '') + ' Â· ' + date + ' ç™»éŒ²</div>' +
      '</div>' +
      '<div class="member-status">é€šçŸ¥ON</div>' +
    '</div>';
  }).join('');
}

function renderCheckins(checkins, containerId) {
  var container = document.getElementById(containerId);
  if (!checkins || checkins.length === 0) {
    container.innerHTML = '<div style="padding:16px 0;text-align:center;color:var(--s400);font-size:12px;">ã¾ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  var weekdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  container.innerHTML = checkins.map(function(r) {
    var d = new Date(r.checkin_date);
    var label = (d.getMonth()+1) + '/' + d.getDate() + 'ï¼ˆ' + weekdays[d.getDay()] + 'ï¼‰';
    if (r.status === 'genki') {
      return '<div class="record-row"><span>' + label + '</span><span class="g">âœ… å…¨å“¡å…ƒæ°—</span></div>';
    } else {
      var worry = r.worried_pets || 'å¿ƒé…';
      return '<div class="record-row"><span>' + label + '</span><span class="w">âš ï¸ ' + escapeHtml(worry) + '</span></div>';
    }
  }).join('');
}

function renderOwnerView() {
  document.getElementById('ownerView').style.display = 'block';
  document.getElementById('headerSub').textContent = familyData.petNames + ' Â· ã‚ªãƒ¼ãƒŠãƒ¼';
  document.getElementById('ownerCode').textContent = familyData.familyCode;

  // ã‚ªãƒ¼ãƒŠãƒ¼ä»¥å¤–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¡¨ç¤º
  var otherMembers = familyData.members.filter(function(m) { return m.member_line_id !== lineId; });
  renderMemberCards(otherMembers, 'memberList');
  renderCheckins(familyData.recentCheckins, 'ownerHistory');
}

function renderMemberView() {
  document.getElementById('memberView').style.display = 'block';
  document.getElementById('headerSub').textContent = 'å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼';
  document.getElementById('memberPets').textContent = 'ğŸ¾ ' + familyData.petNames;
  document.getElementById('memberArea').textContent = 'ğŸ“ ' + familyData.area;

  renderMemberCards(familyData.members, 'memberFamilyList');
  renderCheckins(familyData.recentCheckins, 'memberHistory');
}

// â•â•â• Actions â•â•â•
function copyCode() {
  var code = familyData.familyCode;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(code);
    alert('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + code);
  } else {
    var input = document.createElement('input');
    input.value = code;
    document.body.appendChild(input);
    input.select();
    document.execCommand('copy');
    document.body.removeChild(input);
    alert('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + code);
  }
}

function shareLine() {
  if (typeof liff !== 'undefined' && liff.isApiAvailable('shareTargetPicker')) {
    liff.shareTargetPicker([{
      type: 'text',
      text: 'ğŸ¾ PawBon å…ƒæ°—ãƒã‚§ãƒƒã‚¯\n\n' +
            familyData.petNames + 'ã®å®¶æ—ã«ãªã‚Šã¾ã›ã‚“ã‹ï¼Ÿ\n\n' +
            'å®¶æ—ã‚³ãƒ¼ãƒ‰: ' + familyData.familyCode + '\n\n' +
            'PawBonã‚’å‹ã ã¡è¿½åŠ ã—ã¦\nã“ã®ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ï¼'
    }]);
  } else {
    copyCode();
  }
}

// â•â•â• Util â•â•â•
function escapeHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
